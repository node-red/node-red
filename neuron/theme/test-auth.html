<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuronGPT Auth Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1D1D1D;
            color: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #2D2D2D;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .test-button {
            background: #3182ce;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #2c5aa0;
        }
        .test-result {
            background: #1a1a1a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #3182ce;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .test-result.success {
            border-left-color: #68d391;
        }
        .test-result.error {
            border-left-color: #fc8181;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.success { background: rgba(104, 211, 145, 0.2); color: #68d391; }
        .status.error { background: rgba(252, 129, 129, 0.2); color: #fc8181; }
        .status.info { background: rgba(49, 130, 206, 0.2); color: #3182ce; }
    </style>
</head>
<body>
    <h1>🧪 NeuronGPT Authentication Test</h1>
    
    <div class="test-section">
        <h3>1. Configuration Test</h3>
        <button class="test-button" onclick="testConfig()">Test Configuration</button>
        <div id="config-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Server Connectivity Test</h3>
        <button class="test-button" onclick="testServerHealth()">Test Server Health</button>
        <div id="health-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Authentication Flow Test</h3>
        <button class="test-button" onclick="testAuthFlow()">Test Auth Flow</button>
        <div id="auth-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Token Management Test</h3>
        <button class="test-button" onclick="testTokenStorage()">Test Token Storage</button>
        <button class="test-button" onclick="clearTokens()">Clear Tokens</button>
        <div id="token-result" class="test-result"></div>
    </div>

    <div class="test-section">
        <h3>5. API Call Test</h3>
        <button class="test-button" onclick="testAPICall()">Test API Call</button>
        <div id="api-result" class="test-result"></div>
    </div>

    <div id="overall-status" class="status info">Ready to test</div>

    <script>
        // Configuration
        const CONFIG = {
            serverUrl: 'https://neuron-gpt-cp9am.ondigitalocean.app',
            healthEndpoint: '/health',
            authEndpoint: '/api/forward/auth',
            apiEndpoint: '/api/chat'
        };

        // Test 1: Configuration
        async function testConfig() {
            const result = document.getElementById('config-result');
            result.className = 'test-result';
            result.textContent = 'Testing configuration...';

            try {
                result.textContent = `Configuration loaded:
Server URL: ${CONFIG.serverUrl}
Health Endpoint: ${CONFIG.healthEndpoint}
Auth Endpoint: ${CONFIG.authEndpoint}
API Endpoint: ${CONFIG.apiEndpoint}`;
                result.className = 'test-result success';
                updateStatus('Configuration loaded successfully', 'success');
            } catch (error) {
                result.textContent = `Configuration error: ${error.message}`;
                result.className = 'test-result error';
                updateStatus('Configuration failed', 'error');
            }
        }

        // Test 2: Server Health
        async function testServerHealth() {
            const result = document.getElementById('health-result');
            result.className = 'test-result';
            result.textContent = 'Testing server health...';

            try {
                const response = await fetch(`${CONFIG.serverUrl}${CONFIG.healthEndpoint}`);
                const data = await response.text();
                
                if (response.ok) {
                    result.textContent = `Server Health Check: SUCCESS
Status: ${response.status}
Response: ${data}`;
                    result.className = 'test-result success';
                    updateStatus('Server is healthy', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${data}`);
                }
            } catch (error) {
                result.textContent = `Server Health Check: FAILED
Error: ${error.message}`;
                result.className = 'test-result error';
                updateStatus('Server health check failed', 'error');
            }
        }

        // Test 3: Authentication Flow
        async function testAuthFlow() {
            const result = document.getElementById('auth-result');
            result.className = 'test-result';
            result.textContent = 'Testing authentication flow...';

            try {
                // Test the forward auth endpoint
                const authUrl = `${CONFIG.serverUrl}${CONFIG.authEndpoint}?redirect_uri=${encodeURIComponent(window.location.origin)}`;
                result.textContent = `Auth Flow Test:
Forward Auth URL: ${authUrl}

Click the button below to test the full flow:`;
                result.className = 'test-result info';
                
                // Add test button
                const testButton = document.createElement('button');
                testButton.className = 'test-button';
                testButton.textContent = 'Test Full Auth Flow';
                testButton.onclick = () => {
                    const popup = window.open(authUrl, 'auth-test', 'width=500,height=600');
                    if (popup) {
                        result.textContent += '\n\nPopup opened successfully. Complete authentication in the popup window.';
                    } else {
                        result.textContent += '\n\nFailed to open popup. Check popup blocker.';
                        result.className = 'test-result error';
                    }
                };
                result.appendChild(testButton);
                
                updateStatus('Auth flow test ready', 'info');
            } catch (error) {
                result.textContent = `Auth Flow Test: FAILED
Error: ${error.message}`;
                result.className = 'test-result error';
                updateStatus('Auth flow test failed', 'error');
            }
        }

        // Test 4: Token Storage
        function testTokenStorage() {
            const result = document.getElementById('token-result');
            const token = localStorage.getItem('neuron-auth-token');
            const userInfo = localStorage.getItem('neuron-user-info');
            const expiry = localStorage.getItem('neuron-token-expiry');

            if (token && userInfo && expiry) {
                const expiryDate = new Date(parseInt(expiry));
                const isExpired = Date.now() > parseInt(expiry);
                
                result.textContent = `Token Storage: FOUND
Token: ${token.substring(0, 20)}...
User: ${userInfo}
Expires: ${expiryDate.toLocaleString()}
Status: ${isExpired ? 'EXPIRED' : 'VALID'}`;
                result.className = isExpired ? 'test-result error' : 'test-result success';
                updateStatus(`Token found - ${isExpired ? 'expired' : 'valid'}`, isExpired ? 'error' : 'success');
            } else {
                result.textContent = `Token Storage: NOT FOUND
Token: ${token ? 'Present' : 'Missing'}
User Info: ${userInfo ? 'Present' : 'Missing'}
Expiry: ${expiry ? 'Present' : 'Missing'}`;
                result.className = 'test-result error';
                updateStatus('No tokens found', 'error');
            }
        }

        // Clear tokens
        function clearTokens() {
            localStorage.removeItem('neuron-auth-token');
            localStorage.removeItem('neuron-user-info');
            localStorage.removeItem('neuron-token-expiry');
            
            const result = document.getElementById('token-result');
            result.textContent = 'Tokens cleared successfully';
            result.className = 'test-result success';
            updateStatus('Tokens cleared', 'success');
        }

        // Test 5: API Call
        async function testAPICall() {
            const result = document.getElementById('api-result');
            result.className = 'test-result';
            result.textContent = 'Testing API call...';

            const token = localStorage.getItem('neuron-auth-token');
            if (!token) {
                result.textContent = 'API Call Test: FAILED
No authentication token found. Please authenticate first.';
                result.className = 'test-result error';
                updateStatus('API call failed - no token', 'error');
                return;
            }

            try {
                const response = await fetch(`${CONFIG.serverUrl}${CONFIG.apiEndpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        message: 'Test message from auth test page',
                        context: 'Authentication test'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    result.textContent = `API Call Test: SUCCESS
Status: ${response.status}
Response: ${JSON.stringify(data, null, 2)}`;
                    result.className = 'test-result success';
                    updateStatus('API call successful', 'success');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                result.textContent = `API Call Test: FAILED
Error: ${error.message}`;
                result.className = 'test-result error';
                updateStatus('API call failed', 'error');
            }
        }

        // Update overall status
        function updateStatus(message, type) {
            const status = document.getElementById('overall-status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Listen for authentication messages from popup
        window.addEventListener('message', function(event) {
            if (event.origin !== CONFIG.serverUrl) return;
            
            if (event.data.type === 'AUTH_SUCCESS') {
                const result = document.getElementById('auth-result');
                result.textContent += '\n\n✅ Authentication successful! Token received and stored.';
                result.className = 'test-result success';
                updateStatus('Authentication successful!', 'success');
                
                // Auto-test token storage
                setTimeout(testTokenStorage, 1000);
            } else if (event.data.type === 'AUTH_ERROR') {
                const result = document.getElementById('auth-result');
                result.textContent += `\n\n❌ Authentication failed: ${event.data.error}`;
                result.className = 'test-result error';
                updateStatus('Authentication failed', 'error');
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Test page loaded. Click tests to begin.', 'info');
        });
    </script>
</body>
</html>
