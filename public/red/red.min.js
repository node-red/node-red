/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED={};RED.events=function(){function a(a,b){d[a]=d[a]||[],d[a].push(b)}function b(a,b){var c=d[a];if(c)for(var e=0;e<c.length;e++)if(c[e]===b)return void c.splice(e,1)}function c(a,b){if(d[a])for(var c=0;c<d[a].length;c++)try{d[a][c](b)}catch(b){console.log("RED.events.emit error: ["+a+"] "+b.toString()),console.log(b)}}var d={};return{on:a,off:b,emit:c}}(),RED.i18n=function(){return{init:function(a){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],fallbackNS:["node-red","editor"],useCookie:!1},function(){a()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(a,b){i18n.loadNamespace(a,b)},loadNodeCatalogs:function(a){var b=i18n.functions.toLanguages(i18n.detectLanguage()),c=b.length;b.forEach(function(b){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+b,success:function(d){var e=Object.keys(d);e.forEach(function(a){i18n.addResourceBundle(b,a,d[a])}),c--,0===c&&a()}})})}}}(),RED.settings=function(){function a(a,b){if(!RED.settings.editorTheme)return b;var c=a.split("."),d=RED.settings.editorTheme;try{for(var e=0;e<c.length;e++)d=d[c[e]];return void 0===d?b:d}catch(a){return b}}var b={},c=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},d=function(a,b){c()&&localStorage.setItem(a,JSON.stringify(b))},e=function(a){if(c())return JSON.parse(localStorage.getItem(a))},f=function(a){c()&&localStorage.removeItem(a)},g=function(a){for(var c in b)b.hasOwnProperty(c)&&RED.settings.hasOwnProperty(c)&&delete RED.settings[c];for(c in a)a.hasOwnProperty(c)&&(RED.settings[c]=a[c]);b=a},h=function(a){var b=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(b){var c=b[1];RED.settings.set("auth-tokens",{access_token:c}),window.location.search=""}$.ajaxSetup({beforeSend:function(a,b){if(!/^\s*(https?:|\/|\.)/.test(b.url)){var c=RED.settings.get("auth-tokens");c&&a.setRequestHeader("Authorization","Bearer "+c.access_token),a.setRequestHeader("Node-RED-API-Version","v2")}}}),i(a)},i=function(a){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(b){g(b),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-BLUE: "+b.version),a()},error:function(b,c,d){401===b.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){i(a)})):console.log("Unexpected error:",b.status,c)}})};return{init:h,load:i,set:d,get:e,remove:f,theme:a}}(),RED.user=function(){function a(a,b){"function"==typeof a&&(b=a,a={});var d=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');d.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!a.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(e){var f=0;if("credentials"==e.type){for(;f<e.prompts.length;f++){var g=e.prompts[f],h=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+g.id+'">'+g.label+":</label><br/>").appendTo(h);var i=$('<input style="width: 100%" id="node-dialog-login-'+g.id+'" type="'+g.type+'" tabIndex="'+(f+1)+'"/>').appendTo(h);f<e.prompts.length-1&&i.keypress(function(){var a=h;return function(b){13==b.keyCode&&(a.next("div").find("input").focus(),b.preventDefault())}}()),h.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(a.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(f+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(f+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(d){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var f={client_id:"node-red-editor",grant_type:"password",scope:""},g=0;g<e.prompts.length;g++){var h=e.prompts[g];f[h.id]=$("#node-dialog-login-"+h.id).val()}$.ajax({url:"auth/token",type:"POST",data:f}).done(function(d,e,f){RED.settings.set("auth-tokens",d),$("#node-dialog-login").dialog("destroy").remove(),a.updateMenu&&c(),b()}).fail(function(a,b,c){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),d.preventDefault()})}else if("strategy"==e.type)for(f=0;f<e.prompts.length;f++){var g=e.prompts[f],h=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields"),j=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(h).click(function(){document.location=g.url});if(g.image)$("<img>",{src:g.image}).appendTo(j);else if(g.label){var k=$("<span></span>").text(g.label);g.icon&&($("<i></i>",{class:"fa fa-2x "+g.icon,style:"vertical-align: middle"}).appendTo(j),k.css({verticalAlign:"middle",marginLeft:"8px"})),k.appendTo(j)}j.button()}a.cancelable&&$("#node-dialog-login-cancel").button().click(function(a){$("#node-dialog-login").dialog("destroy").remove()});var l=e.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){d.dialog("open")}).attr("src",l)}})}function b(){$.ajax({url:"auth/revoke",type:"POST",data:{token:RED.settings.get("auth-tokens").access_token},success:function(a){RED.settings.remove("auth-tokens"),a&&a.redirect?document.location.href=a.redirect:document.location.reload(!0)}})}function c(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),c()})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}function d(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var a=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(a.find("a")):$('<i class="fa fa-user"></i>').appendTo(a.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),c()}}return{init:d,login:a,logout:b}}(),RED.comms=function(){function a(){return h}function b(a){var b;return(b=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?b[1]:null}function c(a){if("nodeEvent"==a.method){a.params[2].format&&!a.params[2].format.match(/string/g)&&(a.params[2].msg=JSON.stringify(a.params[2].msg));for(var b in j)if(j.hasOwnProperty(b)){var c=new RegExp("^"+b.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$");if(c.test(a.params[1])){var d=j[b];if(d)for(var e=0;e<d.length;e++)d[e](a.params[1],a.params[2])}}}}function d(){var a="https:"==window.location.protocol,d="",e=a?"443":"80",f=window.location.host.indexOf("]");if(f>-1)part2=window.location.host.substring(f),part2.length>2&&":"==part2.charAt(1)&&(e=part2.substring(2)),d=window.location.host.substring(0,f+1);else{var g=window.location.host.split(":");d=g[0],g.length>1&&(e=g[1])}var j=b("PHPSESSID");h=new HomegearWS(d,e,"hgflows",a,j),h.ready(function(){i&&(i.close(),i=null)}),h.error(function(a){i&&i.close(),i=RED.notify(RED._("notification.error",{message:RED._("notification.errors.lostConnection")}),"error",!0)}),h.event(c),h.connect()}function e(a,b){null==j[a]&&(j[a]=[]),j[a].push(b)}function f(a,b){if(j[a]){for(var c=0;c<j[a].length;c++)if(j[a][c]===b){j[a].splice(c,1);break}0===j[a].length&&delete j[a]}}function g(){h.invoke("getNodeEvents",function(a){for(var b in a.result)if(a.result.hasOwnProperty(b)){var c=a.result[b];for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];e.format&&!e.format.match(/string/g)&&(e.msg=JSON.stringify(e.msg));for(var f in j)if(j.hasOwnProperty(f)){var g=new RegExp("^"+f.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$");if(g.test(d)){var h=j[f];if(h)for(var i=0;i<h.length;i++)h[i](d,e)}}}}})}var h=null,i=null,j={};return{homegear:a,connect:d,subscribe:e,unsubscribe:f,getEvents:g}}(),RED.text={},RED.text.bidi=function(){function a(a){for(var d=a.length,e=0;e<d;e++){if(b(a.charCodeAt(e)))return!0;if(c(a.charCodeAt(e)))return!1}return!1}function b(a){return a>=1488&&a<=1535||a>=1536&&a<=1631||a>=1642&&a<=1775||a>=1786&&a<=2047||a>=64285&&a<=65023||a>=65136&&a<=65276}function c(a){return a>64&&a<91||a>96&&a<123}function d(b){return"auto"==j?a(b)?"rtl":"ltr":j}function e(){$(this).attr("dir",d($(this).val()))}function f(a){a.on("keyup",e).on("paste",e).on("cut",e),e.call(a)}function g(a){if(a){var b=d(a);if("ltr"==b)return k+a+m;if("rtl"==b)return l+a+m}return a}function h(){$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",d($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",d($(this).text()))})}function i(a){j=a,RED.nodes.eachNode(function(a){a.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),h()}var j="",k="‪",l="‫",m="‬";return{setTextDirection:i,enforceTextDirectionWithUCC:g,resolveBaseTextDir:d,prepareInput:f}}(),RED.text.format=function(){function a(a){switch(a){case"breadcrumb":return j;case"comma":return k;case"email":return l;case"filepath":return m;case"formula":return n;case"sql":return o;case"underscore":return p;case"url":return q;case"word":return r;case"xpath":return s;default:return t}}function b(a){var b=window.navigator.userAgent;if(b.indexOf("MSIE")>=0||b.indexOf("Trident")>=0||b.indexOf("Edge")>=0)return!1;var c=document.createElement(a.tagName);c.contentEditable=!0;var d="oninput"in c;return d||(c.setAttribute("oninput","return;"),d="function"==typeof c.oninput),c=null,d}function c(a,c,e,f,g){if(!a||1!=a.nodeType)return!1;u||(u=document.createEvent("Event"),u.initEvent("TF",!0,!0)),a.setAttribute("data-tf-type",c);var i="undefined"===e?"{}":JSON.stringify(Array.isArray(e)?e[0]:e);a.setAttribute("data-tf-args",i);var j="ltr";if("undefined"===f&&(a.dir?j=a.dir:a.style&&a.style.direction&&(j=a.style.direction),f="rtl"===j.toLowerCase()),a.setAttribute("data-tf-dir",f),a.setAttribute("data-tf-locale",h.getLocaleDetails(g).lang),b(a)){a.oninput;a.oninput=function(a){d(a.target)}}else a.onkeyup=function(b){d(b.target),a.dispatchEvent(u)},a.onmouseup=function(b){d(b.target),a.dispatchEvent(u)};return d(a),!0}function d(b){var c=b.textContent||"",d=document.getSelection();if(0===c.length||!d||d.rangeCount<=0)return void b.dispatchEvent(u);var e,f,g=d.getRangeAt(0),h=g.cloneRange();e=g.startContainer,f=g.startOffset;var i=0;3===e.nodeType&&(i+=f),h.setStart(b,0),h.setEndBefore(e);var j=document.createElement("div");j.appendChild(h.cloneContents()),i+=j.textContent.length,b.innerHTML=a(b.getAttribute("data-tf-type")).format(c,JSON.parse(b.getAttribute("data-tf-args")),"true"===b.getAttribute("data-tf-dir"),!0,b.getAttribute("data-tf-locale"));var k=b,l=b,m=0,n=!1;for(d.removeAllRanges(),g.setStart(b,0),g.setEnd(b,0);l;){if(3===l.nodeType){if(m+l.nodeValue.length>=i){g.setStart(l,i-m);break}m+=l.nodeValue.length,l=l.nextSibling}else{if(l.hasChildNodes()){k=l,l=k.firstChild;continue}l=l.nextSibling}for(;!l;){if(k===b){n=!0;break}l=k.nextSibling,k=k.parentNode}if(n)break}d.addRange(g),b.dispatchEvent(u)}var e=function(){var a=function(a){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var b="";for(b in a)a.hasOwnProperty(b)&&(this[b]=a[b])};return a}(),f=function(){function a(a){if(!a)return!1;"undefined"==typeof a.start&&(a.start=""),"undefined"==typeof a.end&&(a.end=""),"undefined"!=typeof a.startAfter?(a.start=a.startAfter,a.after=!0):a.after=!1,"undefined"!=typeof a.endBefore?(a.end=a.endBefore,a.before=!0):a.before=!1;var b=parseInt(a.startPos,10);isNaN(b)?a.usePos=!1:a.usePos=!0;var c=parseInt(a.length,10);return isNaN(c)?a.useLength=!1:a.useLength=!0,a.loops="undefined"==typeof a.loops||!!a.loops,!0}function b(a,b){var c={};for(var d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);var e=a.content,f=c.usePos&&c.startPos<e.length;f&&(c.start="",c.loops=!1),c.bStart=f?c.startPos:c.start.length>0?e.indexOf(c.start):0;var g=c.useLength&&c.length>0&&c.bStart+c.length<e.length;return g&&(c.end=""),c.bEnd=g?c.bStart+c.length:c.end.length>0?e.indexOf(c.end,c.bStart+c.start.length)+1:e.length,c.after||(c.start=""),c.before||(c.end=""),c}return{handleSubcontents:function(a,b,c,d,f){if(!c.content||"string"!=typeof c.content||0===c.content.length)return a;var g=!0;"undefined"!=typeof c.loops&&(g=!!c.loops);for(var h=0;!0&&!(h>=a.length);h++)if(!(a[h].isParsed||a.keep||a[h].isSeparator)){var i=a[h].content,j=i.indexOf(c.content);if(!(j<0)){var k,l=0;if(c.continued){do l++,k=i.indexOf(c.content,j+l*c.content.length);while(0===k)}else l=1;if(k=j+l*c.content.length,a.splice(h,1),j>0&&(a.splice(h,0,new e({content:i.substring(0,j),localGui:b.dir,keep:!0})),h++),a.splice(h,0,new e({content:i.substring(j,k),textDirection:c.subDir,localGui:b.dir})),k<i.length&&a.splice(h+1,0,new e({content:i.substring(k,i.length),localGui:b.dir,keep:!0})),!g)break}}},handleBounds:function(c,d,f,g,h){for(var i=0;i<f.length;i++)if(a(f[i]))for(var j=0;!0&&!(j>=c.length);j++)if(!(c[j].isParsed||c[j].inBounds||c.keep||c[j].isSeparator)){var k=b(c[j],f[i]),l=k.bStart,m=k.bEnd;if(!(l<0||m<0)){var n=c[j].content;if(c.splice(j,1),l>0&&(c.splice(j,0,new e({content:n.substring(0,l),localGui:d.dir,keep:!0})),j++),k.start&&(c.splice(j,0,new e({content:k.start,localGui:d.dir,isSeparator:!0})),j++),c.splice(j,0,new e({content:n.substring(l+k.start.length,m-k.end.length),textDirection:k.subDir,localGui:d.dir,inBounds:!0})),k.end&&(j++,c.splice(j,0,new e({content:k.end,localGui:d.dir,isSeparator:!0}))),m+k.end.length<n.length&&c.splice(j+1,0,new e({content:n.substring(m+k.end.length,n.length),localGui:d.dir,keep:!0})),!k.loops)break}}for(i=0;i<c.length;i++)c[i].inBounds=!1;return c},handleCases:function(a,b,c,d,e){if(0===c.length)return a;var f={};for(var g in b)b.hasOwnProperty(g)&&(f[g]=b[g]);for(var h=0;h<c.length;h++)c[h].handler&&"function"==typeof c[h].handler.handle||(c[h].handler=b.commonHandler),c[h].args?(f.cases=c[h].args.cases,f.points=c[h].args.points,f.bounds=c[h].args.bounds,f.subs=c[h].args.subs):(f.cases=[],f.points=[],f.bounds=[],f.subs={}),c[h].handler.handle(d,a,f,e);return a},handlePoints:function(a,b,c,d,f){for(var g=0;g<c.length;g++)for(var h=0;!0&&!(h>=a.length);h++)if(!(a[h].isParsed||a[h].keep||a[h].isSeparator)){var i=a[h].content,j=i.indexOf(c[g]);j>=0&&(a.splice(h,1),j>0&&(a.splice(h,0,new e({content:i.substring(0,j),textDirection:b.subDir,localGui:b.dir,inPoints:!0})),h++),a.splice(h,0,new e({content:c[g],localGui:b.dir,isSeparator:!0})),j+c[g].length+1<=i.length&&a.splice(h+1,0,new e({content:i.substring(j+c[g].length),textDirection:b.subDir,localGui:b.dir,inPoints:!0})))}for(g=0;g<a.length;g++)a[g].keep?a[g].keep=!1:a[g].inPoints&&(a[g].isParsed=!0,a[g].inPoints=!1);return a}}}(),g=function(){return{handle:function(a,b,c,d){var e=[];Array.isArray(c.cases)&&(e=c.cases);var g=[];"undefined"!=typeof c.points&&(Array.isArray(c.points)?g=c.points:"string"==typeof c.points&&(g=c.points.split("")));var h={};"object"==typeof c.subs&&(h=c.subs);var i=[];return Array.isArray(c.bounds)&&(i=c.bounds),f.handleBounds(b,c,i,a,d),f.handleSubcontents(b,c,h,a,d),f.handleCases(b,c,e,a,d),f.handlePoints(b,c,g,a,d),b}}}(),h=function(){var a=function(a){var b=a?a.split("-")[0]:"";return!(!b||b.length<2)&&["iw","he","ar","fa","ur"].some(function(a){return a===b})},b="‪",c="‫",d="‬",e="‎",f="‏",g="‭",h="‮";return{LRE:b,RLE:c,PDF:d,LRM:e,RLM:f,LRO:g,RLO:h,getLocaleDetails:function(b){if(b||(b="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),b=b.toLowerCase(),a(b)){var c=b.split("-");return{lang:c[0],country:c[1]?c[1]:""}}return{lang:"not-bidi"}},removeUcc:function(a){return a?a.replace(/[\u200E\u200F\u202A-\u202E]/g,""):a},removeTags:function(a){return a?a.replace(/<[^<]*>/g,""):a},getDirection:function(a,b,c,d){if("auto"!==b&&/^(rtl|ltr)$/i.test(b))return b;c=/^(rtl|ltr)$/i.test(c)?c:"ltr";var e=d?a.split("").reverse().join(""):a,f=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e);return f?f[0]<="z"?"ltr":"rtl":c},hasArabicChar:function(a){var b=/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(a);return!!b},showMarks:function(a,i){for(var j="",k=0;k<a.length;k++){var l=""+a.charAt(k);switch(l){case e:j+="<LRM>";break;case f:j+="<RLM>";break;case b:j+="<LRE>";break;case c:j+="<RLE>";break;case g:j+="<LRO>";break;case h:j+="<RLO>";break;case d:j+="<PDF>";break;default:j+=l}}var m="undefined"!=typeof i&&/^(rtl|ltr)$/i.test(i)?"rtl"===i?h:g:"";return m+j+(""===m?"":d)},hideMarks:function(a){var b=a.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE);return b.replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(a){return"<xmp>"+a+"</xmp>"},hideTags:function(a){return a.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}}}(),i=function(){function a(a,b,e,f){return a&&b?d(c(a,b,f),b,e):a}function b(a,b){var c=Array.isArray(a)?a[0]:a;return c.guiDir||(c.guiDir="ltr"),c.dir||(c.dir=c.guiDir),b?("undefined"==typeof c.points&&(c.points=[]),c.cases||(c.cases=[]),c.bounds||(c.bounds=[]),c.commonHandler=g,c):c}function c(a,c,d){if(!a||!c)return new e({content:""});var f=b(c,!0),h=[new e({content:a,actual:a,localGui:f.dir})],i=g.handle;return f.handler&&"function"==typeof f.handler&&(i=f.handler.handle),i(a,h,f,d),h}function d(a,c,d){var e=b(c,!1);return d?i(a,e):f(a,e)}function f(a,b,c){for(var d="",e="",f="",g=!1,i=0;i<a.length;i++)if(a[i].isVisible){var j=a[i].textDirection,k=a[i].localGui;if(""!==k&&""===f?d+="rtl"===k?h.RLE:h.LRE:""===f||""!==k&&k===f&&!g||(d+=h.PDF+(i==a.length-1&&""!==k?"":"rtl"===b.dir?h.RLM:h.LRM),""!==k&&(d+="rtl"===k?h.RLE:h.LRE)),"auto"===j&&(j=h.getDirection(a[i].content,j,b.guiDir)),/^(rtl|ltr)$/i.test(j)?(d+=("rtl"===j?h.RLE:h.LRE)+a[i].content+h.PDF,e=j):(d+=a[i].content,e=h.getDirection(a[i].content,j,b.guiDir,!0)),i<a.length-1){var l=k&&a[i+1].localGui?k:b.dir;d+="rtl"===l?h.RLM:h.LRM}else""!==f&&(d+=h.PDF);f=k,g=!1}else g=!0;var m="auto"===b.dir?h.getDirection(a[0].actual,b.dir,b.guiDir):b.dir;return m!==b.guiDir&&(d=("rtl"===m?h.RLE:h.LRE)+d+h.PDF),d}function i(a,b,c){for(var d="",e="",f="",g=0;g<a.length;g++)if(a[g].isVisible){var i=a[g].textDirection,j=a[g].localGui;if(""!==j&&""===f?d+="<bdi dir='"+("rtl"===j?"rtl":"ltr")+"'>":""===f||""!==j&&j===f&&!stop||(d+="</bdi>"+(g==a.length-1&&""!==j?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===b.dir?"rtl":"ltr")+";'></span>"),""!==j&&(d+="<bdi dir='"+("rtl"===j?"rtl":"ltr")+"'>")),"auto"===i&&(i=h.getDirection(a[g].content,i,b.guiDir)),/^(rtl|ltr)$/i.test(i)?(d+="<bdi dir='"+("rtl"===i?"rtl":"ltr")+"'>"+a[g].content+"</bdi>",e=i):(d+=a[g].content,e=h.getDirection(a[g].content,i,b.guiDir,!0)),g<a.length-1){var k=j&&a[g+1].localGui?j:b.dir;d+="<span style='unicode-bidi: embed; direction: "+("rtl"===k?"rtl":"ltr")+";'></span>"}else""!==f&&(d+="</bdi>");f=j,stop=!1}else stop=!0;var l="auto"===b.dir?h.getDirection(a[0].actual,b.dir,b.guiDir):b.dir;return l!==b.guiDir&&(d="<bdi dir='"+("rtl"===l?"rtl":"ltr")+"'>"+d+"</bdi>"),d}function j(a,b){return a}var k={};return k.parseAndDisplayStructure=a,k.parseStructure=c,k.displayStructure=d,k.restore=j,k}(),j=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:b.dir?b.dir:c?"rtl":"ltr",subs:{content:">",continued:!0,subDir:c?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:c?"ltr":"rtl"}}}]};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),k=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:"ltr",points:","};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),l=function(){function a(a,b){if("ar"!==h.getLocaleDetails(b).lang)return"ltr";var c=a.indexOf("@");return c>0&&c<a.length-1&&h.hasArabicChar(a.substring(c+1))?"rtl":"ltr"}return{format:function(b,c,d,e,f,h){var j={guiDir:d?"rtl":"ltr",dir:a(b,f),points:"<>.:,;@",cases:[{handler:g,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return h?i.parseStructure(b,j,!!e,f):i.parseAndDisplayStructure(b,j,!!e,f)}}}(),m=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:"ltr",points:"/\\:."};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),n=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),o=function(){return{format:function(a,b,c,d,e,f){var h={guiDir:c?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:g,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:g,args:{subs:{content:" ",continued:!0}}},{handler:g,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return f?i.parseStructure(a,h,!!d,e):i.parseAndDisplayStructure(a,h,!!d,e)}}}(),p=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:"ltr",points:"_"};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),q=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),r=function(){return{format:function(a,b,c,d,e,f){var g={guiDir:c?"rtl":"ltr",dir:b.dir?b.dir:c?"rtl":"ltr",points:" ,.!?;:"};return f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),s=function(){return{format:function(a,b,c,d,e,f){var h={guiDir:c?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:g,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return f?i.parseStructure(a,h,!!d,e):i.parseAndDisplayStructure(a,h,!!d,e)}}}(),t=function(){return{format:function(a,b,c,d,e,f){var g={},h="",j=Array.isArray(b)?b[0]:b;for(h in j)j.hasOwnProperty(h)&&(g[h]=j[h]);return g.guiDir=c?"rtl":"ltr",g.dir=g.dir?g.dir:g.guiDir,f?i.parseStructure(a,g,!!d,e):i.parseAndDisplayStructure(a,g,!!d,e)}}}(),u=(function(){function b(a){return"he"===a||"iw"===a||"ar"===a?"rtl":"ltr"}function c(a){0===a.msgDir.length&&(a.msgDir=b(a.msgLang)),a.msgDir="ltr"!==a.msgDir&&"rtl"!==a.msgDir&&"auto"!=a.msgDir?"ltr":a.msgDir,0===a.guiDir.length&&(a.guiDir=a.msgDir),a.guiDir="rtl"!==a.guiDir?"ltr":"rtl",0===a.phDir.length&&(a.phDir=0===a.phLang.length?a.msgDir:b(a.phLang)),a.phDir="ltr"!==a.phDir&&"rtl"!==a.phDir&&"auto"!=a.phDir?"ltr":a.phDir,"string"==typeof a.phPacking&&(a.phPacking=a.phPacking.split("")),a.phPacking.length<2&&(a.phPacking=["{","}"])}var d={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},f=!1;return{setDefaults:function(a){for(var b in a)d.hasOwnProperty(b)&&(d[b]=a[b]);c(d),f=!0},format:function(b){f||(c(d),f=!0);var g=!1,h=!1,j=d.phPacking[0].length,k=d.phPacking[1].length;if(arguments.length>0){var l=arguments[arguments.length-1];"boolean"==typeof l&&(g=l,h=!0)}for(var m,n=new RegExp(d.phPacking[0]+"\\d+"+d.phPacking[1]),o=[],p=0,q=b;null!=(m=n.exec(q));){var r=q.indexOf(m[0])+m[0].length;r>m[0].length&&o.push({text:q.substring(0,r-m[0].length),ph:!1}),o.push({text:m[0],ph:!0}),p+=r,q=q.substring(r,q.length)}p<b.length&&o.push({text:b.substring(p,b.length),ph:!1});for(var s=[],t=1;t<arguments.length-(h?1:0);t++){var u=arguments[t],v=u,w=!1,x=0;if(Array.isArray(v)){if(u=v[0],"undefined"==typeof u)continue;w=!0}do"string"==typeof u?s.push({text:u,dir:d.phDir,stt:d.stt}):"boolean"==typeof u?g=u:"object"==typeof u?(s.push(u),u.hasOwnProperty("text")||(s[s.length-1].text="{???}"),u.hasOwnProperty("dir")&&0!==u.dir.length||(s[s.length-1].dir=d.phDir),(!u.hasOwnProperty("stt")||"string"==typeof u.stt&&0===u.stt.length||"object"==typeof u.stt&&0===Object.keys(u.stt).length)&&(s[s.length-1].stt=d.phStt)):s.push({text:""+u,dir:d.phDir,stt:d.phStt}),w&&(x++,x==v.length?w=!1:u=v[x]);while(w)}var y=[];for(t=0;t<o.length;t++){var z=o[t];if(z.ph){var A=parseInt(z.text.substring(j,z.text.length-k));if(isNaN(A)||A>=s.length){y.push(new e({content:z.text,textDirection:d.msgDir}));continue}var B="none";if(s[A].stt||(s[A].stt=d.phStt),s[A].stt&&("string"==typeof s[A].stt?B=s[A].stt:s[A].stt.hasOwnProperty("type")&&(B=s[A].stt.type)),"none"!==B.toLowerCase()){for(var C=a(B).format(s[A].text,s[A].stt.args||{},"rtl"===d.msgDir,!1,d.msgLang,!0),D=0;D<C.length;D++)y.push(C[D]);y.push(new e({isVisible:!1}))}else y.push(new e({content:s[A].text,textDirection:s[A].dir?s[A].dir:d.phDir}))}else y.push(new e({content:z.text,textDirection:d.msgDir}))}var E=i.displayStructure(y,{guiDir:d.guiDir,dir:d.msgDir},g);return E}}}(),null);return{getHtml:function(b,c,d,e,f){return a(c).format(b,d,e,!0,f)},attach:function(a,b,d,e,f){return c(a,b,d,e,f)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9},RED.nodes=function(){function a(a){N=a,RED.events.emit("nodes:change",{dirty:N})}function b(){return(1+4294967295*Math.random()).toString(16)}function c(a){if(0!==a.type.indexOf("subflow")?a._=a._def._:a._=RED._,"config"==a._def.category)H[a.id]=a;else{if(a.inputPorts=[],a.inputs)for(var b=0;b<a.inputs;b++)a.inputPorts.push(b);if(a.outputPorts=[],a.wires&&a.wires.length>a.outputs&&(a.outputs=a.wires.length),a.outputs)for(var b=0;b<a.outputs;b++)a.outputPorts.push(b);if(a.dirty=!0,B(a),"subflows"==a._def.category&&"undefined"==typeof a.i){var c=0;RED.nodes.eachNode(function(a){c=Math.max(c,a.i||0)}),a.i=c+1}G.push(a)}RED.events.emit("nodes:add",a)}function d(a){I.push(a)}function e(a){if(a in H)return H[a];for(var b in G)if(G[b].id==a)return G[b];return null}function f(a){var b,c=[],d=[];if(a in H)b=H[a],delete H[a],RED.events.emit("nodes:remove",b),RED.workspaces.refresh();else if(b=e(a)){G.splice(G.indexOf(b),1),c=I.filter(function(a){return a.source===b||a.target===b}),c.forEach(function(a){I.splice(I.indexOf(a),1)});var g=!1;for(var h in b._def.defaults)if(b._def.defaults.hasOwnProperty(h)){var i=b._def.defaults[h];if(i.type){var j=O.getNodeType(i.type);if(j&&"config"==j.category){var k=H[b[h]];if(k)if(g=!0,k._def.exclusive)f(b[h]),d.push(k);else{var l=k.users;l.splice(l.indexOf(b),1)}}}}g&&RED.workspaces.refresh(),RED.events.emit("nodes:remove",b)}return b&&b._def.onremove&&b._def.onremove.call(n),{links:c,nodes:d}}function g(a){var b=I.indexOf(a);b!=-1&&I.splice(b,1)}function h(a){J[a.id]=a,a._def={defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}},K.push(a.id)}function j(a){return J[a]}function k(a){delete J[a],K.splice(K.indexOf(a),1);var b,c,d=[],e=[];for(b=0;b<G.length;b++)c=G[b],c.z==a&&d.push(c);for(b in H)H.hasOwnProperty(b)&&(c=H[b],c.z==a&&d.push(c));for(b=0;b<d.length;b++){var g=f(d[b].id);e=e.concat(g.links)}return{nodes:d,links:e}}function l(a,b){if(b){var c=Object.keys(L).map(function(a){return L[a].name});c.sort();var d=1,e=a.name;c.forEach(function(b){e==b&&(d++,e=a.name+" ("+d+")")}),a.name=e}L[a.id]=a,RED.nodes.registerType("subflow:"+a.id,{defaults:{name:{value:""}},info:a.info,icon:"subflow.png",category:"subflows",inputs:a.in.length,outputs:a.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(a.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(a.id).name},inputLabels:function(b){return a.inputLabels?a.inputLabels[b]:null},outputLabels:function(b){return a.outputLabels?a.outputLabels[b]:null},set:{module:"node-red"}}),a._def=RED.nodes.getType("subflow:"+a.id)}function m(a){return L[a]}function o(a){delete L[a.id],O.removeNodeType("subflow:"+a.id)}function p(a,b){for(var c=0;c<G.length;c++){var d=G[c];if(d.z===a){var e=/^subflow:(.+)$/.exec(d.type);if(e){if(e[1]===b)return!0;var f=p(e[1],b);if(f)return!0}}}return!1}function q(a){var b={};b[a.id]=!0;for(var c=[a],d=[a];0!==d.length;)for(var e=d.shift(),f=I.filter(function(a){return a.source===e||a.target===e}),g=0;g<f.length;g++){var h=f[g].source===e?f[g].target:f[g].source,i=h.id;i||(i=h.direction+":"+h.i),b[i]||(b[i]=!0,c.push(h),d.push(h))}return c}function r(a){var b={};b.id=a.id,b.type=a.type,b.namespace=a.namespace?a.namespace:a.type;for(var c in a._def.defaults)a._def.defaults.hasOwnProperty(c)&&(b[c]=a[c]);return b}function s(a,b){if("tab"===a.type)return r(a);b=b||!1;var c={};if(c.id=a.id,c.type=a.type,c.namespace=a._def.namespace?a._def.namespace:a.type,c.z=a.z,"unknown"==c.type)for(var d in a._orig)a._orig.hasOwnProperty(d)&&(c[d]=a._orig[d]);else{for(var e in a._def.defaults)a._def.defaults.hasOwnProperty(e)&&(c[e]=a[e]);if(b&&a.credentials){var f={};c.credentials={};for(var g in a._def.credentials)a._def.credentials.hasOwnProperty(g)&&("password"==a._def.credentials[g].type?(!a.credentials._||a.credentials["has_"+g]!=a.credentials._["has_"+g]||a.credentials["has_"+g]&&a.credentials[g])&&(f[g]=a.credentials[g]):null==a.credentials[g]||a.credentials._&&a.credentials[g]==a.credentials._[g]||(f[g]=a.credentials[g]));Object.keys(f).length>0&&(c.credentials=f)}}if("config"!=a._def.category){c.x=a.x,c.y=a.y,c.wires=[];for(var h=0;h<a.outputs;h++)c.wires.push([]);for(var i=I.filter(function(b){return b.source===a}),j=0;j<i.length;j++){var k=i[j];"subflow"!=k.target.type&&c.wires[k.sourcePort].push({id:k.target.id,port:k.targetPort})}a.inputs>0&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(c.inputLabels=a.inputLabels.slice()),a.outputs>0&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(c.outputLabels=a.outputLabels.slice())}return c}function t(a){var b={};return b.id=a.id,b.type=a.type,b.namespace=a.namespace?a.namespace:a.type,b.name=a.name,b.info=a.info,b.in=[],b.out=[],a.in.forEach(function(a){for(var c={x:a.x,y:a.y,wires:[]},d=I.filter(function(b){return b.source===a}),e=0;e<d.length;e++){var f=d[e];"subflow"!=f.target.type&&c.wires.push({id:f.target.id,port:d[e].targetPort})}b.in.push(c)}),a.out.forEach(function(c,d){var e={x:c.x,y:c.y,wires:[]},f=I.filter(function(a){return a.target===c});for(i=0;i<f.length;i++)"subflow"!=f[i].source.type?e.wires.push({id:f[i].source.id,port:f[i].sourcePort}):e.wires.push({id:a.id,port:f[i].sourcePort});b.out.push(e)}),b.in.length>0&&a.inputLabels&&!/^\s*$/.test(a.inputLabels.join(""))&&(b.inputLabels=a.inputLabels.slice()),b.out.length>0&&a.outputLabels&&!/^\s*$/.test(a.outputLabels.join(""))&&(b.outputLabels=a.outputLabels.slice()),
b}function u(a){for(var b=[],c={},d={},e=0;e<a.length;e++){var f=a[e];if("subflow:"==f.type.substring(0,8)){var g=f.type.substring(8);if(!d[g]){d[g]=!0;var h=m(g),i=[h];RED.nodes.eachNode(function(a){a.z==g&&i.push(a)});var j=u(i);b=j.concat(b)}}if("subflow"!=f.type){var k=RED.nodes.convertNode(f);for(var l in f._def.defaults)if(f._def.defaults[l].type&&f[l]in H){var n=H[f[l]],o=O.getNodeType(f._def.defaults[l].type).exportable;null==o||o?f[l]in c||(c[f[l]]=!0,a.push(n)):k[l]=""}b.push(k)}else{var p=t(f);b.push(p)}}return b}function v(a){void 0===a&&(a=!0);var b,c=[];for(b=0;b<K.length;b++)"tab"==J[K[b]].type&&c.push(r(J[K[b]]));for(b in L)L.hasOwnProperty(b)&&c.push(t(L[b]));for(b in H)H.hasOwnProperty(b)&&c.push(s(H[b],a));for(b=0;b<G.length;b++){var d=G[b];c.push(s(d,a))}return c}function w(a,b){var c,d=null;try{RED.nodes.eachSubflow(function(e){if(e.name==a.name&&e.info==a.info&&e.in.length==a.in.length&&e.out.length==a.out.length){var f=RED.nodes.filterNodes({z:e.id});if(f.length==b.length){var g=[a].concat(b),h=[e].concat(f),i=JSON.stringify(g),j=JSON.stringify(u(h));for(c=0;c<f.length;c++)i=i.replace(new RegExp('"'+b[c].id+'"',"g"),'"'+f[c].id+'"');if(i=i.replace(new RegExp('"'+a.id+'"',"g"),'"'+e.id+'"'),i===j)throw d=e,new Error}}})}catch(a){console.log(a.stack)}return d}function x(a,b,c){if(c&&a.id!=b.id)return!1;if(a.type!=b.type)return!1;var d=a._def;for(var e in d.defaults)if(d.defaults.hasOwnProperty(e)){var f=a[e],g=b[e];if(typeof f!=typeof g)return!1;if(null===f||"string"==typeof f||"number"==typeof f){if(f!==g)return!1}else if(JSON.stringify(f)!==JSON.stringify(g))return!1}return!0}function y(a,e,f){var g,i,j,k={};if("string"==typeof a){if(""===a)return;try{j=JSON.parse(a)}catch(a){var n=new Error(RED._("clipboard.invalidFlow",{message:a.message}));throw n.code="NODE_RED",n}}else j=a;$.isArray(j)||(j=[j]),F||(F=JSON.parse(JSON.stringify(j)));var o=[];for(g=0;g<j.length;g++)i=j[g],"workspace"==i.type||"tab"==i.type||"subflow"==i.type||O.getNodeType(i.type)||"subflow:"==i.type.substring(0,8)||o.indexOf(i.type)!=-1||o.push(i.type),i.z&&(k[i.z]=k[i.z]||[],k[i.z].push(i));if(o.length>0){var q="<ul><li>"+o.join("</li><li>")+"</li></ul>";"type"+(o.length>1?"s":"");RED.notify("<strong>"+RED._("clipboard.importUnrecognised",{count:o.length})+"</strong>"+q,"error",!1,1e4)}var r=RED.workspaces.active(),s=m(r);for(g=0;g<j.length;g++){var t=/^subflow:(.+)$/.exec(j[g].type);if(t){var u=t[1],v=m(j[g].z||r);if(v){var y;if(u===v.id&&(y=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),p(u,v.id)&&(y=new Error(RED._("notification.errors.cannotAddCircularReference"))),y)throw y.code="NODE_RED",y}}}var z,A,B,C,D=[],G={},I=[],K={},L={},M={},N=[],P=[],Q=null;for(g=0;g<j.length;g++)if(i=j[g],"workspace"===i.type||"tab"===i.type)"workspace"===i.type&&(i.type="tab"),null==E&&(E=i),e&&(z=b(),G[i.id]=z,i.id=z),h(i),RED.workspaces.add(i),D.push(i);else if("subflow"===i.type){var R=w(i,k[i.id]);R?L[i.id]=R:(K[i.id]=i,e&&(z=b(),i.id=z),i.in.forEach(function(a,c){a.type="subflow",a.direction="in",a.z=i.id,a.i=c,a.id=b()}),i.out.forEach(function(a,c){a.type="subflow",a.direction="out",a.z=i.id,a.i=c,a.id=b()}),I.push(i),l(i,e))}for(null==E&&(E={type:"tab",id:b(),label:RED._("workspace.defaultName",{number:1})},h(E),RED.workspaces.add(E),D.push(E),r=RED.workspaces.active()),g=0;g<j.length;g++)if(i=j[g],A=O.getNodeType(i.type),A&&"config"==A.category){var S=null;if(e){if(i.z){if(L[i.z])continue;K[i.z]?i.z=K[i.z].id:(i.z=G[i.z],J[i.z]||(f?(null===Q&&(Q=RED.workspaces.add(null,!0),D.push(Q)),i.z=Q.id):i.z=r))}if(S=RED.nodes.node(i.id),S&&i.z&&S.z!==i.z){S=null;for(var T in H)if(H.hasOwnProperty(T)&&H[T].z===i.z&&x(H[T],i,!1)){S=H[T],M[i.id]=H[T];break}}}if(!S){B={id:i.id,z:i.z,type:i.type,namespace:i.namespace,users:[],_config:{}};for(C in A.defaults)A.defaults.hasOwnProperty(C)&&(B[C]=i[C],B._config[C]=JSON.stringify(i[C]));if(A.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials")){B.credentials={};for(C in A.credentials)A.credentials.hasOwnProperty(C)&&i.credentials.hasOwnProperty(C)&&(B.credentials[C]=i.credentials[C])}B.label=A.label,B._def=A,e&&(B.id=b()),M[i.id]=B,N.push(B),RED.nodes.add(B)}}for(g=0;g<j.length;g++)if(i=j[g],"workspace"!==i.type&&"tab"!==i.type&&"subflow"!==i.type&&(A=O.getNodeType(i.type),!A||"config"!=A.category)){var U={x:i.x,y:i.y,z:i.z,type:0,wires:i.wires,inputLabels:i.inputLabels,outputLabels:i.outputLabels,changed:!1,_config:{}};if(e){if(L[i.z])continue;K[U.z]?U.z=K[U.z].id:(U.z=G[U.z],J[U.z]||(f?(null===Q&&(Q=RED.workspaces.add(null,!0),D.push(Q)),U.z=Q.id):U.z=r)),U.id=b()}else U.id=i.id,null!=U.z&&(J[U.z]||K[U.z])||(f?(null===Q&&(Q=RED.workspaces.add(null,!0),D.push(Q)),U.z=Q.id):U.z=r);if(U.type=i.type,U.namespace=i.namespace?i.namespace:A.namespace?A.namespace:i.type,U._def=A,"subflow"===i.type.substring(0,7)){var V=i.type.split(":")[1],W=L[V]||K[V]||m(V);e&&(V=W.id,U.type="subflow:"+V,U.namespace=U.type,U._def=O.getNodeType(U.type),delete U.i),U.name=i.name,U.outputs=W.out.length,U.inputs=W.in.length}else{if(!U._def){U.x&&U.y?U._def={color:"#fee",defaults:{},label:"unknown: "+i.type,labelStyle:"node_label_italic",outputs:i.outputs||i.wires.length,set:O.getNodeSet("node-red/unknown")}:(U._def={category:"config",set:O.getNodeSet("node-red/unknown")},U.users=[]);var X={};for(var Y in i)i.hasOwnProperty(Y)&&"x"!=Y&&"y"!=Y&&"z"!=Y&&"id"!=Y&&"wires"!=Y&&(X[Y]=i[Y]);U._orig=X,U.name=i.type,U.type="unknown",U.namespace="unknown"}if("config"!=U._def.category){U.inputs=i.inputs||U._def.inputs,U.outputs=i.outputs||U._def.outputs;for(C in U._def.defaults)U._def.defaults.hasOwnProperty(C)&&(U[C]=i[C],U._config[C]=JSON.stringify(i[C]));if(U._config.x=U.x,U._config.y=U.y,U._def.hasOwnProperty("credentials")&&i.hasOwnProperty("credentials")){U.credentials={};for(C in U._def.credentials)U._def.credentials.hasOwnProperty(C)&&i.credentials.hasOwnProperty(C)&&(U.credentials[C]=i.credentials[C])}}}c(U),RED.editor.validateNode(U),M[i.id]=U,"config"!=U._def.category&&N.push(U)}var Z={catch:"scope",status:"scope","link in":"links","link out":"links"};for(g=0;g<N.length;g++){if(i=N[g],i.wires){for(var _=0;_<i.wires.length;_++)for(var aa=i.wires[_]instanceof Array?i.wires[_]:[i.wires[_]],ba=0;ba<aa.length;ba++)if(M.hasOwnProperty(aa[ba].id)&&aa[ba].port<M[aa[ba].id].inputs)if(i.z===M[aa[ba].id].z){var ca={source:i,sourcePort:_,target:M[aa[ba].id],targetPort:aa[ba].port};d(ca),P.push(ca)}else console.log("Warning: dropping link that crosses tabs:",i.id,"->",M[aa[ba]].id);delete i.wires}for(var da in i._def.defaults)if(i._def.defaults.hasOwnProperty(da))if(i._def.defaults[da].type&&M[i[da]])i[da]=M[i[da]].id,B=RED.nodes.node(i[da]),B&&B.users.indexOf(i)===-1&&B.users.push(i);else if(Z.hasOwnProperty(i.type)&&Z[i.type]===da&&void 0!==i[da]&&null!==i[da])for(var ea=0;ea<i[da].length;ea++)M[i[da][ea]]&&(i[da][ea]=M[i[da][ea]].id);s&&/^link /.test(i.type)&&i.links&&(i.links=i.links.filter(function(a){var b=RED.nodes.node(a);return b&&b.z===r})),RED.editor.validateNode(i)}for(g=0;g<I.length;g++)i=I[g],i.in.forEach(function(a){a.wires.forEach(function(b,c){var e={source:a,sourcePort:c,target:M[b.id],targetPort:b.port};d(e),P.push(e)}),delete a.wires}),i.out.forEach(function(a){a.wires.forEach(function(b){var c;c=K[b.id]&&K[b.id].id==i.id?{source:i.in[b.port],sourcePort:b.port,target:a}:{source:M[b.id]||K[b.id],sourcePort:b.port,target:a},d(c),P.push(c)}),delete a.wires});return RED.workspaces.refresh(),[N,P,D,I,Q]}function z(a){for(var b=[],c=0;c<G.length;c++){var d=G[c];a.hasOwnProperty("z")&&d.z!==a.z||a.hasOwnProperty("type")&&d.type!==a.type||b.push(d)}return b}function A(a){for(var b=[],c=0;c<I.length;c++){var d=I[c];if(a.source){if(a.source.hasOwnProperty("id")&&d.source.id!==a.source.id)continue;if(a.source.hasOwnProperty("z")&&d.source.z!==a.source.z)continue}if(a.target){if(a.target.hasOwnProperty("id")&&d.target.id!==a.target.id)continue;if(a.target.hasOwnProperty("z")&&d.target.z!==a.target.z)continue}a.hasOwnProperty("sourcePort")&&d.sourcePort!==a.sourcePort||a.hasOwnProperty("targetPort")&&d.targetPort!==a.targetPort||b.push(d)}return b}function B(a){for(var b in a._def.defaults)if(a._def.defaults.hasOwnProperty(b)){var c=a._def.defaults[b];if(c.type){var d=O.getNodeType(c.type);if(d&&"config"==d.category){var e=H[a[b]];e&&e.users.indexOf(a)===-1&&e.users.push(a)}}}}function C(a){return void 0===a?M:void(M=a)}function D(){G=[],I=[],H={},K=[];var a=Object.keys(L);a.forEach(function(a){RED.subflow.removeSubflow(a)});var b=Object.keys(J);b.forEach(function(a){RED.workspaces.remove(J[a])}),E=null,RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}var E,F,G=[],H={},I=[],J={},K=[],L={},M=null,N=!1,O=function(){var a={},b=[],c={},d={},e={},f={setModulePendingUpdated:function(b,c){a[b].pending_version=c,RED.events.emit("registry:module-updated",{module:b,version:c})},getModule:function(b){return a[b]},getNodeSetForType:function(a){return f.getNodeSet(d[a])},getModuleList:function(){return a},getNodeList:function(){return b},getNodeTypes:function(){return Object.keys(e)},setNodeList:function(a){b=[];for(var c=0;c<a.length;c++){var d=a[c];f.addNodeSet(d)}},addNodeSet:function(e){e.added=!1,c[e.id]=e;for(var f=0;f<e.types.length;f++)d[e.types[f]]=e.id;b.push(e),a[e.module]=a[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(a[e.module].pending_version=e.pending_version),a[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var f=c[e],g=0;g<f.types.length;g++)delete d[f.types[g]];delete c[e];for(var h=0;h<b.length;h++)if(b[h].id===e){b.splice(h,1);break}return delete a[f.module].sets[f.name],0===Object.keys(a[f.module].sets).length&&delete a[f.module],RED.events.emit("registry:node-set-removed",f),f},getNodeSet:function(a){return c[a]},enableNodeSet:function(a){var b=c[a];b.enabled=!0,RED.events.emit("registry:node-set-enabled",b)},disableNodeSet:function(a){var b=c[a];b.enabled=!1,RED.events.emit("registry:node-set-disabled",b)},registerNodeType:function(a,b){if(e[a]=b,b.type=a,"subflows"!=b.category){b.set=c[d[a]],c[d[a]].added=!0,c[d[a]].enabled=!0;var f;f="node-red"===b.set.module?"node-red":b.set.id,b._=function(){var a=Array.prototype.slice.call(arguments,0),b=a[0];a[0].indexOf(":")===-1&&(a[0]=f+":"+a[0]);var c=RED._.apply(null,a);return c===a[0]&&(c=b),c}}RED.events.emit("registry:node-type-added",a)},removeNodeType:function(a){if("subflow:"!=a.substring(0,8))throw new Error("this api is subflow only. called with:",a);delete e[a],RED.events.emit("registry:node-type-removed",a)},getNodeType:function(a){return e[a]}};return f}();return{registry:O,setNodeList:O.setNodeList,getNodeSet:O.getNodeSet,addNodeSet:O.addNodeSet,removeNodeSet:O.removeNodeSet,enableNodeSet:O.enableNodeSet,disableNodeSet:O.disableNodeSet,registerType:O.registerNodeType,getType:O.getNodeType,convertNode:s,add:c,remove:f,clear:D,addLink:d,removeLink:g,addWorkspace:h,removeWorkspace:k,getWorkspaceOrder:function(){return K},setWorkspaceOrder:function(a){K=a},workspace:j,addSubflow:l,removeSubflow:o,subflow:m,subflowContains:p,eachNode:function(a){for(var b=0;b<G.length;b++)a(G[b])},eachLink:function(a){for(var b=0;b<I.length;b++)a(I[b])},eachConfig:function(a){for(var b in H)H.hasOwnProperty(b)&&a(H[b])},eachSubflow:function(a){for(var b in L)L.hasOwnProperty(b)&&a(L[b])},eachWorkspace:function(a){for(var b=0;b<K.length;b++)a(J[K[b]])},node:e,version:C,originalFlow:function(a){return void 0===a?F:void(F=a)},filterNodes:z,filterLinks:A,import:y,getAllFlowNodes:q,createExportableNodeSet:u,createCompleteNodeSet:v,updateConfigNodeUsers:B,id:b,dirty:function(b){return null==b?N:void a(b)}}}(),RED.history=function(){function a(b){var c,d,e,f,g={};if(b){if("multi"==b.t)for(d=b.events.length,c=d-1;c>=0;c--)a(b.events[c]);else if("replace"==b.t){RED.nodes.clear();var h=RED.nodes.import(b.config);h[0].forEach(function(a){b.changed[a.id]&&(a.changed=!0)}),RED.nodes.version(b.rev)}else if("add"==b.t){if(b.nodes)for(c=0;c<b.nodes.length;c++)e=RED.nodes.node(b.nodes[c]),e.z&&(g[e.z]=!0),RED.nodes.remove(b.nodes[c]);if(b.links)for(c=0;c<b.links.length;c++)RED.nodes.removeLink(b.links[c]);if(b.workspaces)for(c=0;c<b.workspaces.length;c++)RED.nodes.removeWorkspace(b.workspaces[c].id),RED.workspaces.remove(b.workspaces[c]);if(b.subflows)for(c=0;c<b.subflows.length;c++)RED.nodes.removeSubflow(b.subflows[c]),RED.workspaces.remove(b.subflows[c]);if(b.subflow&&(b.subflow.instances&&b.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),b.subflow.hasOwnProperty("changed")&&(f=RED.nodes.subflow(b.subflow.id),f&&(f.changed=b.subflow.changed))),b.removedLinks)for(c=0;c<b.removedLinks.length;c++)RED.nodes.addLink(b.removedLinks[c])}else if("delete"==b.t){if(b.workspaces)for(c=0;c<b.workspaces.length;c++)RED.nodes.addWorkspace(b.workspaces[c]),RED.workspaces.add(b.workspaces[c]);if(b.subflow&&b.subflow.subflow&&RED.nodes.addSubflow(b.subflow.subflow),b.subflowInputs&&b.subflowInputs.length>0&&(f=RED.nodes.subflow(b.subflowInputs[0].z),f.in.push(b.subflowInputs[0]),f.in[0].dirty=!0),b.subflowOutputs&&b.subflowOutputs.length>0)for(f=RED.nodes.subflow(b.subflowOutputs[0].z),b.subflowOutputs.sort(function(a,b){return a.i-b.i}),c=0;c<b.subflowOutputs.length;c++){var i=b.subflowOutputs[c];f.out.splice(i.i,0,i);for(var j=i.i+1;j<f.out.length;j++)f.out[j].i++,f.out[j].dirty=!0;RED.nodes.eachLink(function(a){a.source.type=="subflow:"+f.id&&a.sourcePort>=i.i&&a.sourcePort++})}if(b.subflow&&b.subflow.hasOwnProperty("instances")&&b.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),f&&RED.nodes.filterNodes({type:"subflow:"+f.id}).forEach(function(a){for(a.inputs=f.in.length;a.inputs>a.inputPorts.length;)a.inputPorts.push(a.inputPorts.length);for(a.outputs=f.out.length;a.outputs>a.outputPorts.length;)a.outputPorts.push(a.outputPorts.length);a.resize=!0,a.dirty=!0}),b.nodes)for(c=0;c<b.nodes.length;c++)RED.nodes.add(b.nodes[c]),g[b.nodes[c].z]=!0;if(b.links)for(c=0;c<b.links.length;c++)RED.nodes.addLink(b.links[c]);if(b.changes)for(c in b.changes)if(b.changes.hasOwnProperty(c)&&(e=RED.nodes.node(c))){for(var k in b.changes[c])b.changes[c].hasOwnProperty(k)&&(e[k]=b.changes[c][k]);e.dirty=!0}}else if("move"==b.t){for(c=0;c<b.nodes.length;c++){var l=b.nodes[c];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(b.links)for(c=0;c<b.links.length;c++)RED.nodes.removeLink(b.links[c]);if(b.removedLinks)for(c=0;c<b.removedLinks.length;c++)RED.nodes.addLink(b.removedLinks[c])}else if("edit"==b.t){for(c in b.changes)if(b.changes.hasOwnProperty(c)){if(b.node._def.defaults[c]&&b.node._def.defaults[c].type){var m=RED.nodes.node(b.node[c]);m&&m.users.splice(m.users.indexOf(b.node),1);var n=RED.nodes.node(b.changes[c]);n&&n.users.push(b.node)}b.node[c]=b.changes[c]}if(b.subflow)b.subflow.hasOwnProperty("inputCount")&&(b.node.in.length>b.subflow.inputCount?b.node.in.splice(b.subflow.inputCount):b.subflow.inputs.length>0&&(b.node.in=b.node.in.concat(b.subflow.inputs))),b.subflow.hasOwnProperty("outputCount")&&(b.node.out.length>b.subflow.outputCount?b.node.out.splice(b.subflow.outputCount):b.subflow.outputs.length>0&&(b.node.out=b.node.out.concat(b.subflow.outputs))),b.subflow.hasOwnProperty("instances")&&b.subflow.instances.forEach(function(a){var b=RED.nodes.node(a.id);b&&(b.changed=a.changed,b.dirty=!0)}),RED.nodes.filterNodes({type:"subflow:"+b.node.id}).forEach(function(a){a.inputs=b.node.in.length,a.outputs=b.node.out.length,RED.editor.updateNodeProperties(a)});else{var o;if(b.outputMap){o={};for(var p in b.outputMap)b.outputMap.hasOwnProperty(p)&&"-1"!==b.outputMap[p]&&(o[b.outputMap[p]]=p)}RED.editor.updateNodeProperties(b.node,o),RED.editor.validateNode(b.node)}if(b.links)for(c=0;c<b.links.length;c++)RED.nodes.addLink(b.links[c]);b.node.dirty=!0,b.node.changed=b.changed}else if("createSubflow"==b.t){if(b.nodes)for(RED.nodes.filterNodes({z:b.subflow.subflow.id}).forEach(function(a){a.z=b.activeWorkspace,a.dirty=!0}),c=0;c<b.nodes.length;c++)RED.nodes.remove(b.nodes[c]);if(b.links)for(c=0;c<b.links.length;c++)RED.nodes.removeLink(b.links[c]);if(RED.nodes.removeSubflow(b.subflow.subflow),RED.workspaces.remove(b.subflow.subflow),b.removedLinks)for(c=0;c<b.removedLinks.length;c++)RED.nodes.addLink(b.removedLinks[c])}else"reorder"==b.t&&b.order&&RED.workspaces.order(b.order);Object.keys(g).forEach(function(a){var b=RED.nodes.subflow(a);b&&RED.editor.validateNode(b)}),RED.nodes.dirty(b.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}var b=[];return{markAllDirty:function(){for(var a=0;a<b.length;a++)b[a].dirty=!0},list:function(){return b},depth:function(){return b.length},push:function(a){b.push(a)},pop:function(){var c=b.pop();a(c)},peek:function(){return b[b.length-1]}}}(),RED.validators={number:function(a){return function(b){return a&&(""===b||void 0===b)||""!==b&&!isNaN(b)}},regex:function(a){return function(b){return a.test(b)}},typedInput:function(a,b){return function(c){var d=$("#node-"+(b?"config-":"")+"input-"+a).val()||this[a];if("json"===d)try{return JSON.parse(c),!0}catch(a){return!1}else{if("msg"===d||"flow"===d||"global"===d)return RED.utils.validatePropertyExpression(c);if("num"===d)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(c)}return!0}}},RED.utils=function(){function a(a){return a.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function b(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function c(c){var d;if(Array.isArray(c))d=$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+c.length+"]");else if(null===c)d=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof c)d=c.hasOwnProperty("type")&&"Buffer"===c.type&&c.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("buffer["+c.length+"]"):c.hasOwnProperty("type")&&"array"===c.type&&c.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+c.length+"]"):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof c){var e;e=c.length>30?b(c.substring(0,30))+"&hellip;":b(c),d=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+a(e)+'"')}else d=$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+c);return d}function d(a,b,c){a.addClass("debug-message-expandable"),a.click(function(a){var c=$(this).parent();c.hasClass("collapsed")?(b&&!c.hasClass("built")&&(b(),c.addClass("built")),c.removeClass("collapsed")):c.addClass("collapsed"),a.preventDefault()}),c&&a.click()}function e(a,b,c,d,e,f){o.hasOwnProperty(b)||(o[b]={});var g=$('<span class="debug-message-tools"></span>').appendTo(a),h=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(g);if(c)var i=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(h).click(function(a){a.preventDefault(),a.stopPropagation(),RED.clipboard.copyText(c,i,"clipboard.copyMessagePath")});var k=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(h).click(function(a){a.preventDefault(),a.stopPropagation(),RED.clipboard.copyText(d,k,"clipboard.copyMessageValue")});if(""!==f){var l=o[b].hasOwnProperty(f);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(g).click(function(c){if(c.preventDefault(),c.stopPropagation(),o[b].hasOwnProperty(f))delete o[b][f],$(this).removeClass("selected"),a.removeClass("debug-message-row-pinned");else{var d="$"+("["===f[0]?"":".")+f;o[b][f]=j(d),$(this).addClass("selected"),a.addClass("debug-message-row-pinned")}}).toggleClass("selected",l);a.toggleClass("debug-message-row-pinned",l)}}function f(a,b,c,d){if(b&&b.length>0){if(""===a&&void 0===c)return!0;for(var e=0;e<b.length;e++){var f=b[e];if(0===f.indexOf(a)&&("."===f[a.length]||"["===f[a.length])){if(void 0===c||"["!==f[a.length])return!0;var g=f.substring(a.length),h=/\[(\d+)\]/.exec(g);if(h){var i=parseInt(h[1]);return c<=i&&i<=d}}}}return!1}function g(a,b,c,d,e,f){var g=p[c]&&p[c][d]||f||"dec";e?(g="dec"===g?13===b.toString().length&&b<=2147483647e3?"dateMS":10===b.toString().length&&b<=2147483647?"dateS":"hex":"dateMS"===g||"dateS"==g?"hex":"dec",p[c]=p[c]||{},p[c][d]=g):void 0!==f&&(p[c]=p[c]||{},p[c][d]=g),"dec"===g?a.text(""+b):"dateMS"===g?a.text(new Date(b).toISOString()):"dateS"===g?a.text(new Date(1e3*b).toISOString()):"hex"===g&&a.text("0x"+b.toString(16))}function h(a,b,c,d,e){var f=p[c]&&p[c][d]||"raw";e&&(f="raw"===f?"string":"raw",p[c]=p[c]||{},p[c][d]=f),"raw"===f?(b.text("raw"),a.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===f&&(b.text("string"),a.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function i(j,k,m,n,p,q,r,s){var t,u,v,w,x,y;void 0!==p&&void 0!==r&&(y=p.substring(r.length+("."===p[r.length]?1:0)));var z=$('<span class="debug-message-element"></span>');if(z.collapse=function(){z.find(".debug-message-expandable").parent().addClass("collapsed")},w=$('<span class="debug-message-row"></span>').appendTo(z),q&&e(w,q,p,j,r,y),k)n||($('<span class="debug-message-object-key"></span>').text(k).appendTo(w),$("<span>: </span>").appendTo(w));else if(z.addClass("debug-message-top-level"),q){var A=o[q];if(s=[],A){for(var B in A)if(A.hasOwnProperty(B))try{var C=l({$:j},A[B]);void 0!==C&&s.push(B)}catch(a){}s.sort()}z.clearPinned=function(){z.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),o[q]={}}}v=$('<span class="debug-message-object-value"></span>').appendTo(w);var D=Array.isArray(j),E=!1;if(j&&"object"==typeof j&&j.hasOwnProperty("type")&&j.hasOwnProperty("data")&&(j.__encoded__&&"array"===j.type||"Buffer"===j.type)&&(D=!0,E=!0),null===j||void 0===j)$('<span class="debug-message-type-null">'+j+"</span>").appendTo(v);else if("string"==typeof j)/[\t\n\r]/.test(j)&&(z.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(w),d(w,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(m||"string").appendTo(w);var a=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(z);$('<pre class="debug-message-type-string"></pre>').text(j).appendTo(a)},f(y,s))),u=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+a(b(j))+'"').appendTo(v),/^#[0-9a-f]{6}$/i.test(j)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",j).appendTo(u);else if("number"==typeof j)u=$('<span class="debug-message-type-number"></span>').appendTo(v),Number.isInteger(j)&&j>=0&&(u.addClass("debug-message-type-number-toggle"),u.click(function(a){a.preventDefault(),g($(this),j,q,p,!0)})),g(u,j,q,p,!1,"hex"===m?"hex":void 0);else if(D){z.addClass("collapsed");var F=j.length;if(m){var G=/\[(\d+)\]/.exec(m);G&&(F=parseInt(G[1]))}var H=j,I="array";E?(H=j.data,void 0===F&&(F=H.length),H.__encoded__&&(H=H.data),I=j.type.toLowerCase()):/buffer/.test(m)&&(I="buffer");var J=H.length;if(F>0){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(w);var K=$('<div class="debug-message-array-rows"></div>').appendTo(z);z.addClass("debug-message-buffer-raw")}if(k)x=$('<span class="debug-message-type-meta"></span>').html(m||I+"["+F+"]").appendTo(v);else{x=$('<span class="debug-message-object-header"></span>').appendTo(v),$("<span>[ </span>").appendTo(x);var L=Math.min(F,10);for(t=0;t<L;t++)c(H[t]).appendTo(x),t<L-1&&$("<span>, </span>").appendTo(x);F>L&&$("<span> &hellip;</span>").appendTo(x),0===L&&$('<span class="debug-message-type-meta">empty</span>').appendTo(x),$("<span> ]</span>").appendTo(x)}F>0&&d(w,function(){if(k||(x=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(m||I+"["+F+"]").appendTo(w)),"buffer"===I){var a=$('<div class="debug-message-string-rows"></div>').appendTo(z),b=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(a),c="";try{c=String.fromCharCode.apply(null,new Uint16Array(H))}catch(a){console.log(a)}$('<pre class="debug-message-type-string"></pre>').text(c).appendTo(b);var e=$('<span class="debug-message-buffer-opts"></span>').appendTo(x),g=$('<a href="#"></a>').addClass("selected").html("raw").appendTo(e).click(function(a){a.preventDefault(),a.stopPropagation(),h(z,$(this),q,p,!0)});h(z,g,q,p,!1)}var j;if(J<=10)for(t=0;t<J;t++)j=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(K),i(H[t],""+t,"buffer"===I&&"hex",!1,p+"["+t+"]",q,r,s).appendTo(j);else{for(t=0;t<J;t+=10){var l=t;j=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(K),w=$("<span></span>").appendTo(j),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(w),d(w,function(){var a=l,b=Math.min(J-1,l+9),c=j;return function(){for(var d=a;d<=b;d++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(c);i(H[d],""+d,"buffer"===I&&"hex",!1,p+"["+d+"]",q,r,s).appendTo(e)}}}(),f(y,s,l,Math.min(J-1,l+9))),$('<span class="debug-message-object-key"></span>').html("["+l+" &hellip; "+Math.min(J-1,l+9)+"]").appendTo(w)}J<F&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+J+" &hellip; "+F+"]</span></div>").appendTo(K)}},f(y,s))}else if("object"==typeof j){z.addClass("collapsed");var M=Object.keys(j);if((k||M.length>0)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(w),d(w,function(){for(k||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html("object").appendTo(w),t=0;t<M.length;t++){var a=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(z),b=p;b+=/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(M[t])?(b.length>0?".":"")+M[t]:'["'+M[t].replace(/"/,'\\"')+'"]',i(j[M[t]],M[t],!1,!1,b,q,r,s).appendTo(a)}0===M.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(z)},f(y,s))),k)$('<span class="debug-message-type-meta"></span>').html("object").appendTo(v);else{x=$('<span class="debug-message-object-header"></span>').appendTo(v),$("<span>{ </span>").appendTo(x);var N=Math.min(M.length,5);for(t=0;t<N;t++)$('<span class="debug-message-object-key"></span>').text(M[t]).appendTo(x),$("<span>: </span>").appendTo(x),c(j[M[t]]).appendTo(x),t<N-1&&$("<span>, </span>").appendTo(x);M.length>N&&$("<span> &hellip;</span>").appendTo(x),0===N&&$('<span class="debug-message-type-meta">empty</span>').appendTo(x),$("<span> }</span>").appendTo(x)}}else $('<span class="debug-message-type-other"></span>').text(""+j).appendTo(v);return z}function j(a){var b=a.length;if(0===b)throw new Error("Invalid property expression: zero-length");for(var c,d,e=[],f=0,g=!1,h=!1,i=0;i<b;i++){var j=a[i];if(g){if(j===c){if(i-f===0)throw new Error("Invalid property expression: zero-length string at position "+f);if(e.push(a.substring(f,i)),h&&!/\]/.test(a[i+1]))throw new Error("Invalid property expression: unexpected array expression at position "+f);if(!h&&i+1!==b&&!/[\[\.]/.test(a[i+1]))throw new Error("Invalid property expression: unexpected "+a[i+1]+" expression at position "+(i+1));f=i+1,g=!1}}else if("'"===j||'"'===j){if(i!=f)throw new Error("Invalid property expression: unexpected "+j+" at position "+i);g=!0,c=j,f=i+1}else if("."===j){if(0===i)throw new Error("Invalid property expression: unexpected . at position 0");if(f!=i&&(d=a.substring(f,i),/^\d+$/.test(d)?e.push(parseInt(d)):e.push(d)),i===b-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(a[i+1]))throw new Error("Invalid property expression: unexpected "+a[i+1]+" at position "+(i+1));f=i+1}else if("["===j){if(0===i)throw new Error("Invalid property expression: unexpected "+j+" at position "+i);if(f!=i&&e.push(a.substring(f,i)),i===b-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(a[i+1]))throw new Error("Invalid property expression: unexpected "+a[i+1]+" at position "+(i+1));f=i+1,h=!0}else if("]"===j){if(!h)throw new Error("Invalid property expression: unexpected "+j+" at position "+i);if(f!=i){if(d=a.substring(f,i),!/^\d+$/.test(d))throw new Error("Invalid property expression: unexpected array expression at position "+f);e.push(parseInt(d))}f=i+1,h=!1}else if(" "===j)throw new Error("Invalid property expression: unexpected ' ' at position "+i)}if(h||g)throw new Error("Invalid property expression: unterminated expression");return f<b&&e.push(a.substring(f)),e}function k(a){try{j(a);return!0}catch(a){return!1}}function l(a,b){var c,d=null;"string"==typeof b?(0===b.indexOf("msg.")&&(b=b.substring(4)),c=j(b)):c=b;return c.reduce(function(a,b){return d="undefined"!=typeof a[b]?a[b]:void 0,void 0===d&&a.hasOwnProperty("type")&&a.hasOwnProperty("data")&&a.hasOwnProperty("length")&&(d="undefined"!=typeof a.data[b]?a.data[b]:void 0),d},a),d}function m(a,b){if("config"===a.category)return"icons/node-red/cog.png";if(b&&"tab"===b.type)return"icons/node-red/subflow.png";if(b&&"unknown"===b.type)return"icons/node-red/alert.png";var c;if("function"==typeof a.icon)try{c=a.icon.call(b)}catch(b){console.log("Definition error: "+a.type+".icon",b),c="arrow-in.png"}else c=a.icon;return"icons/"+a.namespace+"/"+c}function n(a,b){b=b||"";var c;if("tab"===a.type)c=a.label||b;else{c=a._def.label;try{c=("function"==typeof c?c.call(a):c)||b}catch(d){console.log("Definition error: "+a.type+".label",d),c=b}}return RED.text.bidi.enforceTextDirectionWithUCC(c)}var o={},p={};return{createObjectElement:i,getMessageProperty:l,normalisePropertyExpression:j,validatePropertyExpression:k,getNodeIcon:m,getNodeLabel:n}}(),function(a){a.widget("nodered.editableList",{_create:function(){var b=this;if(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),this.options.addButton!==!1){var c;c="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",a('<a href="#" class="editor-button editor-button-small" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+c+"</a>").appendTo(this.topContainer).click(function(a){a.preventDefault(),b.addItem({})})}"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(a){var c=b.element.css(a);"auto"!==a&&""!==a&&(b.topContainer.css(a,c),b.uiContainer.css(a,"0"),b.element.css(a,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var d=this.element.css("minHeight");"0px"!==d&&(this.uiContainer.css("minHeight",d),this.element.css("minHeight",0)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),
isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var e,f=this.element.attr("style");if(null!==(e=/width\s*:\s*(\d+%)/i.exec(f))&&(this.element.width("100%"),this.uiContainer.width(e[1])),this.options.sortable){var g="string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",h={axis:"y",update:function(a,c){b.options.sortItems&&b.options.sortItems(b.items())},handle:g,cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(a,b){b.placeholder.height(b.item.height()-4)}};this.options.connectWith&&(h.connectWith=this.options.connectWith),this.element.sortable(h)}this._resize()},_resize:function(){var b=this.topContainer.height(),c=this.uiContainer.height(),d=b-c;if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-d),this.options.resize&&this.options.resize(),this.options.resizeItem){var e=this;this.element.children().each(function(b){e.options.resizeItem(a(this).find(".red-ui-editableList-item-content"),b)})}},_destroy:function(){},_refreshFilter:function(){var a=this,b=0;if(!this.activeFilter)return this.element.children().show();var c=this.items();return c.each(function(c,d){var e=d.data("data");try{a.activeFilter(e)?(d.parent().show(),b++):d.parent().hide()}catch(a){console.log(a),d.parent().show(),b++}}),b},_refreshSort:function(){if(this.activeSort){var b=this.element.children(),c=this;b.sort(function(b,d){return c.activeSort(a(b).find(".red-ui-editableList-item-content").data("data"),a(d).find(".red-ui-editableList-item-content").data("data"))}),a.each(b,function(a,b){c.element.append(b)})}},width:function(a){this.uiWidth=a,this._resize()},height:function(a){this.uiHeight=a,this._resize()},addItem:function(b){var c=this;b=b||{};var d=a("<li>"),e=!1;if(this.activeSort){var f=this.items();f.each(function(a,f){if(!e){var g=f.data("data");c.activeSort(b,g)<0&&(d.insertBefore(f.closest("li")),e=!0)}})}e||d.appendTo(this.element);var g=a("<div/>").addClass("red-ui-editableList-item-content").appendTo(d);if(g.data("data",b),this.options.sortable===!0&&(a('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(d),d.addClass("red-ui-editableList-item-sortable")),this.options.removable){var h=a("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(d);a("<i/>",{class:"fa fa-remove"}).appendTo(h),d.addClass("red-ui-editableList-item-removable"),h.click(function(b){b.preventDefault();var e=g.data("data");d.addClass("red-ui-editableList-item-deleting"),d.fadeOut(300,function(){a(this).remove(),c.options.removeItem&&c.options.removeItem(e)})})}if(this.options.addItem){var i=c.element.children().length-1;setTimeout(function(){if(c.options.addItem(g,i,b),c.activeFilter)try{c.activeFilter(b)||d.hide()}catch(a){}!c.activeSort&&c.scrollOnAdd&&setTimeout(function(){c.uiContainer.scrollTop(c.element.height())},0)},0)}},addItems:function(a){for(var b=0;b<a.length;b++)this.addItem(a[b])},removeItem:function(b){var c=this.element.children().filter(function(c){return b===a(this).find(".red-ui-editableList-item-content").data("data")});c.remove(),this.options.removeItem&&this.options.removeItem(b)},items:function(){return this.element.children().map(function(b){return a(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(a){return void 0!==a&&(this.activeFilter=a),this._refreshFilter()},sort:function(a){return void 0!==a&&(this.activeSort=a),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(a){a.widget("nodered.checkboxSet",{_create:function(){var b=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var c=this.element.prop("checked");this.options=[a('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),a('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),a('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],c?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(b.options[0].hide(),b.options[1].show(),b.options[2].hide()):(b.options[1].hide(),b.options[0].show(),b.options[2].hide());var a=this.checked;b.children.forEach(function(b){b.checkboxSet("state",a,!1,!0)})}),this.uiElement.click(function(a){a.stopPropagation(),b.state(b.state()===!1)}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(a){this.children.push(a)},removeChild:function(a){var b=this.children.indexOf(a);b>-1&&this.children.splice(b,1)},updateChild:function(a){var b=0;this.children.forEach(function(a,c){a.checkboxSet("state")===!0&&b++}),0===b?this.state(!1,!0):b===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(a,b,c){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===a;var d=this.partialFlag||a;this.element.prop("checked",d),a===!0?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):a===!1?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===a&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),b||this.element.trigger("change",null),!c&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){function a(b){function f(){var a=RED.settings.get("menu-"+b.id);b.setting&&(null!==a?(RED.settings.set(b.setting,a),RED.settings.remove("menu-"+b.id)):a=RED.settings.get(b.setting)),a?(j.addClass("active"),c(b.id,!0)):a===!1?(j.removeClass("active"),c(b.id,!1)):b.hasOwnProperty("selected")&&(b.selected?j.addClass("active"):j.removeClass("active"),c(b.id,b.selected))}var g;if(null!==b&&b.id){var h=RED.settings.theme("menu."+b.id);if(h===!1)return null}if(null===b)g=$('<li class="divider"></li>');else{g=$("<li></li>"),b.group&&g.addClass("menu-group-"+b.group);var i="<a "+(b.id?'id="'+b.id+'" ':"")+'tabindex="-1" href="#">';b.toggle&&(i+='<i class="fa fa-square pull-left"></i>',i+='<i class="fa fa-check-square pull-left"></i>'),void 0!==b.icon&&(i+=/\.png/.test(b.icon)?'<img src="'+b.icon+'"/> ':'<i class="'+(b.icon?b.icon:'" style="display: inline-block;"')+'"></i> '),i+=b.sublabel?'<span class="menu-label-container"><span class="menu-label">'+b.label+'</span><span class="menu-sublabel">'+b.sublabel+"</span></span>":'<span class="menu-label">'+b.label+"</span>",i+="</a>";var j=$(i).appendTo(g);if(k[b.id]=b,b.onselect?(j.click(function(a){if(a.preventDefault(),!$(this).parent().hasClass("disabled"))if(b.toggle){var f=d(b.id);if("string"==typeof b.toggle){if(!f){for(var g in k)if(k.hasOwnProperty(g)){var h=k[g];h.id!=b.id&&b.toggle==h.toggle&&e(h.id,!1)}e(b.id,!0)}}else e(b.id,!f)}else c(b.id)}),b.toggle&&f()):b.href?j.attr("target","_blank").attr("href",b.href):b.options||(g.addClass("disabled"),j.click(function(a){a.preventDefault()})),b.options){g.addClass("dropdown-submenu pull-left");for(var l=$('<ul id="'+b.id+'-submenu" class="dropdown-menu"></ul>').appendTo(g),m=0;m<b.options.length;m++){var n=a(b.options[m]);n&&n.appendTo(l)}}b.disabled&&g.addClass("disabled")}return g}function b(b){var c=$("#"+b.id),d=$("<ul/>",{id:b.id+"-submenu",class:"dropdown-menu pull-right"});1===c.length&&d.insertAfter(c);for(var e=!1,f=0;f<b.options.length;f++){var g=b.options[f];if(null!==g||!e){var h=a(g);h&&(h.appendTo(d),e=null===g)}}return d}function c(a,b){var c=k[a],d=c.onselect;"string"==typeof c.onselect&&(d=RED.actions.get(c.onselect)),d?d.call(c,b):console.log("No callback for",a,c.onselect)}function d(a){return $("#"+a).hasClass("active")}function e(a,b){if(d(a)!=b){var e=k[a];b?$("#"+a).addClass("active"):$("#"+a).removeClass("active"),e&&e.onselect&&c(e.id,b),RED.settings.set(e.setting||"menu-"+e.id,b)}}function f(a){e(a,!d(a))}function g(a,b){b?$("#"+a).parent().addClass("disabled"):$("#"+a).parent().removeClass("disabled")}function h(b,c){var d=a(c);if(c.group){var e=$("#"+b+"-submenu").children(".menu-group-"+c.group);if(0===e.length)d.appendTo("#"+b+"-submenu");else{for(var f=0;f<e.length;f++){var g=e[f],h=$(g).find(".menu-label").html();if(c.label<h){$(g).before(d);break}}f===e.length&&d.appendTo("#"+b+"-submenu")}}else d.appendTo("#"+b+"-submenu")}function i(a){$("#"+a).parent().remove()}function j(a,b){var c=k[a];c&&(c.onselect=b)}var k={};return{init:b,setSelected:e,isSelected:d,toggleSelected:f,setDisabled:g,addItem:h,removeItem:i,setAction:j}}(),RED.panels=function(){function a(a){var b=a.container||$("#"+a.id),c=b.children();if(2!==c.length)throw new Error("Container must have exactly two children");b.addClass("red-ui-panels");var d,e,f=$('<div class="red-ui-panels-separator"></div>').insertAfter(c[0]),g=[],h=!1;return f.draggable({axis:"y",containment:b,scroll:!1,start:function(a,e){var f=b.height();d=e.position.top,g=[$(c[0]).height(),$(c[1]).height()],console.log("START",f,g,g[0]+g[1],f-(g[0]+g[1]))},drag:function(f,h){var i=b.height(),j=h.position.top-d,k=[g[0]+j,g[1]-j];$(c[0]).height(k[0]),$(c[1]).height(k[1]),a.resize&&a.resize(k[0],k[1]),h.position.top-=j,e=k[0]/i},stop:function(a,b){h=!0}}),{resize:function(d){var f=[$(c[0]).height(),$(c[1]).height()];if(b.height(d),h){var g=e*d,i=d-g-48;f=[g,i],$(c[0]).height(f[0]),$(c[1]).height(f[1]),console.log("SET",d,f,f[0]+f[1],d-(f[0]+f[1]))}a.resize&&a.resize(f[0],f[1])}}}return{create:a}}(),RED.popover=function(){function a(a){var c=a.target,d=a.direction||"right",e=a.trigger,f=a.content,g=a.delay,h=a.width||"auto",i=a.size||"default",j=a.offsetX||0,k=a.offsetY||0;if(!b[i])throw new Error("Invalid RED.popover size value:",i);var l,m,n=null,o=function(){if(l){m=$('<div class="red-ui-popover red-ui-popover-'+d+'"></div>').appendTo("body"),"default"!==i&&m.addClass("red-ui-popover-size-"+i),"function"==typeof f?f.call(q).appendTo(m):m.html(f),"auto"!==h&&m.width(h);var a=c.offset();a.top+=k,a.left+=j;var e=c.width(),g=c.height(),n=m.height(),o=m.width();"right"===d?m.css({top:a.top+g/2-n/2-b[i].top,left:a.left+e+b[i].leftRight}):"left"===d&&m.css({top:a.top+g/2-n/2-b[i].top,left:a.left-b[i].leftLeft-o}),m.fadeIn("fast")}},p=function(){l||m&&(m.fadeOut("fast",function(){$(this).remove()}),m=null)};"hover"===e?(c.on("mouseenter",function(a){clearTimeout(n),l=!0,n=setTimeout(o,g.show)}),c.on("mouseleave",function(a){n&&clearTimeout(n),l=!1,setTimeout(p,g.hide)})):"click"===e&&c.click(function(a){a.preventDefault(),a.stopPropagation(),l=!l,l?o():p()});var q={setContent:function(a){f=a},open:function(){l=!0,o()},close:function(){l=!1,p()}};return q}var b={default:{top:10,leftRight:17,leftLeft:25},small:{top:5,leftRight:8,leftLeft:16}};return{create:a}}(),function(a){a.widget("nodered.searchBox",{_create:function(){var b=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),a('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=a('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(a){a.preventDefault(),b.element.val(""),b._change("",!0),b.element.focus()}),this.resultCount=a("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(a){27===a.keyCode&&b.element.val("")}),this.element.on("keyup",function(c){b._change(a(this).val())}),this.element.on("focus",function(){a("body").one("mousedown",function(){b.element.blur()})})},_change:function(a,b){var c=!1;""===a?(this.clearButton.hide(),c=!0):(this.clearButton.show(),c=a.length>=(this.options.minimumLength||0));var d=this.element.val();if(c=c&&d!==this.lastSent)if(!b&&this.options.delay>0){clearTimeout(this.currentTimeout);var e=this;this.currentTimeout=setTimeout(function(){e.lastSent=e.element.val(),e._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(a){return void 0===a?this.element.val():(this.element.val(a),void this._change(a))},count:function(a){void 0===a||null===a||""===a?this.resultCount.text("").hide():this.resultCount.text(a).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){function a(a){function b(a,b){if(a.preventDefault(),!$(this).hasClass("disabled")){var c=p.scrollLeft();p.animate({scrollLeft:b},100);var d=setInterval(function(){var a=p.scrollLeft();return a===c?void clearInterval(d):(c=a,void p.animate({scrollLeft:b},100))},100);$(this).one("mouseup",function(){clearInterval(d)})}}function c(){return a.onclick&&a.onclick(l[$(this).attr("href").slice(1)]),f($(this)),!1}function d(){if(0!==n.children().length){var a=p.scrollLeft(),b=p.width(),c=n.width();0===a?r.hide():r.show(),a===c-b?s.hide():s.show()}}function e(){return a.ondblclick&&a.ondblclick(l[$(this).attr("href").slice(1)]),!1}function f(b){if("string"==typeof b&&(b=n.find("a[href='#"+b+"']")),0!==b.length&&!b.parent().hasClass("active")){if(n.children().removeClass("active"),n.children().css({transition:"width 100ms"}),b.parent().addClass("active"),a.scrollable){var c=b.parent().position().left;c-21<0?p.animate({scrollLeft:"+="+(c-50)},300):c+120>p.width()&&p.animate({scrollLeft:"+="+(c+140-p.width())},300)}a.onchange&&a.onchange(l[b.attr("href").slice(1)]),i(),setTimeout(function(){n.children().css({transition:""})},100)}}function g(){var a=n.find("li.active").prev();a.length>0&&f(a.find("a"))}function h(){var a=n.find("li.active").next();a.length>0&&f(a.find("a"))}function i(){if(!a.vertical){var b=n.find("li.red-ui-tab"),c=o.width(),e=b.size(),f=(c-12-6*e)/e;if(k=100*f/c+"%",m=k+"%",a.scrollable){f=Math.max(f,140),k=f+"px",m=0;var g=Math.max(o.width(),12+(f+6)*e);n.width(g),d()}else a.hasOwnProperty("minimumActiveTabWidth")&&(f<a.minimumActiveTabWidth?(e-=1,f=(c-12-a.minimumActiveTabWidth-6*e)/e,k=100*f/c+"%",m=a.minimumActiveTabWidth+"px"):m=0);b.css({width:k}),f<50?(n.find(".red-ui-tab-close").hide(),n.find(".red-ui-tab-icon").hide(),n.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,f-38))+"px"})):(n.find(".red-ui-tab-close").show(),n.find(".red-ui-tab-icon").show(),n.find(".red-ui-tab-label").css({paddingLeft:""})),0!==m&&(n.find("li.red-ui-tab.active").css({width:a.minimumActiveTabWidth}),n.find("li.red-ui-tab.active .red-ui-tab-close").show(),n.find("li.red-ui-tab.active .red-ui-tab-icon").show(),n.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function j(b){var c=n.find("a[href='#"+b+"']").parent();if(c.hasClass("active")){var d=c.prev();0===d.size()&&(d=c.next()),f(d.find("a"))}c.remove(),a.onremove&&a.onremove(l[b]),delete l[b],i()}var k,l={},m=0,n=a.element||$("#"+a.id),o=n.wrap("<div>").parent(),p=n.wrap("<div>").parent();if(o.addClass("red-ui-tabs"),a.vertical&&o.addClass("red-ui-tabs-vertical"),a.addButton&&"function"==typeof a.addButton){o.addClass("red-ui-tabs-add");var q=$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(o);q.find("a").click(function(b){b.preventDefault(),a.addButton()})}var r,s;return a.scrollable&&(o.addClass("red-ui-tabs-scrollable"),p.addClass("red-ui-tabs-scroll-container"),p.scroll(d),r=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(o).find("a"),r.on("mousedown",function(a){b(a,"-=150")}).on("click",function(a){a.preventDefault()}),s=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(o).find("a"),s.on("mousedown",function(a){b(a,"+=150")}).on("click",function(a){a.preventDefault()})),n.children().first().addClass("active"),n.children().addClass("red-ui-tab"),n.find("li.red-ui-tab a").on("click",c).on("dblclick",e),setTimeout(function(){i()},0),{addTab:function(b){l[b.id]=b;var d=$("<li/>",{class:"red-ui-tab"}).appendTo(n);d.attr("id","red-ui-tab-"+b.id.replace(".","-")),d.data("tabId",b.id);var g=$("<a/>",{href:"#"+b.id,class:"red-ui-tab-label"}).appendTo(d);b.icon&&$('<img src="'+b.icon+'" class="red-ui-tab-icon"/>').appendTo(g);var h=$("<span/>",{class:"bidiAware"}).text(b.label).appendTo(g);if(h.attr("dir",RED.text.bidi.resolveBaseTextDir(b.label)),g.on("click",c),g.on("dblclick",e),b.closeable){var k=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(d);k.append('<i class="fa fa-times" />'),k.on("click",function(a){a.preventDefault(),j(b.id)})}if(i(),a.onadd&&a.onadd(b),g.attr("title",b.label),1==n.find("li.red-ui-tab").size()&&f(g),a.onreorder){var m,o,q,r=[];d.draggable({axis:"x",distance:20,start:function(a,b){m=[],r=[],n.children().each(function(a){r[a]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(d)&&(o=a,q=a),m.push($(this).data("tabId"))}),n.children().each(function(a){a!==o&&$(this).css({position:"absolute",left:r[a].left+"px",width:r[a].width+2,transition:"left 0.3s"})}),d.hasClass("active")||d.css({zIndex:1})},drag:function(a,b){b.position.left+=r[o].left+p.scrollLeft();for(var c=b.position.left+r[o].width/2-p.scrollLeft(),d=0;d<r.length;d++)if(d!==o&&c>r[d].left&&c<r[d].left+r[d].width){d<o?(r[d].left+=r[o].width+8,r[o].el.detach().insertBefore(r[d].el)):(r[d].left-=r[o].width+8,r[o].el.detach().insertAfter(r[d].el)),r[d].el.css({left:r[d].left+"px"}),r.splice(d,0,r.splice(o,1)[0]),o=d;break}},stop:function(b,c){n.children().css({position:"relative",left:"",transition:""}),d.hasClass("active")||d.css({zIndex:""}),i(),q!==o&&a.onreorder(m,$.makeArray(n.children().map(function(){return $(this).data("tabId")}))),f(r[o].el.data("tabId"))}})}},removeTab:j,activateTab:f,nextTab:h,previousTab:g,resize:i,count:function(){return n.find("li.red-ui-tab").size()},contains:function(a){return n.find("a[href='#"+a+"']").length>0},renameTab:function(a,b){l[a].label=b;var c=n.find("a[href='#"+a+"']");c.attr("title",b),c.find("span.bidiAware").text(b).attr("dir",RED.text.bidi.resolveBaseTextDir(b)),i()},order:function(a){var b=$.makeArray(n.children().map(function(){return $(this).data("tabId")}));if(b.length===a.length){var c,d=!0;for(c=0;c<a.length;c++)if(a[c]!==b[c]){d=!1;break}if(!d){var e={};n.children().detach().each(function(){e[$(this).data("tabId")]=$(this)});for(c=0;c<a.length;c++)e[a[c]].appendTo(n)}}}}}return{create:a}}(),RED.stack=function(){function a(a){var b=a.container,c=[],d=!0;return{add:function(e){c.push(e),e.container=$('<div class="palette-category">').appendTo(b),d||e.container.hide();var f=$('<div class="palette-header"></div>').appendTo(e.container);if(e.content=$("<div></div>").appendTo(e.container),e.collapsible!==!1){f.click(function(){if(a.singleExpanded){if(!e.isExpanded()){for(var b=0;b<c.length;b++)c[b].isExpanded()&&c[b].collapse();e.expand()}}else e.toggle()});var g=$('<i class="fa fa-angle-down"></i>').appendTo(f);e.expanded?g.addClass("expanded"):e.content.hide()}else f.css("cursor","default");return e.title=$("<span></span>").html(e.title).appendTo(f),e.toggle=function(){return e.isExpanded()?(e.collapse(),!1):(e.expand(),!0)},e.expand=function(){if(!e.isExpanded())return e.onexpand&&e.onexpand.call(e),g.addClass("expanded"),e.content.slideDown(200),!0},e.collapse=function(){if(e.isExpanded())return g.removeClass("expanded"),e.content.slideUp(200),!0},e.isExpanded=function(){return g.hasClass("expanded")},e},hide:function(){return d=!1,c.forEach(function(a){a.container.hide()}),this},show:function(){return d=!0,c.forEach(function(a){a.container.show()}),this}}}return{create:a}}(),function(a){var b={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",validate:RED.utils.validatePropertyExpression},global:{value:"global",label:"global.",validate:RED.utils.validatePropertyExpression},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(a){try{return JSON.parse(a),!0}catch(a){return!1}},expand:function(){var a=this,b=this.value();try{b=JSON.stringify(JSON.parse(b),null,4)}catch(a){}RED.editor.editJSON({value:b,complete:function(b){var c=b;try{c=JSON.stringify(JSON.parse(b))}catch(a){}a.value(c)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(a){try{return jsonata(a),!0}catch(a){return!1}},expand:function(){var a=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(b){a.value(b.replace(/\n/g,"\t"))}})}}},c=!1;a.widget("nodered.typedInput",{_create:function(){if(!c&&RED&&RED._)for(var d in b)b.hasOwnProperty(d)&&(b[d].label=RED._("typedInput.type."+d,{defaultValue:b[d].label}));c=!0;var e=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var f,g=this.element.attr("style");if(null!==(f=/width\s*:\s*(\d+(%|px))/i.exec(g))?(this.element.css("width","100%"),this.uiSelect.width(f[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(a){var b=e.element.css("margin"+a);e.uiSelect.css("margin"+a,b),e.element.css("margin"+a,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(b),this.selectTrigger=a('<button tabindex="0"></button>').prependTo(this.uiSelect),a('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=a("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=a(this.options.typeField).hide();var h=this.typeField.val();h&&this.typeMap[h]&&(this.options.default=h)}else this.typeField=a("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){e.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){e.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){e.validate()}),this.selectTrigger.click(function(a){a.preventDefault(),e._showTypeMenu()}),this.selectTrigger.on("keydown",function(a){40===a.keyCode&&e._showTypeMenu()}).on("focus",function(){e.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=a('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=a('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(a){a.preventDefault(),e._showOptionSelectMenu()}).on("keydown",function(a){40===a.keyCode&&e._showOptionSelectMenu()}).on("blur",function(){e.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){e.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=a('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)},_showTypeMenu:function(){this.typeList.length>1?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.element.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectLabel);var a=this.optionMenu.find("[value='"+this.value()+"']");0===a.length&&(a=this.optionMenu.children(":first")),a.focus()}},_hideMenu:function(b){a(document).off("mousedown.close-property-select"),b.hide(),this.elementDiv.is(":visible")?this.element.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(b,c){var d=this,e=a("<div>").addClass("red-ui-typedInput-options");return b.forEach(function(b){"string"==typeof b&&(b={value:b,label:b});var f=a('<a href="#"></a>').attr("value",b.value).appendTo(e);b.label&&f.text(b.label),b.icon?a("<img>",{src:b.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(f):f.css({paddingLeft:"18px"}),f.click(function(a){a.preventDefault(),c(b.value),d._hideMenu(e)})}),e.css({display:"none"}),e.appendTo(document.body),e.on("keydown",function(b){40===b.keyCode?a(this).children(":focus").next().focus():38===b.keyCode?a(this).children(":focus").prev().focus():27===b.keyCode&&d._hideMenu(e)}),e},_showMenu:function(b,c){if(this.disarmClick)return void(this.disarmClick=!1);var d=this,e=c.offset(),f=c.height(),g=b.height(),h=f+e.top-3;h+g>a(window).height()&&(h-=h+g-a(window).height()+5),b.css({top:h+"px",left:2+e.left+"px"}),b.slideDown(100),this._delay(function(){d.uiSelect.addClass("red-ui-typedInput-focus"),a(document).on("mousedown.close-property-select",function(e){a(e.target).closest(b).length||d._hideMenu(b),a(e.target).closest(c).length&&(d.disarmClick=!0,e.preventDefault())})})},_getLabelWidth:function(b){var c=b.outerWidth();if(0===c){var d=a('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body),e=b.clone().appendTo(d);c=e.outerWidth(),d.remove()}return c},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&this.typeMap[this.propertyType].hasValue===!1)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var a=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",a+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):this.elementDiv.css("right","0"),this.optionSelectTrigger&&this.optionSelectTrigger.css({left:a+"px",width:"calc( 100% - "+a+"px )"})}},_destroy:function(){this.menu.remove()},types:function(a){var c=this,d=this.type();this.typeMap={},this.typeList=a.map(function(a){var d;return d="string"==typeof a?b[a]:a,c.typeMap[d.value]=d,d}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(a){c.type(a)}),d&&!this.typeMap.hasOwnProperty(d)&&this.type(this.typeList[0].value)},width:function(a){this.uiWidth=a,this._resize()},value:function(a){return arguments.length?(this.typeMap[this.propertyType].options&&(this.typeMap[this.propertyType].options.indexOf(a)===-1&&(a=""),this.optionSelectLabel.text(a)),this.element.val(a),this.element.trigger("change",this.type(),a),void 0):this.element.val()},type:function(b){if(!arguments.length)return this.propertyType;var c=this,d=this.typeMap[b];if(d&&this.propertyType!==b){this.propertyType=b,this.typeField.val(b),this.selectLabel.empty();var e;if(d.icon?(e=new Image,e.name=d.icon,e.src=d.icon,a("<img>",{src:d.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(d.label),d.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(d.options,function(a){c.optionSelectLabel.text(a),c.value(a)});var f=this.element.val();d.options.indexOf(f)!==-1?this.optionSelectLabel.text(f):this.value(d.options[0])}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),d.hasValue===!1?(this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.element.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),d.expand&&"function"==typeof d.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(a){a.preventDefault(),d.expand.call(c)})):this.optionExpandButton.hide(),this.element.trigger("change",this.propertyType,this.value());e?(e.onload=function(){c._resize()},e.onerror=function(){c._resize()}):this._resize()}},validate:function(){var a,b=this.value(),c=this.type();if(this.typeMap[c]&&this.typeMap[c].validate){var d=this.typeMap[c].validate;a="function"==typeof d?d(b):d.test(b)}else a=!0;return a?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),a},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){function a(a,b){f[a]=b}function b(a){delete f[a]}function c(a){return f[a]}function d(a){f.hasOwnProperty(a)&&f[a]()}function e(){var a=[];return Object.keys(f).forEach(function(b){var c=RED.keyboard.getShortcut(b);a.push({id:b,scope:c?c.scope:void 0,key:c?c.key:void 0,user:c?c.user:void 0})}),a}var f={};return{add:a,remove:b,get:c,invoke:d,list:e}}(),RED.deploy=function(){function a(a){i=a,$("#btn-deploy-icon").attr("src",g[a].img)}function b(b){b=b||{};var c=b.type||"default";if("default"==c)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(b){b&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(b){b&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(b){b&&a("nodes")}}]});else if("simple"==c){var d=b.label||RED._("deploy.deploy"),g="red/images/deploy-full-o.png";b.hasOwnProperty("icon")&&(g=b.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(g?'<img id="btn-deploy-icon" src="'+g+'"> ':"")+"<span>"+d+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(a){a.preventDefault(),f()}),RED.actions.add("core:deploy-flows",f),$("#node-dialog-confirm-deploy").dialog({title:RED._("deploy.confirm.button.confirm"),modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),$(this).dialog("close"))}},{id:"node-dialog-confirm-deploy-merge",
text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){RED.diff.mergeDiff(k),$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){var a=$("#node-dialog-confirm-deploy-hide").prop("checked");a&&(h[$("#node-dialog-confirm-deploy-type").val()]=!0),f(!0,/conflict/.test($("#node-dialog-confirm-deploy-type").val())),$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){f(!0,/conflict/.test($("#node-dialog-confirm-deploy-type").val())),$(this).dialog("close")}}],create:function(){$("#node-dialog-confirm-deploy").parent().find("div.ui-dialog-buttonpane").prepend('<div style="height:0; vertical-align: middle; display:inline-block; margin-top: 13px; float:left;"><input style="vertical-align:top;" type="checkbox" id="node-dialog-confirm-deploy-hide"><label style="display:inline;" for="node-dialog-confirm-deploy-hide"> do not warn about this again</label><input type="hidden" id="node-dialog-confirm-deploy-type"></div>')},open:function(){var a=$("#node-dialog-confirm-deploy-type").val();if(/conflict/.test(a)){$("#node-dialog-confirm-deploy").dialog("option","title",RED._("deploy.confirm.button.review")),$("#node-dialog-confirm-deploy-deploy").hide(),$("#node-dialog-confirm-deploy-review").addClass("disabled").show(),$("#node-dialog-confirm-deploy-merge").addClass("disabled").show(),$("#node-dialog-confirm-deploy-overwrite").toggle("deploy-conflict"===a),k=null,$("#node-dialog-confirm-deploy-conflict-checking").show(),$("#node-dialog-confirm-deploy-conflict-auto-merge").hide(),$("#node-dialog-confirm-deploy-conflict-manual-merge").hide();var b=Date.now();RED.diff.getRemoteDiff(function(a){var c=Math.max(1e3-(Date.now()-b),0);k=a,setTimeout(function(){$("#node-dialog-confirm-deploy-conflict-checking").hide();var b=Object.keys(a.conflicts);0===b.length?($("#node-dialog-confirm-deploy-conflict-auto-merge").show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):$("#node-dialog-confirm-deploy-conflict-manual-merge").show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},c)}),$("#node-dialog-confirm-deploy-hide").parent().hide()}else $("#node-dialog-confirm-deploy").dialog("option","title",RED._("deploy.confirm.button.confirm")),$("#node-dialog-confirm-deploy-deploy").show(),$("#node-dialog-confirm-deploy-overwrite").hide(),$("#node-dialog-confirm-deploy-review").hide(),$("#node-dialog-confirm-deploy-merge").hide(),$("#node-dialog-confirm-deploy-hide").parent().show()}}),RED.events.on("nodes:change",function(a){a.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))});var i;RED.comms.subscribe("notification/runtime-deploy",function(a,b){if(!i){var c=RED.nodes.version();if(null===c||j||c===b.revision)return;var d=$("<div>"+RED._("deploy.confirm.backgroundUpdate")+'<br><br><div class="ui-dialog-buttonset"><button>'+RED._("deploy.confirm.button.ignore")+'</button><button class="primary">'+RED._("deploy.confirm.button.review")+"</button></div></div>");$(d.find("button")[0]).click(function(a){a.preventDefault(),i.close(),i=null}),$(d.find("button")[1]).click(function(a){a.preventDefault(),i.close();var b=RED.nodes.createCompleteNodeSet();e(b,!1),i=null}),i=RED.notify(d,null,!0)}})}function c(a){var b="";if(a.z){var c=RED.nodes.workspace(a.z);c?b=c.label:(c=RED.nodes.subflow(a.z),b=c.name)}var d=RED.utils.getNodeLabel(a,a.id);return{tab:b,type:a.type,label:d}}function d(a,b){return a.tab<b.tab?-1:a.tab>b.tab?1:a.type<b.type?-1:a.type>b.type?1:a.name<b.name?-1:a.name>b.name?1:0}function e(a,b){$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").show(),$("#node-dialog-confirm-deploy-type").val(b?"deploy-conflict":"background-conflict"),$("#node-dialog-confirm-deploy").dialog("open")}function f(a,b){if(!$("#btn-deploy").hasClass("disabled")){if(!a){var f=!1,g=!1,k=!1,l=[],m=[];RED.nodes.eachNode(function(a){g=g||!a.valid,a.valid||m.push(c(a)),"unknown"===a.type&&l.indexOf(a.name)==-1&&l.push(a.name)}),f=l.length>0;var n=[];RED.nodes.eachConfig(function(a){0===a.users.length&&a._def.hasUsers!==!1&&(n.push(c(a)),k=!0)}),$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").hide();var o=!1;if(f&&!h.unknown?(o=!0,$("#node-dialog-confirm-deploy-type").val("unknown"),$("#node-dialog-confirm-deploy-unknown").show(),$("#node-dialog-confirm-deploy-unknown-list").html("<li>"+l.join("</li><li>")+"</li>")):g&&!h.invalid?(o=!0,$("#node-dialog-confirm-deploy-type").val("invalid"),$("#node-dialog-confirm-deploy-config").show(),m.sort(d),$("#node-dialog-confirm-deploy-invalid-list").html("<li>"+m.map(function(a){return(a.tab?"["+a.tab+"] ":"")+a.label+" ("+a.type+")"}).join("</li><li>")+"</li>")):k&&!h.unusedConfig,o)return $("#node-dialog-confirm-deploy-hide").prop("checked",!1),void $("#node-dialog-confirm-deploy").dialog("open")}var p=RED.nodes.createCompleteNodeSet(),q=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var r={flows:p};b||(r.rev=RED.nodes.version()),j=!0,$.ajax({url:"flows",type:"POST",data:JSON.stringify(r),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":i}}).done(function(a,b,c){RED.nodes.dirty(!1),RED.nodes.version(a.rev),RED.nodes.originalFlow(p),k?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify(RED._("deploy.successfulDeploy"),"success"),RED.nodes.eachNode(function(a){a.changed&&(a.dirty=!0,a.changed=!1),a.credentials&&delete a.credentials}),RED.nodes.eachConfig(function(a){a.changed=!1,a.credentials&&delete a.credentials}),RED.nodes.eachWorkspace(function(a){a.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(a,b,c){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===a.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===a.status?e(p,!0):a.responseText?RED.notify(RED._("deploy.deployFailed",{message:a.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){j=!1;var a=Math.max(0,300-(Date.now()-q));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide()},a)})}}var g={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},h={unknown:!1,unusedConfig:!1,invalid:!1},i="full",j=!1,k=null;return{init:b}}(),RED.diff=function(){function a(){RED.actions.add("core:show-remote-diff",j),RED.keyboard.add("*","ctrl-shift-r","core:show-remote-diff");var a=$('<div id="node-dialog-view-diff" class="hide"><div id="node-dialog-view-diff-headers"></div><ol id="node-dialog-view-diff-diff"></ol></div>').appendTo(document.body);$('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(a);$("#node-dialog-view-diff").dialog({title:RED._("deploy.confirm.button.review"),modal:!0,autoOpen:!1,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(h(),o(p),$(this).dialog("close"))}}],open:function(){$(this).dialog({width:Math.min($(window).width(),900),height:Math.min($(window).height(),600)})}});$("#node-dialog-view-diff-diff").editableList({addButton:!1,scrollOnAdd:!1,addItem:function(a,b,d){var h=d.diff,i=d.remoteDiff,j=d.tab.n,k=d.def,l=p.conflicts,m=$("<div>",{class:"node-diff-tab"}).appendTo(a);m.addClass("collapsed");var n,o,q=$("<div>",{class:"node-diff-tab-title"}).appendTo(m),r=$("<div>").appendTo(m),s=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(q),t=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(q);i&&(n=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(q)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(s),c(j,k).appendTo(s);var u=(d.newTab||d.tab).n,v=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(s);"tab"===u.type?v.html(u.label||u.id):"subflow"===j.type?v.html(u.name||u.id):v.html("Global nodes");var w={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(d.newTab||d.remoteTab){var x,y={node:h.newConfig.all[j.id],all:h.newConfig.all,diff:h};if(i&&(x={node:i.newConfig.all[j.id]||null,all:i.newConfig.all,diff:i}),void 0!==j.type){var z=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(r),A=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(z),B=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(A),C=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(A),D=!1,E=!1;h.newConfig.all[j.id]?h.added[j.id]?(C.addClass("node-diff-node-added"),D=!0,$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(C)):h.changed[j.id]?(C.addClass("node-diff-node-changed"),D=!0,$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(C)):(C.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(C)):C.addClass("node-diff-empty");var F;i&&(F=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(A),i.newConfig.all[j.id]?i.added[j.id]?(F.addClass("node-diff-node-added"),E=!0,$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(F)):i.changed[j.id]?(F.addClass("node-diff-node-changed"),E=!0,$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(F)):(F.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(F)):(F.addClass("node-diff-empty"),i.deleted[j.id]&&(E=!0))),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(B),$("<span>").html("Flow Properties").appendTo(B),A.click(function(a){a.preventDefault(),$(this).parent().toggleClass("collapsed")}),f(k,j,y,x,l).appendTo(z),o="",l[j.id]?(w.conflicts++,C.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(C),F.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(F),z.addClass("node-diff-node-entry-conflict")):o=p.resolutions[j.id],g(j,z,C,F,!0,!l[j.id],o)}}var G=0,H=0,I={};if(d.tab.nodes.forEach(function(a){I[a.id]=!0,e(a,w).appendTo(r)}),d.newTab&&(G=d.newTab.nodes.length,d.newTab.nodes.forEach(function(a){I[a.id]||(I[a.id]=!0,e(a,w).appendTo(r))})),d.remoteTab&&(H=d.remoteTab.nodes.length,d.remoteTab.nodes.forEach(function(a){I[a.id]||e(a,w).appendTo(r)})),q.click(function(a){q.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),h.deleted[j.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(t);else if(d.newTab)if(h.added[j.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(t);else{j.id&&(h.changed[j.id]?w.local.changedCount++:w.local.unchangedCount++);var J=$("<span>",{class:"node-diff-tab-stats"}).appendTo(t);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:G})).appendTo(J),w.conflicts+w.local.addedCount+w.local.changedCount+w.local.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(J),w.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+w.conflicts+"</span></span>").appendTo(J),w.local.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+w.local.addedCount+"</span></span>").appendTo(J),w.local.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+w.local.changedCount+"</span></span>").appendTo(J),w.local.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+w.local.deletedCount+"</span></span>").appendTo(J),$('<span class="node-diff-status"> ] </span>').appendTo(J))}else t.addClass("node-diff-empty");if(i){if(i.deleted[j.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(n);else if(d.remoteTab)if(i.added[j.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(n);else{j.id&&(i.changed[j.id]?w.remote.changedCount++:w.remote.unchangedCount++);var K=$("<span>",{class:"node-diff-tab-stats"}).appendTo(n);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:H})).appendTo(K),w.conflicts+w.remote.addedCount+w.remote.changedCount+w.remote.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(K),w.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+w.conflicts+"</span></span>").appendTo(K),w.remote.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+w.remote.addedCount+"</span></span>").appendTo(K),w.remote.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+w.remote.changedCount+"</span></span>").appendTo(K),w.remote.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+w.remote.deletedCount+"</span></span>").appendTo(K),$('<span class="node-diff-status"> ] </span>').appendTo(K))}else n.addClass("node-diff-empty");if(o="",w.conflicts>0?q.addClass("node-diff-node-entry-conflict"):o=p.resolutions[j.id],j.id){var L=!(w.conflicts>0&&(h.deleted[j.id]||i.deleted[j.id]));g(j,q,t,n,!1,L,o)}}0===m.find(".node-diff-node-entry").length&&m.addClass("node-diff-tab-empty"),a.i18n()}})}function b(a,b){var c=$("<div>",{class:"node-diff-property-wires"}),e=$("<ol></ol>"),f=0;return a.forEach(function(a,c){var g=$("<li>").appendTo(e);if(a&&a.length>0){$("<span>").html(c+1).appendTo(g);var h=$("<ul>").appendTo(g);a.forEach(function(a){f++;var c=$("<li>").appendTo(h),e=b[a];if(e){var g=RED.nodes.getType(e.type)||{};d(e,g).appendTo(c)}else c.html(a)})}else g.html("none")}),0===f?c.html("none"):e.appendTo(c),c}function c(a,b){var c=$("<div>",{class:"node-diff-node-entry-node"}),d=b.color,e=RED.utils.getNodeIcon(b,a);"tab"===a.type&&(d="#C0DEED"),c.css("backgroundColor",d);var f=$("<div/>",{class:"palette_icon_container"}).appendTo(c);return $("<div/>",{class:"palette_icon",style:"background-image: url("+e+")"}).appendTo(f),c}function d(a,b){var d=$("<div>",{class:"node-diff-node-entry-title"});c(a,b).appendTo(d);var e=$("<div>",{class:"node-diff-node-description"}).appendTo(d),f=a.label||a.name||a.id;return $("<span>",{class:"node-diff-node-label"}).html(f).appendTo(e),d}function e(a,b){var c=p.localDiff,e=p.remoteDiff,h=p.conflicts[a.id],i=!1,j=!0,k=!1;c.added[a.id]&&(b.local.addedCount++,j=!1),e&&e.added[a.id]&&(b.remote.addedCount++,j=!1),c.deleted[a.id]&&(b.local.deletedCount++,j=!1),e&&e.deleted[a.id]&&(b.remote.deletedCount++,j=!1),c.changed[a.id]&&(b.local.changedCount++,i=!0,j=!1),e&&e.changed[a.id]&&(b.remote.changedCount++,i=!0,j=!1);var l=RED.nodes.getType(a.type);void 0===l&&(l=/^subflow:/.test(a.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var m,n=$("<div>",{class:"node-diff-node-entry collapsed"}),o=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(n),q=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(o),r=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(o);if(e&&(m=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(o)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(q),j)b.local.unchangedCount++,d(a,l).appendTo(q),r.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(r),e&&(b.remote.unchangedCount++,m.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(m)),n.addClass("node-diff-node-unchanged");else if(c.added[a.id])r.addClass("node-diff-node-added"),m&&m.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(r),d(a,l).appendTo(q);else if(e&&e.added[a.id])r.addClass("node-diff-empty"),m.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(m),d(a,l).appendTo(q);else{if(d(a,l).appendTo(q),c.moved[a.id]){var s=c.newConfig.all[a.id];if(c.deleted[a.z]||a.z===s.z||""===a.z||c.newConfig.all[a.z]){r.addClass("node-diff-node-moved");var t="";t=a.z===s.z?RED._("diff.type.movedFrom",{id:c.currentConfig.all[a.id].z||"global"}):RED._("diff.type.movedTo",{id:s.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+t+"</span>").appendTo(r)}else r.addClass("node-diff-empty");k=!0}else c.deleted[a.z]?(r.addClass("node-diff-empty"),k=!0):c.deleted[a.id]?(r.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(r),k=!0):c.changed[a.id]?c.newConfig.all[a.id].z!==a.z?r.addClass("node-diff-empty"):(r.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(r),k=!0):c.newConfig.all[a.id].z!==a.z?r.addClass("node-diff-empty"):(b.local.unchangedCount++,r.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(r));if(e)if(e.moved[a.id]){var u=e.newConfig.all[a.id];if(e.deleted[a.z]||a.z===u.z||""===a.z||e.newConfig.all[a.z]){m.addClass("node-diff-node-moved");var v="";v=a.z===u.z?RED._("diff.type.movedFrom",{id:e.currentConfig.all[a.id].z||"global"}):RED._("diff.type.movedTo",{id:u.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+v+"</span>").appendTo(m)}else m.addClass("node-diff-empty")}else e.deleted[a.z]?m.addClass("node-diff-empty"):e.deleted[a.id]?(m.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(m)):e.changed[a.id]?e.newConfig.all[a.id].z!==a.z?m.addClass("node-diff-empty"):(m.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(m)):e.newConfig.all[a.id].z!==a.z?m.addClass("node-diff-empty"):(b.remote.unchangedCount++,m.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(m))}var w,x={node:c.newConfig.all[a.id],all:c.newConfig.all,diff:c};e&&(w={node:e.newConfig.all[a.id]||null,all:e.newConfig.all,diff:e}),f(l,a,x,w).appendTo(n);var y="";return h?(b.conflicts++,r.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(r),m.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(m),n.addClass("node-diff-node-entry-conflict")):y=p.resolutions[a.id],g(a,n,r,m,!1,!h,y),o.click(function(a){$(this).parent().toggleClass("collapsed")}),n}function f(a,c,d,e){var f,g=d.node;e&&(f=e.node);var h,i,j,k,l,m,n=$("<div>",{class:"node-diff-node-entry-properties"}),o=$("<table>").appendTo(n),p=!1,q=!1,r=0,s=0,t=!1;h=$("<tr>").appendTo(o),$("<td>",{class:"node-diff-property-cell-label"}).html("id").appendTo(h),i=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(h),g?(i.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(i),RED.utils.createObjectElement(g.id).appendTo(i)):i.addClass("node-diff-empty"),void 0!==f&&(j=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(h),j.addClass("node-diff-node-unchanged"),f?($('<span class="node-diff-status"></span>').appendTo(j),RED.utils.createObjectElement(f.id).appendTo(j)):j.addClass("node-diff-empty")),c.hasOwnProperty("x")&&(g&&(g.x===c.x&&g.y===c.y||(p=!0,r++)),f&&(f.x===c.x&&f.y===c.y||(q=!0,s++)),(q&&p&&(g.x!==f.x||g.y!==f.y)||!p&&q&&d.diff.deleted[c.id]||p&&!q&&e.diff.deleted[c.id])&&(t=!0),h=$("<tr>").appendTo(o),$("<td>",{class:"node-diff-property-cell-label"}).html("position").appendTo(h),i=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(h),g?(i.addClass("node-diff-node-"+(p?"changed":"unchanged")),$('<span class="node-diff-status">'+(p?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(i),RED.utils.createObjectElement({x:g.x,y:g.y}).appendTo(i)):i.addClass("node-diff-empty"),void 0!==f&&(j=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(h),j.addClass("node-diff-node-"+(q?"changed":"unchanged")),f?($('<span class="node-diff-status">'+(q?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(j),RED.utils.createObjectElement({x:f.x,y:f.y}).appendTo(j)):j.addClass("node-diff-empty"))),p=q=t=!1,c.hasOwnProperty("wires")&&(k=JSON.stringify(c.wires),g&&(l=JSON.stringify(g.wires),k!==l&&(p=!0,r++)),f&&(m=JSON.stringify(f.wires),k!==m&&(q=!0,s++)),(q&&p&&l!==m||!p&&q&&d.diff.deleted[c.id]||p&&!q&&e.diff.deleted[c.id])&&(t=!0),h=$("<tr>").appendTo(o),$("<td>",{class:"node-diff-property-cell-label"}).html("wires").appendTo(h),i=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(h),g?(t?(i.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(i)):(i.addClass("node-diff-node-"+(p?"changed":"unchanged")),$('<span class="node-diff-status">'+(p?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(i)),b(g.wires,d.all).appendTo(i)):i.addClass("node-diff-empty"),void 0!==f&&(j=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(h),f?(t?(j.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(j)):(j.addClass("node-diff-node-"+(q?"changed":"unchanged")),$('<span class="node-diff-status">'+(q?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(j)),b(f.wires,e.all).appendTo(j)):j.addClass("node-diff-empty")));var u=Object.keys(c).filter(function(b){return!("z"==b||"wires"==b||"x"===b||"y"===b||"id"===b||"type"===b||a.defaults&&a.defaults.hasOwnProperty(b))});return a.defaults&&(u=u.concat(Object.keys(a.defaults))),u.forEach(function(a){p=!1,q=!1,t=!1,k=JSON.stringify(c[a]),g&&(l=JSON.stringify(g[a]),k!==l&&(p=!0,r++)),f&&(m=JSON.stringify(f[a]),k!==m&&(q=!0,s++)),(q&&p&&l!==m||!p&&q&&d.diff.deleted[c.id]||p&&!q&&e.diff.deleted[c.id])&&(t=!0),h=$("<tr>").appendTo(o),$("<td>",{class:"node-diff-property-cell-label"}).html(a).appendTo(h),i=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(h),g?(t?(i.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(i)):(i.addClass("node-diff-node-"+(p?"changed":"unchanged")),$('<span class="node-diff-status">'+(p?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(i)),RED.utils.createObjectElement(g[a]).appendTo(i)):i.addClass("node-diff-empty"),void 0!==f&&(j=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(h),f?(t?(j.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(j)):(j.addClass("node-diff-node-"+(q?"changed":"unchanged")),$('<span class="node-diff-status">'+(q?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(j)),RED.utils.createObjectElement(f[a]).appendTo(j)):j.addClass("node-diff-empty"))}),n}function g(a,b,c,d,e,f,g){var i="node-diff-selectbox-"+a.id.replace(/\./g,"-")+(e?"-props":""),j="";(a.z||e)&&(j="node-diff-selectbox-tab-"+(e?a.id:a.z).replace(/\./g,"-"));var k=!e&&("tab"===a.type||"subflow"===a.type),l=function(c){var d;if(void 0===a.type);else if(k)d="node-diff-selectbox-tab-"+a.id.replace(/\./g,"-"),$("."+d+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+d+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+d+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+d+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+d+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var f="node-diff-selectbox-"+(e?a.id:a.z).replace(/\./g,"-");$("#"+f+"-local").prop("checked",!1),$("#"+f+"-remote").prop("checked",!1);var g=$("#"+f+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");g.removeClass("node-diff-select-local"),g.removeClass("node-diff-select-remote")}"local"===this.value?(b.removeClass("node-diff-select-remote"),b.addClass("node-diff-select-local")):"remote"===this.value&&(b.addClass("node-diff-select-remote"),b.removeClass("node-diff-select-local")),h()},m=$("<label>",{class:"node-diff-selectbox",for:i+"-local"}).click(function(a){a.stopPropagation()}).appendTo(c),n=$("<input>",{id:i+"-local",type:"radio",value:"local",name:i,class:j+"-local"+(k?"":" node-diff-select-node")}).data("node-id",a.id).change(l).appendTo(m),o=$("<label>",{class:"node-diff-selectbox",for:i+"-remote"}).click(function(a){a.stopPropagation()}).appendTo(d),p=$("<input>",{id:i+"-remote",type:"radio",value:"remote",name:i,class:j+"-remote"+(k?"":" node-diff-select-node")}).data("node-id",a.id).change(l).appendTo(o);"local"===g?n.prop("checked",!0):"remote"===g&&p.prop("checked",!0),(f||c.hasClass("node-diff-empty")||d.hasClass("node-diff-empty"))&&(m.hide(),o.hide())}function h(){var a=0;$(".node-diff-selectbox>input:checked").each(function(){p.conflicts[$(this).data("node-id")]&&a++,p.resolutions[$(this).data("node-id")]=$(this).val()});var b=Object.keys(p.conflicts).length;b-a===0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:b-a})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:b-a})),b===a&&$("#node-diff-view-diff-merge").removeClass("disabled")}function i(a){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(b){var c=RED.nodes.createCompleteNodeSet(),d=RED.nodes.originalFlow(),e=b.flows,f=l(d,c),g=l(d,e);g.rev=b.rev,a(m(f,g))}})}function j(a){void 0===a?i(j):n(a)}function k(a){var b=[],c={},d={},e=[],f={};return a.forEach(function(a){f[a.id]=a,"tab"===a.type?(b.push(a.id),c[a.id]={n:a,nodes:[]}):"subflow"===a.type&&(d[a.id]={n:a,nodes:[]})}),a.forEach(function(a){"tab"!==a.type&&"subflow"!==a.type&&(c[a.z]?c[a.z].nodes.push(a):d[a.z]?d[a.z].nodes.push(a):e.push(a))}),{all:f,tabOrder:b,tabs:c,subflows:d,globals:e}}function l(a,b){var c=k(a),d=k(b),e={},f={},g={},h={};return Object.keys(c.all).forEach(function(a){RED.nodes.workspace(a)||RED.nodes.subflow(a)||RED.nodes.node(a);d.all.hasOwnProperty(a)?JSON.stringify(c.all[a])!==JSON.stringify(d.all[a])&&(g[a]=!0,c.all[a].z!==d.all[a].z&&(h[a]=!0)):f[a]=!0}),Object.keys(d.all).forEach(function(a){c.all.hasOwnProperty(a)||(e[a]=!0)}),{currentConfig:c,newConfig:d,added:e,deleted:f,changed:g,moved:h}}function m(a,b){var c,d,e={},f={},g={localDiff:a,remoteDiff:b,conflicts:e,resolutions:f},h={};for(c in a.currentConfig.all)if(a.currentConfig.all.hasOwnProperty(c)){h[c]=!0;var i=a.newConfig.all[c];if(a.changed[c]&&b.deleted[c])e[c]=!0;else if(a.deleted[c]&&b.changed[c])e[c]=!0;else if(a.changed[c]&&b.changed[c]){var j=b.newConfig.all[c];JSON.stringify(i)!==JSON.stringify(j)&&(e[c]=!0)}e[c]||(b.added[c]||b.changed[c]||b.deleted[c]?f[c]="remote":f[c]="local")}for(c in a.added)a.added.hasOwnProperty(c)&&(d=a.newConfig.all[c],b.deleted[d.z]?e[c]=!0:f[c]="local");for(c in b.added)b.added.hasOwnProperty(c)&&(d=b.newConfig.all[c],a.deleted[d.z]?e[c]=!0:f[c]="remote");return g}function n(a){var b=a.localDiff,c=a.remoteDiff,d=a.conflicts;p=a;var e=$("#node-dialog-view-diff-diff");e.editableList("empty"),c?($("#node-diff-view-diff-merge").show(),0===Object.keys(d).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),h(),$("#node-dialog-view-diff-headers").empty();var f=b.currentConfig,g=b.newConfig;d=d||{};var i={diff:b,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:f.globals},newTab:{n:{},nodes:g.globals}};void 0!==c?($("#node-dialog-view-diff").addClass("node-diff-three-way"),$('<div class="node-diff-node-entry-cell"></div><div class="node-diff-node-entry-cell" data-i18n="diff.local"></div><div class="node-diff-node-entry-cell" data-i18n="diff.remote"></div>').i18n().appendTo("#node-dialog-view-diff-headers"),i.remoteTab={n:{},nodes:c.newConfig.globals},i.remoteDiff=c):$("#node-dialog-view-diff").removeClass("node-diff-three-way"),e.editableList("addItem",i);var j={};f.tabOrder.forEach(function(a){var d=f.tabs[a],h={diff:b,def:{},tab:d};g.tabs.hasOwnProperty(a)&&(h.newTab=g.tabs[a]),void 0!==c&&(h.remoteTab=c.newConfig.tabs[a],h.remoteDiff=c),j[a]=!0,e.editableList("addItem",h)}),g.tabOrder.forEach(function(a){if(!j[a]){j[a]=!0;var d=g.tabs[a],f={diff:b,def:{},tab:d,newTab:d};void 0!==c&&(f.remoteDiff=c),e.editableList("addItem",f)}}),void 0!==c&&c.newConfig.tabOrder.forEach(function(a){if(!j[a]){var d=c.newConfig.tabs[a],f={diff:b,remoteDiff:c,def:{},tab:d,remoteTab:d};e.editableList("addItem",f)}});var k;for(k in f.subflows)f.subflows.hasOwnProperty(k)&&(j[k]=!0,
i={diff:b,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:f.subflows[k]},g.subflows.hasOwnProperty(k)&&(i.newTab=g.subflows[k]),void 0!==c&&(i.remoteTab=c.newConfig.subflows[k],i.remoteDiff=c),e.editableList("addItem",i));for(k in g.subflows)g.subflows.hasOwnProperty(k)&&!j[k]&&(j[k]=!0,i={diff:b,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:g.subflows[k],newTab:g.subflows[k]},void 0!==c&&(i.remoteDiff=c),e.editableList("addItem",i));if(void 0!==c)for(k in c.newConfig.subflows)c.newConfig.subflows.hasOwnProperty(k)&&!j[k]&&(i={diff:b,remoteDiff:c,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:c.newConfig.subflows[k],remoteTab:c.newConfig.subflows[k]},e.editableList("addItem",i));$("#node-diff-filter-changed").addClass("selected"),$("#node-diff-filter-all").removeClass("selected"),$("#node-dialog-view-diff").dialog("open")}function o(a){var b,c=(a.localDiff.currentConfig,a.localDiff),d=a.remoteDiff,e=a.conflicts,f=a.resolutions;for(b in e)if(e.hasOwnProperty(b)&&!f.hasOwnProperty(b))throw console.log(a),new Error("No resolution for conflict on node",b);var g,h=[],i={},j={};for(b in c.newConfig.all)c.newConfig.all.hasOwnProperty(b)&&(g=RED.nodes.node(b),"local"===f[b]?(g&&(i[b]=g.changed),h.push(c.newConfig.all[b])):"remote"===f[b]?!d.deleted[b]&&d.newConfig.all.hasOwnProperty(b)&&(g&&(i[b]=g.changed),j[b]=!0,h.push(d.newConfig.all[b])):console.log("Unresolved",b));for(b in d.added)d.added.hasOwnProperty(b)&&(g=RED.nodes.node(b),g&&(i[b]=g.changed),c.added.hasOwnProperty(b)||(j[b]=!0,h.push(d.newConfig.all[b])));var k={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:i,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(k),RED.nodes.clear();var l=RED.nodes.import(h);l[0].forEach(function(a){(i[a.id]||j[a.id])&&(a.changed=!0)}),RED.nodes.version(d.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}var p={};return{init:a,getRemoteDiff:i,showRemoteDiff:j,mergeDiff:o}}(),RED.keyboard=function(){function a(){var a=RED.settings.get("keymap")||{};$.getJSON("red/keymap.json",function(b){for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];for(var f in d)d.hasOwnProperty(f)&&(a.hasOwnProperty(d[f])||(e(c,f,d[f],!1),t[d[f]]={scope:c,key:f,user:!1}))}for(var g in a)if(a.hasOwnProperty(g)){var h=a[g];h.hasOwnProperty("key")&&e(h.scope,h.key,g,!0)}}),RED.userSettings.add({id:"keyboard",title:"Keyboard",get:m,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})}function b(a){var b=s[a];if(b&&f(b.key),t.hasOwnProperty(a)){var c=t[a];e(c.scope,c.key,a,!1)}}function c(a){for(var b,c=a.toLowerCase().split("-"),d={},e=0,f=0;f<c.length;f++)switch(c[f]){case"ctrl":case"cmd":d.ctrl=!0,d.meta=!0;break;case"alt":d.alt=!0;break;case"shift":d.shift=!0;break;case"":e++,b=q["-"];break;default:if(q.hasOwnProperty(c[f]))b=q[c[f]];else{if(c[f].length>1)return null;b=c[f].toUpperCase().charCodeAt(0)}}return[b,d]}function d(a){var b=n||p;(a.ctrlKey||a.metaKey)&&(b=b.ctrl),b&&a.shiftKey&&(b=b.shift),b&&a.altKey&&(b=b.alt);var c=u[a.keyCode]||a.keyCode;if(b&&b[c]){var e=b[c];if(!e.scope)return n?(n=null,d(a)):Object.keys(e).length>0?(n=e,a.preventDefault(),null):null;if(e.scope&&"*"!==e.scope){for(var f=a.target;"BODY"!==f.nodeName&&f.id!==e.scope;)f=f.parentElement;"BODY"===f.nodeName&&(e=null)}return n=null,e}if(n)return n=null,d(a)}function e(a,b,d,e){var f=d,g=e;"function"!=typeof d&&"string"!=typeof d||(f={},g=d);var h=[],i=0;if("string"==typeof b){"string"==typeof g&&(s[g]={scope:a,key:b},"boolean"==typeof e&&(s[g].user=e));var j=b.split(" ");for(i=0;i<j.length;i++){var k=c(j[i]);if(!k)return;h.push(k)}}else h.push([b,f]);var l=p;for(i=0;i<h.length;i++)b=h[i][0],f=h[i][1],f.ctrl&&(l.ctrl=l.ctrl||{},l=l.ctrl),f.shift&&(l.shift=l.shift||{},l=l.shift),f.alt&&(l.alt=l.alt||{},l=l.alt),l[b]=l[b]||{},l=l[b];l.scope=a,l.ondown=g}function f(a,b){var d=b||{},e=[],f=0;if("string"==typeof a){var g=a.split(" ");for(f=0;f<g.length;f++){var h=c(g[f]);if(!h)return void console.log("Unrecognised key specifier:",a);e.push(h)}}else e.push([a,d]);var i=p;for(f=0;f<e.length;f++){if(a=e[f][0],d=e[f][1],d.ctrl&&(i=i.ctrl),i&&d.shift&&(i=i.shift),i&&d.alt&&(i=i.alt),!i[a])return;i=i[a]}"string"==typeof i.ondown&&("boolean"==typeof b&&b?s[i.ondown]={user:b}:delete s[i.ondown]),delete i.scope,delete i.ondown}function g(a){var b=o?a.replace(/ctrl-?/,"&#8984;"):a;return b=o?b.replace(/alt-?/,"&#8997;"):a,b=b.replace(/shift-?/,"&#8679;"),b=b.replace(/left/,"&#x2190;"),b=b.replace(/up/,"&#x2191;"),b=b.replace(/right/,"&#x2192;"),b=b.replace(/down/,"&#x2193;"),'<span class="help-key-block"><span class="help-key">'+b.split(" ").join('</span> <span class="help-key">')+"</span></span>"}function h(a){a=a.trim();var b=a.split(" ");for(i=0;i<b.length;i++){var d=c(b[i]);if(!d)return!1}return!0}function j(a){a.preventDefault();var b=$(this),c=b.data("data");if(!b.hasClass("keyboard-shortcut-entry-expanded")){k();var d=b.find(".keyboard-shortcut-entry-key"),e=b.find(".keyboard-shortcut-entry-scope");b.addClass("keyboard-shortcut-entry-expanded");var f=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(c.key||"").appendTo(d);f.on("keyup",function(a){if(13===a.keyCode)return k();var b=$(this).val();b=b.trim();var c=""===b||RED.keyboard.validateKey(b);$(this).toggleClass("input-error",!c)});var g=$('<select><option value="*">global</option><option value="workspace">workspace</option></select>').appendTo(e);g.val(c.scope||"*");var h=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(e),i=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(h),j=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(h);i.click(function(a){a.stopPropagation(),k()}),j.click(function(a){a.stopPropagation(),RED.keyboard.revertToDefault(c.id),b.empty(),b.removeClass("keyboard-shortcut-entry-expanded");var d=RED.keyboard.getShortcut(c.id),e=RED.settings.get("keymap")||{};delete e[c.id],RED.settings.set("keymap",e);var f={id:c.id,scope:d?d.scope:void 0,key:d?d.key:void 0,user:d?d.user:void 0};l(b,f)}),f.focus()}}function k(a){var b=$(".keyboard-shortcut-entry-expanded");if(1===b.length){var c=b.data("data"),d=b.find(".keyboard-shortcut-entry-key input"),e=b.find(".keyboard-shortcut-entry-scope select");if(!a){var f=d.val().trim(),g=e.val(),h=""===f||RED.keyboard.validateKey(f);if(h){var i=RED.keyboard.getShortcut(c.id);if(!i&&f||i&&(i.scope!==g||i.key!==f)){var j=b.find(".keyboard-shortcut-entry-key"),k=b.find(".keyboard-shortcut-entry-scope");j.empty(),k.empty(),c.key&&RED.keyboard.remove(c.key,!0),b.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===f?(j.parent().addClass("keyboard-shortcut-entry-unassigned"),j.append($("<span>").text(RED._("keyboard.unassigned"))),delete c.key,delete c.scope):(j.parent().removeClass("keyboard-shortcut-entry-unassigned"),j.append(RED.keyboard.formatKey(f)),$("<span>").text(g).appendTo(k),c.key=f,c.scope=g,RED.keyboard.add(c.scope,c.key,c.id,!0));var l=RED.settings.get("keymap")||{};l[c.id]=RED.keyboard.getShortcut(c.id),RED.settings.set("keymap",l)}}}d.remove(),e.remove(),$(".keyboard-shortcut-edit").remove(),b.removeClass("keyboard-shortcut-entry-expanded")}}function l(a,b){var c=$('<div class="keyboard-shortcut-entry">').appendTo(a);a.data("data",b);var d=b.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),e=$("<div>").addClass("keyboard-shortcut-entry-text").text(d).appendTo(c),f=$('<i class="fa fa-user"></i>').prependTo(e);b.user||f.css("opacity",0);var g=$('<div class="keyboard-shortcut-entry-key">').appendTo(c);b.key?g.append(RED.keyboard.formatKey(b.key)):(c.addClass("keyboard-shortcut-entry-unassigned"),g.append($("<span>").text(RED._("keyboard.unassigned"))));var h=$('<div class="keyboard-shortcut-entry-scope">').appendTo(c);$("<span>").text("*"===b.scope?"global":b.scope||"").appendTo(h),a.click(j)}function m(){var a=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" placeholder="filter actions"></div><div class="keyboard-shortcut-entry-key">shortcut</div><div class="keyboard-shortcut-entry-scope">scope</div></div>').appendTo(a),a.find("input").searchBox({delay:100,change:function(){var a=$(this).val().trim();""===a?b.editableList("filter",null):(a=a.replace(/\s/g,""),b.editableList("filter",function(b){return b.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(a)>-1}))}});var b=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(a).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(a,b,c){l(a,c)}}),c=RED.actions.list();return c.sort(function(a,b){var c=a.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),d=b.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return c.localeCompare(d)}),c.forEach(function(a){b.editableList("addItem",a)}),a}var n,o=/Mac/i.test(window.navigator.platform),p={},q={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},r={16:!0,17:!0,18:!0,91:!0,93:!0},s={},t={},u={59:186,61:187,173:189};d3.select(window).on("keydown",function(){if(!r[d3.event.keyCode]){var a=d(d3.event);a&&a.ondown&&("string"==typeof a.ondown?RED.actions.invoke(a.ondown):a.ondown(),d3.event.preventDefault())}});return{init:a,add:e,remove:f,getShortcut:function(a){return s[a]},revertToDefault:b,formatKey:g,validateKey:h}}(),RED.workspaces=function(){function a(a,b){if(a)i.addTab(a),i.resize();else{var c=RED.nodes.id();do k+=1;while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:k})+"']").size());a={type:"tab",id:c,label:RED._("workspace.defaultName",{number:k})},RED.nodes.addWorkspace(a),i.addTab(a),i.activateTab(c),b||(RED.history.push({t:"add",workspaces:[a],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),a}function b(a){if(1!=i.count()){g(a);var b=RED.nodes.removeWorkspace(a.id);b.t="delete",b.dirty=RED.nodes.dirty(),b.workspaces=[a],RED.history.push(b),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function c(a){var c=RED.nodes.workspace(a);RED.view.state(RED.state.EDITING);var d,e={title:RED._("workspace.editFlow",{name:c.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1==i.count()?" disabled":""),text:RED._("common.label.delete"),click:function(){b(c),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var a=$("#node-input-name").val(),b=!1,e={};c.label!=a&&(e.label=c.label,b=!0,c.label=a,i.renameTab(c.id,a));var f=$("#node-input-disabled").prop("checked");c.disabled!==f&&(e.disabled=c.disabled,b=!0,c.disabled=f);var g=d.getValue();if(c.info!==g&&(e.info=c.info,b=!0,c.info=g),$("#red-ui-tab-"+c.id.replace(".","-")).toggleClass("workspace-disabled",c.disabled),b){var h={t:"edit",changes:e,node:c,dirty:RED.nodes.dirty()};c.changed=!0,RED.history.push(h),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var j=RED.view.selection();j.nodes||j.links||RED.sidebar.info.refresh(c)}RED.tray.close()}}],resize:function(a){for(var b=$("#dialog-form>div:not(.node-text-editor-row)"),c=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),e=0;e<b.size();e++)c-=$(b[e]).outerHeight(!0);c-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),c-=28,$(".node-text-editor").css("height",c+"px"),d.resize()},open:function(a){var b=a.find(".editor-tray-body"),e=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(b);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(e),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(e),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(e),d=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(e),e.find("#node-input-disabled-btn").on("click",function(a){var b=$(this).find("i");b.hasClass("fa-toggle-off")?(b.addClass("fa-toggle-on"),b.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(b.addClass("fa-toggle-off"),b.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled")))}),c.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",c.disabled),c.disabled?(e.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(c.disabled=!1,$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(e),e.submit(function(a){a.preventDefault()}),$("#node-input-name").val(c.label),RED.text.bidi.prepareInput($("#node-input-name")),d.getSession().setValue(c.info||"",-1),e.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(c)}};RED.tray.show(e)}function d(){i=RED.tabs.create({id:"workspace-tabs",onchange:function(a){var b={old:j};j=a.id,b.workspace=j,RED.events.emit("workspace:change",b),window.location.hash="flow/"+a.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(a){RED.view.focus()},ondblclick:function(a){"subflow"!=a.type?c(a.id):RED.editor.editSubflow(RED.nodes.subflow(a.id))},onadd:function(a){$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+a.id.replace(".","-")+" .red-ui-tab-label"),a.disabled&&$("#red-ui-tab-"+a.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",1==i.count())},onremove:function(a){RED.menu.setDisabled("menu-item-workspace-delete",1==i.count())},onreorder:function(a,b){RED.history.push({t:"reorder",order:a,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),h(b)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){a()}})}function e(){d(),RED.events.on("sidebar:resize",i.resize),RED.actions.add("core:show-next-tab",i.nextTab),RED.actions.add("core:show-previous-tab",i.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){b(RED.nodes.workspace(j))}),$(window).resize(function(){i.resize()}),RED.actions.add("core:add-flow",a),RED.actions.add("core:edit-flow",f),RED.actions.add("core:remove-flow",g)}function f(a){c(a||j)}function g(a){a?i.contains(a.id)&&i.removeTab(a.id):b(RED.nodes.workspace(j))}function h(a){RED.nodes.setWorkspaceOrder(a.filter(function(a){return void 0!==RED.nodes.workspace(a)})),i.order(a)}var i,j=0,k=0;return{init:e,add:a,remove:g,order:h,edit:f,contains:function(a){return i.contains(a)},count:function(){return i.count()},active:function(){return j},show:function(b){if(!i.contains(b)){var c=RED.nodes.subflow(b);if(!c)return;a({type:"subflow",id:b,icon:"red/images/subflow_tab.png",label:c.name,closeable:!0})}i.activateTab(b)},refresh:function(){RED.nodes.eachWorkspace(function(a){i.renameTab(a.id,a.label)}),RED.nodes.eachSubflow(function(a){i.contains(a.id)&&i.renameTab(a.id,a.name)}),RED.sidebar.config.refresh()},resize:function(){i.resize()}}}(),RED.view=function(){function a(){Ga.selectAll("line.horizontal").remove(),Ga.selectAll("line.horizontal").data(Fa.ticks(Q/ba)).enter().append("line").attr({class:"horizontal",x1:0,x2:Q,y1:function(a){return Fa(a)},y2:function(a){return Fa(a)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),Ga.selectAll("line.vertical").remove(),Ga.selectAll("line.vertical").data(Fa.ticks(Q/ba)).enter().append("line").attr({class:"vertical",y1:0,y2:Q,x1:function(a){return Fa(a)},x2:function(a){return Fa(a)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}function b(a){for(var b=0;b<a.length;b++){var c=a[b];c.el=Ha.append("svg:path").attr("class","drag_line"),Ia.push(c)}}function c(){for(;Ia.length;){var a=Ia.pop();a.el&&a.el.remove()}}function d(){var a=RED.workspaces.active();fa=RED.nodes.filterNodes({z:a}),ga=RED.nodes.filterLinks({source:{z:a},target:{z:a}})}function e(){RED.events.on("workspace:change",function(a){var b=$("#chart");0!==a.old&&(aa[a.old]={left:b.scrollLeft(),top:b.scrollTop()});var c=b.scrollLeft(),e=b.scrollTop();ea=RED.nodes.subflow(a.workspace),RED.menu.setDisabled("menu-item-workspace-edit",ea),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||ea),aa[a.workspace]?(b.scrollLeft(aa[a.workspace].left),b.scrollTop(aa[a.workspace].top)):(b.scrollLeft(0),b.scrollTop(0));var f=b.scrollLeft()-c,g=b.scrollTop()-e;null!=pa&&(pa[0]+=f,pa[1]+=g),o(),RED.nodes.eachNode(function(a){a.dirty=!0}),p(),d(),I()}),$("#btn-zoom-out").click(function(){l()}),$("#btn-zoom-zero").click(function(){m()}),$("#btn-zoom-in").click(function(){k()}),$("#chart").on("DOMMouseScroll mousewheel",function(a){if(a.altKey){a.preventDefault(),a.stopPropagation();var b=-a.originalEvent.detail||a.originalEvent.wheelDelta;b<=0?l():k()}}),$("#chart").droppable({accept:".palette_node",drop:function(a,b){d3.event=a;var c=b.draggable[0].type,e=f(c);if(e){var g=e.historyEvent,h=e.node,i=d3.touches(b.helper.get(0))[0]||d3.mouse(b.helper.get(0)),j=d3.touches(this)[0]||d3.mouse(this);j[1]+=this.scrollTop+(h.h/2-i[1]),j[0]+=this.scrollLeft+(h.w/2-i[0]),j[1]/=T,j[0]/=T,ca&&(j[0]=ba*Math.ceil(j[0]/ba),j[1]=ba*Math.ceil(j[1]/ba)),h.x=j[0],h.y=j[1];var k=$(b.helper).data("splice");if(k){RED.nodes.removeLink(k);var l={source:k.source,sourcePort:k.sourcePort,target:h},m={source:h,sourcePort:0,target:k.target};RED.nodes.addLink(l),RED.nodes.addLink(m),g.links=[l,m],g.removedLinks=[k]}RED.history.push(g),RED.nodes.add(h),RED.editor.validateNode(h),RED.nodes.dirty(!0),o(),h.selected=!0,ra.push({n:h}),d(),p(),I(),h._def.autoedit&&RED.editor.edit(h)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",u),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){u(),t()}),RED.actions.add("core:paste-from-internal-clipboard",function(){K(ya)}),RED.actions.add("core:delete-selection",t),RED.actions.add("core:edit-selected-node",s),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",n),RED.actions.add("core:zoom-in",k),RED.actions.add("core:zoom-out",l),RED.actions.add("core:zoom-reset",m),RED.actions.add("core:toggle-show-grid",function(a){void 0===a?RED.userSettings.toggle("view-show-grid"):L(a)}),RED.actions.add("core:toggle-snap-grid",function(a){void 0===a?RED.userSettings.toggle("view-snap-grid"):M(a)}),RED.actions.add("core:toggle-status",function(a){void 0===a?RED.userSettings.toggle("view-node-status"):N(a)}),RED.actions.add("core:move-selection-up",function(){r(0,-1)}),RED.actions.add("core:step-selection-up",function(){r(0,-20)}),RED.actions.add("core:move-selection-right",function(){r(1,0)}),RED.actions.add("core:step-selection-right",function(){r(20,0)}),RED.actions.add("core:move-selection-down",function(){r(0,1)}),RED.actions.add("core:step-selection-down",function(){r(0,20)}),RED.actions.add("core:move-selection-left",function(){r(-1,0)}),RED.actions.add("core:step-selection-left",function(){r(-20,0)})}function f(a,b,c){var d=/^subflow:(.+)$/.exec(a);if(ea&&d){var e=d[1];if(e===ea.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(d[1],ea.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var f={id:RED.nodes.id(),z:RED.workspaces.active()};if(f.type=a,f._def=RED.nodes.getType(f.type),f.namespace=f._def.namespace?f._def.namespace:f.type,d){var g=RED.nodes.subflow(d[1]);f.inputs=g.in.length,f.outputs=g.out.length}else{f.inputs=f._def.inputs||0,f.outputs=f._def.outputs;for(var h in f._def.defaults)f._def.defaults.hasOwnProperty(h)&&void 0!==f._def.defaults[h].value&&(f[h]=JSON.parse(JSON.stringify(f._def.defaults[h].value)));if(f._def.onadd)try{f._def.onadd.call(f)}catch(a){console.log("onadd:",a)}}f.changed=!0,f.moved=!0,f.w=U,f.h=Math.max(Math.max(V,20*(f.outputs||0)),20*(f.inputs||0));var i={t:"add",nodes:[f.id],dirty:RED.nodes.dirty()};if(ea){var j=RED.subflow.refresh(!0);j&&(i.subflow={id:ea.id,changed:ea.changed,instances:j.instances})}return{node:f,historyEvent:i}}function g(){var a;if(ka||ja||(ia=null,p()),0===qa&&sa&&(sa.remove(),sa=null),(0===qa||qa===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){a=d3.mouse(this),d3.event.stopPropagation();var e=$("#main-container").position();qa!==RED.state.QUICK_JOINING&&(qa=RED.state.QUICK_JOINING,$(window).on("keyup",y)),RED.typeSearch.show({x:d3.event.clientX-e.left-U/2,y:d3.event.clientY-e.top-V/2,add:function(e){var g=f(e);if(g){var h=g.node,i=g.historyEvent;if(h.x=a[0],h.y=a[1],qa===RED.state.QUICK_JOINING)if(Ia.length>0){var j,k,l=Ia[0],m=null;if(l.portType===Ba&&h.inputs>0?(m=l.node,k=l.port,j=h):l.portType===Aa&&h.outputs>0&&(m=h,j=l.node,k=0),null!==m){var n={source:m,sourcePort:k,target:j};RED.nodes.addLink(n),i.links=[n],c(),l.portType===Ba&&h.outputs>0?b([{node:h,port:0,portType:Ba}]):l.portType===Aa&&h.inputs>0?b([{node:h,port:0,portType:Aa}]):x()}else c(),x()}else h.outputs>0?b([{node:h,port:0,portType:Ba}]):h.inputs>0?b([{node:h,port:0,portType:Aa}]):x();RED.history.push(i),RED.nodes.add(h),RED.editor.validateNode(h),RED.nodes.dirty(!0),o(),h.selected=!0,ra.push({n:h}),d(),p(),I()}}}),d(),p(),I()}0!==qa||d3.event.metaKey||d3.event.ctrlKey||_||(a=d3.mouse(this),sa=Da.append("rect").attr("ox",a[0]).attr("oy",a[1]).attr("rx",1).attr("ry",1).attr("x",a[0]).attr("y",a[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}function h(){var a,c;if(pa=d3.touches(this)[0]||d3.mouse(this),sa){var e,f,g=parseInt(sa.attr("ox")),h=parseInt(sa.attr("oy")),i=parseInt(sa.attr("x")),j=parseInt(sa.attr("y"));return pa[0]<g?(i=pa[0],e=g-i):e=pa[0]-i,pa[1]<h?(j=pa[1],f=h-j):f=pa[1]-j,void sa.attr("x",i).attr("y",j).attr("width",e).attr("height",f)}if(qa==RED.state.QUICK_JOINING||qa==RED.state.IMPORT_DRAGGING||ka||null!=ia){var k;if(qa==RED.state.JOINING||qa===RED.state.QUICK_JOINING){if(0===Ia.length){if(d3.event.shiftKey){var l=[],m=[];if(ia&&(la===Ba&&ia.source===ka&&ia.sourcePort===ma||la===Aa&&ia.target===ka&&ia.targetPort===ma))m=[ia];else{var n;n=la===Ba?{source:ka,sourcePort:ma}:{target:ka,targetPort:ma},m=RED.nodes.filterLinks(n)}for(a=0;a<m.length;a++){var o=m[a];RED.nodes.removeLink(o),l.push({link:o,node:la===Ba?o.target:o.source,port:la===Ba?o.targetPort:o.sourcePort,portType:la===Ba?Aa:Ba})}0===l.length?(x(),I()):(b(l),qa=0,d(),I(),qa=RED.state.JOINING)}else ka&&b([{node:ka,port:ma,portType:la}]);ia=null}for(k=pa,a=0;a<Ia.length;a++){var p=Ia[a],q=p.portType===Ba?p.node.outputs||1:p.node.inputs||1,r=p.port;"subflow"==p.node.type&&(q=1,r=0);var s=18*-((q-1)/2)+18*r,t=p.portType===Ba?1:-1,u=k[1]-(p.node.y+s),v=k[0]-(p.node.x+t*p.node.w/2),w=Math.sqrt(u*u+v*v),y=S,z=0;w<U&&(y=.75-.75*((U-w)/U)),v*t<0&&(y+=2*(Math.min(5*U,Math.abs(v))/(5*U)),Math.abs(u)<3*V&&(z=(u>0?.5:-.5)*((3*V-Math.abs(u))/(3*V))*(Math.min(U,Math.abs(v))/U))),p.el.attr("d","M "+(p.node.x+t*p.node.w/2)+" "+(p.node.y+s)+" C "+(p.node.x+t*(p.node.w/2+U*y))+" "+(p.node.y+s+z*V)+" "+(k[0]-t*y*U)+" "+(k[1]-z*V)+" "+k[0]+" "+k[1])}d3.event.preventDefault()}else if(qa==RED.state.MOVING){k=d3.mouse(document.body),isNaN(k[0])&&(k=d3.touches(document.body)[0]);var A=(oa[0]-k[0])*(oa[0]-k[0])+(oa[1]-k[1])*(oa[1]-k[1]);A>3&&(qa=RED.state.MOVING_ACTIVE,xa=0,da=!1,1===ra.length&&(c=ra[0],da=c.n.hasOwnProperty("_def")&&c.n._def.inputs>0&&c.n._def.outputs>0&&0===RED.nodes.filterLinks({source:c.n}).length&&0===RED.nodes.filterLinks({target:c.n}).length))}else if(qa==RED.state.MOVING_ACTIVE||qa==RED.state.IMPORT_DRAGGING){k=pa;for(var B=0,C=0,D=Q,E=R,F=0;F<ra.length;F++)c=ra[F],d3.event.shiftKey&&(c.n.ox=c.n.x,c.n.oy=c.n.y),c.n.x=k[0]+c.dx,c.n.y=k[1]+c.dy,c.n.dirty=!0,B=Math.min(c.n.x-c.n.w/2-5,B),C=Math.min(c.n.y-c.n.h/2-5,C),D=Math.max(c.n.x+c.n.w/2+5,D),E=Math.max(c.n.y+c.n.h/2+5,E);if(0!==B||0!==C)for(a=0;a<ra.length;a++)c=ra[a],c.n.x-=B,c.n.y-=C;if(D!==Q||E!==R)for(a=0;a<ra.length;a++)c=ra[a],c.n.x-=D-Q,c.n.y-=E-R;if(ca!=d3.event.shiftKey&&ra.length>0){var G=[0,0];if(c=ra[0],G[0]=c.n.x-(ba*Math.floor((c.n.x-c.n.w/2)/ba)+c.n.w/2),G[1]=c.n.y-ba*Math.floor(c.n.y/ba),0!==G[0]||0!==G[1])for(a=0;a<ra.length;a++)c=ra[a],c.n.x-=G[0],c.n.y-=G[1],c.n.x==c.n.ox&&c.n.y==c.n.oy&&(c.dirty=!1)}qa!=RED.state.MOVING_ACTIVE&&qa!=RED.state.IMPORT_DRAGGING||1!==ra.length||(c=ra[0],da&&(P||(P=setTimeout(function(){var a=[],b=1/0,d=null,e=c.n.x,f=c.n.y;if(Ca[0][0].getIntersectionList){var g=Ca[0][0].createSVGRect();g.x=e,g.y=f,g.width=1,g.height=1,a=Ca[0][0].getIntersectionList(g,Ca[0][0])}else a=RED.view.getLinksAtPoint(e,f);for(var h=0;h<a.length;h++)if(d3.select(a[h]).classed("link_background"))for(var i=a[h].getTotalLength(),j=0;j<i;j+=10){var k=a[h].getPointAtLength(j),l=(k.x-e)*(k.x-e)+(k.y-f)*(k.y-f);l<200&&l<b&&(b=l,d=a[h])}O&&O!==d&&d3.select(O.parentNode).classed("link_splice",!1),d?d3.select(d.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),O=d,P=null},100))))}0!==qa&&I()}}function j(){var a,b;if(qa!==RED.state.QUICK_JOINING){if(ka&&qa==RED.state.JOINING){var e=[];for(a=0;a<Ia.length;a++)Ia[a].link&&e.push(Ia[a].link);b={t:"delete",links:e,dirty:RED.nodes.dirty()},RED.history.push(b),c()}if(sa){var f=parseInt(sa.attr("x")),g=parseInt(sa.attr("y")),h=f+parseInt(sa.attr("width")),i=g+parseInt(sa.attr("height"));d3.event.ctrlKey||o(),RED.nodes.eachNode(function(a){a.z!=RED.workspaces.active()||a.selected||(a.selected=a.x>f&&a.x<h&&a.y>g&&a.y<i,a.selected&&(a.dirty=!0,ra.push({n:a})))}),ea&&(ea.in.forEach(function(a){a.selected=a.x>f&&a.x<h&&a.y>g&&a.y<i,a.selected&&(a.dirty=!0,ra.push({n:a}))}),ea.out.forEach(function(a){a.selected=a.x>f&&a.x<h&&a.y>g&&a.y<i,a.selected&&(a.dirty=!0,ra.push({n:a}))})),p(),sa.remove(),sa=null}else qa!=RED.state.DEFAULT||null!=ja||d3.event.ctrlKey||d3.event.metaKey||(o(),p());if(qa==RED.state.MOVING_ACTIVE&&ra.length>0){for(var j=[],k=0;k<ra.length;k++)j.push({n:ra[k].n,ox:ra[k].ox,oy:ra[k].oy,moved:ra[k].n.moved}),ra[k].n.dirty=!0,ra[k].n.moved=!0;if(b={t:"move",nodes:j,dirty:RED.nodes.dirty()},O){var l=d3.select(O).data()[0];RED.nodes.removeLink(l);var m={source:l.source,sourcePort:l.sourcePort,target:ra[0].n},n={source:ra[0].n,sourcePort:0,target:l.target};RED.nodes.addLink(m),RED.nodes.addLink(n),b.links=[m,n],b.removedLinks=[l],d()}RED.nodes.dirty(!0),RED.history.push(b)}if(qa==RED.state.MOVING||qa==RED.state.MOVING_ACTIVE)for(a=0;a<ra.length;a++)delete ra[a].ox,delete ra[a].oy;qa==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),d(),RED.nodes.dirty(!0)),x(),I()}}function k(){T<2&&(T+=.1,I())}function l(){T>.3&&(T-=.1,I())}function m(){T=1,I()}function n(){RED.nodes.eachNode(function(a){a.z==RED.workspaces.active()&&(a.selected||(a.selected=!0,a.dirty=!0,ra.push({n:a})))}),ea&&(ea.in.forEach(function(a){a.selected||(a.selected=!0,a.dirty=!0,ra.push({n:a}))}),ea.out.forEach(function(a){a.selected||(a.selected=!0,a.dirty=!0,ra.push({n:a}))})),ia=null,p(),I()}function o(){for(var a=0;a<ra.length;a++){var b=ra[a];b.n.dirty=!0,b.n.selected=!1}ra=[],ia=null}function p(){var a={};ra.length>0&&(a.nodes=ra.map(function(a){return a.n})),null!=ia&&(a.link=ia);var b=RED.workspaces.active();ga=RED.nodes.filterLinks({source:{z:b},target:{z:b}});var c=(RED.nodes.getWorkspaceOrder(),{});ha=[];for(var d=0;d<ra.length;d++)if("link out"===ra[d].n.type||"link in"===ra[d].n.type){var e=ra[d].n,f={};e.links.forEach(function(a){var b=RED.nodes.node(a);b&&("link out"===e.type?b.z===e.z?c[e.id+":"+b.id]||(ga.push({source:e,sourcePort:0,target:b,link:!0}),c[e.id+":"+b.id]=!0):(f[b.z]=f[b.z]||[],f[b.z].push(b)):b.z===e.z?c[b.id+":"+e.id]||(ga.push({source:b,sourcePort:0,target:e,link:!0}),c[b.id+":"+e.id]=!0):(f[b.z]=f[b.z]||[],f[b.z].push(b)))});var g=Object.keys(f);g.length>0&&ha.push({refresh:Math.floor(1e4*Math.random()),node:e,links:f})}var h=JSON.stringify(a,function(a,b){return"nodes"===a?b.map(function(a){return a.id}):"link"===a?b.source.id+":"+b.sourcePort+":"+b.target.id:b});h!==Ja&&(Ja=h,RED.events.emit("view:selection-changed",a))}function q(){if(Ka=!1,ra.length>0){for(var a=[],b=0;b<ra.length;b++)a.push({n:ra[b].n,ox:ra[b].ox,oy:ra[b].oy,moved:ra[b].n.moved}),ra[b].n.moved=!0,ra[b].n.dirty=!0,delete ra[b].ox,delete ra[b].oy;I(),RED.history.push({t:"move",nodes:a,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}function r(a,b){if(ra.length>0){Ka||($(document).one("keyup",q),Ka=!0);for(var c,d=0,e=0,f=0;f<ra.length;f++)c=ra[f],c.n.moved=!0,c.n.dirty=!0,null==c.ox&&null==c.oy&&(c.ox=c.n.x,c.oy=c.n.y),c.n.x+=a,c.n.y+=b,c.n.dirty=!0,d=Math.min(c.n.x-c.n.w/2-5,d),e=Math.min(c.n.y-c.n.h/2-5,e);if(0!==d||0!==e)for(var g=0;g<ra.length;g++)c=ra[g],c.n.x-=d,c.n.y-=e;I()}}function s(){if(ra.length>0){var a=ra[0].n;"subflow"===a.type?RED.editor.editSubflow(ea):RED.editor.edit(a)}}function t(){if(ra.length>0||null!=ia){var a,b=[],c=[],e=[],f=[],g=[],h=RED.nodes.dirty();if(ra.length>0){for(var i=0;i<ra.length;i++){var j=ra[i].n;if(j.selected=!1,"subflow"!=j.type){j.x<0&&(j.x=25);var k=RED.nodes.remove(j.id);b.push(j),b=b.concat(k.nodes),c=c.concat(k.links)}else"out"===j.direction?e.push(j):"in"===j.direction&&f.push(j),j.dirty=!0}e.length>0&&(a=RED.subflow.removeOutput(e),a&&(c=c.concat(a.links))),1==f.length&&(a=RED.subflow.removeInput(),a&&(c=c.concat(a.links)));var l=RED.subflow.refresh(!0);l&&(g=l.instances),ra=[],(b.length>0||e.length>0||f.length>0)&&RED.nodes.dirty(!0)}ia&&(RED.nodes.removeLink(ia),c.push(ia),RED.nodes.dirty(!0));var m={t:"delete",nodes:b,links:c,subflowOutputs:e,subflowInputs:f,subflow:{instances:g},dirty:h};RED.history.push(m),ia=null,d(),p(),I()}}function u(){if(ra.length>0){for(var a=[],b=0;b<ra.length;b++){var c=ra[b].n;if("subflow"!=c.type){for(var d in c._def.defaults)if(c._def.defaults.hasOwnProperty(d)&&c._def.defaults[d].type){var e=RED.nodes.node(c[d]);e&&e._def.exclusive&&a.push(RED.nodes.convertNode(e))}a.push(RED.nodes.convertNode(c))}}ya=JSON.stringify(a),RED.notify(RED._("clipboard.nodeCopied",{count:a.length}))}}function v(a,b,c){return w(a,b,c,0)[0]}function w(a,b,c,d){var e=document.createElement("span");e.className=b,e.style.position="absolute",e.style.top="-1000px",e.textContent=a||"",document.body.appendChild(e);var f=e.offsetWidth,g=e.offsetHeight;return document.body.removeChild(e),[c+f,d+g]}function x(){ka=null,na=null,ja=null,qa=0,la=Ba,O=null,da=!1,d3.select(".link_splice").classed("link_splice",!1),P&&(clearTimeout(P),
P=null)}function y(a){17!==a.keyCode&&"Meta"!==a.key&&91!==a.keyCode||(x(),c(),I(),$(window).off("keyup",y))}function z(a,c,d){ka=a,la=c,ma=d||0,qa!==RED.state.QUICK_JOINING&&(qa=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(qa=RED.state.QUICK_JOINING,b([{node:ka,port:ma,portType:la}]),$(window).on("keyup",y))),d3.event.stopPropagation(),d3.event.preventDefault()}function A(a,e,f){var g;if((qa!==RED.state.QUICK_JOINING||Ia[0].node!==a)&&(document.body.style.cursor="",qa==RED.state.JOINING||qa==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(a){if(a.z==RED.workspaces.active()){var b=a.w/2,c=a.h/2;a.x-b<pa[0]&&a.x+b>pa[0]&&a.y-c<pa[1]&&a.y+c>pa[1]&&(na=a,e=na.inputs>0?Aa:Ba,f=0)}}):na=a;var h=[],i=[];for(g=0;g<Ia.length;g++)Ia[g].link&&i.push(Ia[g].link);for(g=0;g<Ia.length;g++)if(e!=Ia[g].portType&&na!==Ia[g].node){var j,k,l,m=Ia[g];m.portType===Ba?(j=m.node,l=m.port,k=na,dst_port=f):m.portType==Aa&&(j=na,l=f,k=m.node,dst_port=m.port);var n=0!==RED.nodes.filterLinks({source:j,target:k,sourcePort:l,targetPort:dst_port}).length;if(!n){var o={source:j,sourcePort:l,target:k,targetPort:dst_port};RED.nodes.addLink(o),h.push(o)}}if(h.length>0||i.length>0){var p={t:"add",links:h,removedLinks:i,dirty:RED.nodes.dirty()};if(ea){var q=RED.subflow.refresh(!0);q&&(p.subflow={id:ea.id,changed:ea.changed,instances:q.instances})}RED.history.push(p),d(),RED.nodes.dirty(!0)}if(qa===RED.state.QUICK_JOINING)return h.length>0&&(c(),e===Aa&&a.outputs>0?b([{node:a,port:0,portType:Ba}]):e===Ba&&a.inputs>0?b([{node:a,port:0,portType:Aa}]):x()),void I();x(),c(),ia=null,I()}}function B(a,b,c,d){var e=qa!=RED.state.JOINING||Ia.length>0&&Ia[0].portType!==c;a.classed("port_hovered",e)}function C(a,b,c,d){a.classed("port_hovered",!1)}function D(a){if(va&&ka==a&&xa>0&&xa<750)return qa=RED.state.DEFAULT,"subflow"!=a.type?RED.editor.edit(a):RED.editor.editSubflow(ea),xa=0,void d3.event.stopPropagation();a._def?a.inputs>0?1:0:"in"==a.direction?0:1}function E(a){if(J(),qa==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),O){var b=d3.select(O).data()[0];RED.nodes.removeLink(b);var c={source:b.source,sourcePort:b.sourcePort,target:ra[0].n},e={source:ra[0].n,sourcePort:0,target:b.target};RED.nodes.addLink(c),RED.nodes.addLink(e);var f=RED.history.peek();f.links=[c,e],f.removedLinks=[b],d()}return p(),RED.nodes.dirty(!0),I(),x(),void d3.event.stopPropagation()}if(qa==RED.state.QUICK_JOINING)return void d3.event.stopPropagation();ka=a;var g=Date.now();xa=g-wa,wa=g,va=ua==ka,ua=ka;var h;if(a.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(ka.selected=!1,h=0;h<ra.length;h+=1)if(ra[h].n===ka){ra.splice(h,1);break}}else{if(d3.event.shiftKey){o();for(var i=RED.nodes.getAllFlowNodes(ka),j=0;j<i.length;j++)i[j].selected=!0,i[j].dirty=!0,ra.push({n:i[j]})}else a.selected||(d3.event.ctrlKey||d3.event.metaKey||o(),ka.selected=!0,ra.push({n:ka}));if(ia=null,2!=d3.event.button){qa=RED.state.MOVING;var k=d3.touches(this)[0]||d3.mouse(this);for(k[0]+=a.x-a.w/2,k[1]+=a.y-a.h/2,h=0;h<ra.length;h++)ra[h].ox=ra[h].n.x,ra[h].oy=ra[h].n.y,ra[h].dx=ra[h].n.x-k[0],ra[h].dy=ra[h].n.y-k[1];oa=d3.mouse(document.body),isNaN(oa[0])&&(oa=d3.touches(document.body)[0])}}a.dirty=!0,p(),I(),d3.event.stopPropagation()}function F(a){var b=!0;return a._def.button.hasOwnProperty("enabled")&&(b="function"==typeof a._def.button.enabled?a._def.button.enabled.call(a):a._def.button.enabled),b}function G(a){if(ea)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(a._def.button.toggle&&(a[a._def.button.toggle]=!a[a._def.button.toggle],a.dirty=!0),a._def.button.onclick)try{a._def.button.onclick.call(a)}catch(b){console.log("Definition error: "+a.type+".onclick",b)}a.dirty&&I()}d3.event.preventDefault()}function H(a,b){var c=ka,d=[];d.push({name:"delete",disabled:0===ra.length&&null===ia,onselect:function(){t()}}),d.push({name:"cut",disabled:0===ra.length,onselect:function(){u(),t()}}),d.push({name:"copy",disabled:0===ra.length,onselect:function(){u()}}),d.push({name:"paste",disabled:0===ya.length,onselect:function(){K(ya,!1,!0)}}),d.push({name:"edit",disabled:1!=ra.length,onselect:function(){RED.editor.edit(c)}}),d.push({name:"select",onselect:function(){n()}}),d.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(a,b,d),x()}function I(){if(Da.attr("transform","scale("+T+")"),Ca.attr("width",Q*T).attr("height",R*T),qa!=RED.state.JOINING){var a={};if(ea){var b=Da.selectAll(".subflowoutput").data(ea.out,function(a,b){return a.id});b.exit().remove();var c=b.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(a){return"translate("+(a.x-20)+","+(a.y-20)+")"});c.each(function(a,b){a.w=40,a.h=40}),c.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",D).on("mousedown",E).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];Y=[c.pageX,c.pageY],X=0,_=setTimeout(function(){H(b,d)},W),E.call(this,a)}).on("touchend",function(a){return clearTimeout(_),_=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void D.call(this,a)}),c.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(a,b){z(a,Aa,b)}).on("touchstart",function(a,b){z(a,Aa,b)}).on("mouseup",function(a,b){A(a,Aa,b)}).on("touchend",function(a,b){A(a,Aa,b)}).on("mouseover",function(a){B(d3.select(this),a,Aa,i)}).on("mouseout",function(a){C(d3.select(this),a,Aa,i)}),c.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),c.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(a,b){return b+1});var d=Da.selectAll(".subflowinput").data(ea.in,function(a,b){return a.id});d.exit().remove();var e=d.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(a){return"translate("+(a.x-20)+","+(a.y-20)+")"});e.each(function(a,b){a.w=40,a.h=40}),e.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",D).on("mousedown",E).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];Y=[c.pageX,c.pageY],X=0,_=setTimeout(function(){H(b,d)},W),E.call(this,a)}).on("touchend",function(a){return clearTimeout(_),_=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void D.call(this,a)}),e.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(a,b){z(a,Ba,b)}).on("touchstart",function(a,b){z(a,Ba,b)}).on("mouseup",function(a,b){A(a,Ba,b)}).on("touchend",function(a,b){A(a,Ba,b)}).on("mouseover",function(a){B(d3.select(this),a,Ba,i)}).on("mouseout",function(a){C(d3.select(this),a,Ba,i)}),e.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),b.each(function(b,c){if(b.dirty){var d=d3.select(this);d.selectAll(".subflowport").classed("node_selected",function(a){return a.selected}),d.selectAll(".subflowport").classed("node_working",function(a){return a.working}),d.selectAll(".port_index").text(function(a){return a.i+1}),d.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),a[b.id]=b,b.dirty=!1}}),d.each(function(b,c){if(b.dirty){var d=d3.select(this);d.selectAll(".subflowport").classed("node_selected",function(a){return a.selected}),d.selectAll(".subflowport").classed("node_working",function(a){return a.working}),d.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),a[b.id]=b,b.dirty=!1}})}else Da.selectAll(".subflowoutput").remove(),Da.selectAll(".subflowinput").remove();var f=Da.selectAll(".nodegroup").data(fa,function(a){return a.id});f.exit().remove();var g=f.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(a){return null!=ea}).classed("node_link",function(a){return"link in"===a.type||"link out"===a.type});g.each(function(a,b){var c=d3.select(this),d="link in"===a.type||"link out"===a.type;c.attr("id",a.id);var e=RED.utils.getNodeLabel(a);if(d?a.w=V:a.w=Math.max(U,ba*Math.ceil((v(e,"node_label",50)+(a._def.inputs>0?7:0))/ba)),a.h=Math.max(Math.max(V,20*(a.outputs||0)),20*(a.inputs||0)),a._def.badge){var f=c.append("svg:g").attr("class","node_badge_group"),g=f.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);f.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(a._def.badge()),a._def.onbadgeclick&&g.attr("cursor","pointer").on("click",function(a){a._def.onbadgeclick.call(a),d3.event.preventDefault()})}if(a._def.button){var h=c.append("svg:g").attr("transform",function(a){return"translate("+("right"==a._def.align?94:-25)+",2)"}).attr("class",function(a){return"node_button "+("right"==a._def.align?"node_right_button":"node_left_button")});h.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",V-4).attr("fill","#eee"),h.append("rect").attr("class","node_button_button").attr("x",function(a){return"right"==a._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",V-12).attr("fill",function(a){return a._def.color}).attr("cursor","pointer").on("mousedown",function(a){!sa&&F(a)&&(J(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(a){!sa&&F(a)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(a){!sa&&F(a)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(a){if(!sa&&F(a)){var b=1;a._def.button.toggle&&(b=a[a._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",b)}}).on("click",G).on("touchstart",G)}c.append("rect").attr("class","node").classed("node_unknown",function(a){return"unknown"==a.type}).attr("rx",5).attr("ry",5).attr("fill",function(a){return a._def.color}).on("mouseup",D).on("mousedown",E).on("touchstart",function(a){var b=d3.select(this),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];Y=[c.pageX,c.pageY],X=0,_=setTimeout(function(){H(b,d)},W),E.call(this,a)}).on("touchend",function(a){return clearTimeout(_),_=null,RED.touch.radialMenu.active()?void d3.event.stopPropagation():void D.call(this,a)}).on("mouseover",function(a){if(0===qa){var b=d3.select(this);b.classed("node_hovered",!0)}}).on("mouseout",function(a){var b=d3.select(this);b.classed("node_hovered",!1)});if(a._def.icon){var i=RED.utils.getNodeIcon(a._def,a),j=c.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),k=(j.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(a){return Math.min(50,a.h-4)}),j.append("image").attr("xlink:href",i).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),l=j.append("path").attr("d",function(a){return"M 30 1 l 0 "+(a.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==a._def.align&&(j.attr("class","node_icon_group node_icon_group_"+a._def.align),l.attr("d",function(a){return"M 0 1 l 0 "+(a.h-2)}));var m=new Image;m.src=i,m.onload=function(){k.attr("width",Math.min(m.width,30)),k.attr("height",Math.min(m.height,30)),k.attr("x",15-Math.min(m.width,30)/2)},j.style("pointer-events","none")}if(!d){var n=c.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".40em").attr("text-anchor","start");a._def.align&&(n.attr("class","node_label node_label_"+a._def.align),"right"===a._def.align&&n.attr("text-anchor","end"));var o=(c.append("svg:text").attr("class","node_status_label_top").attr("x",7).attr("y",-3),c.append("svg:g").attr("class","node_status_group_bottom").style("display","none"));o.append("rect").attr("class","node_status_bottom").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),o.append("svg:text").attr("class","node_status_label_bottom").attr("x",20).attr("y",9)}c.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),c.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),f.each(function(b,c){if(b.dirty){var d="link in"===b.type||"link out"===b.type;if(a[b.id]=b,!d&&b.resize){var e=RED.utils.getNodeLabel(b),f=b.w;b.w=Math.max(U,ba*Math.ceil((v(e,"node_label",50)+(b._def.inputs>0?7:0))/ba)),b.h=Math.max(Math.max(V,20*(b.outputs||0)),20*(b.inputs||0)),b.x+=(b.w-f)/2,b.resize=!1}var g=d3.select(this);if(g.attr("transform",function(a){return"translate("+(a.x-a.w/2)+","+(a.y-a.h/2)+")"}),qa!=RED.state.MOVING_ACTIVE){g.selectAll(".node").attr("width",function(a){return a.w}).attr("height",function(a){return a.h}).classed("node_selected",function(a){return a.selected}).classed("node_working",function(a){return a.working}).classed("node_highlighted",function(a){return a.highlighted}),g.selectAll(".node_icon_group_right").attr("transform",function(a){return"translate("+(a.w-30)+",0)"}),g.selectAll(".node_label_right").attr("x",function(a){return a.w-38});var h=b.inputs,i=b.h/2-(h-1)/2*18;b.inputPorts=b.inputPorts||d3.range(h),b._inputPorts=g.selectAll(".port_input").data(b.inputPorts);var j=b._inputPorts.enter().append("g").attr("class","port_input");if(j.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(){var a=b;return function(b,c){z(a,Aa,c)}}()).on("touchstart",function(){var a=b;return function(b,c){z(a,Aa,c)}}()).on("mouseup",function(){var a=b;return function(b,c){A(a,Aa,c)}}()).on("touchend",function(){var a=b;return function(b,c){A(a,Aa,c)}}()).on("mouseover",function(){var a=b;return function(b,c){B(d3.select(this),a,Aa,c)}}()).on("mouseout",function(){var a=b;return function(b,c){C(d3.select(this),a,Aa,c)}}()),j.each(function(a){if(b._def&&b._def.inputInfo&&a<b._def.inputInfo.length){var c=b._def.inputInfo[a],d=i18n.t(b.namespace+"/"+b.type+".hni:"+b.type+".input"+(a+1)+"Description");if(c.types){var e=c.label?"<p><b>"+c.label+"</b></p>":"";e+="<p><i>";for(var a=0;a<c.types.length;a++)0!=a&&(e+=", "),e+=c.types[a];e+="</i></p>"+d;var f=RED.popover.create({target:$(this),trigger:"hover",width:"250px",content:e,direction:"left",offsetX:-13,offsetY:4,delay:{show:750,hide:50}});$(this).data("popover",f)}}}),b._inputPorts.exit().remove(),b._inputPorts){h=b.inputs||1,i=b.h/2-(h-1)/2*18;var k=-5;b._inputPorts.each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate("+k+","+(i+18*b-5)+")"})})}h=b.inputs,i=b.h/2-(h-1)/2*18,b.inputPortLabels&&b.inputPortLabels.length!=h&&(b.inputPortLabels=null),b.inputPortLabels=b.inputPortLabels||d3.range(h),b._inputPortLabels=g.selectAll(".port_input_label").data(b.inputPortLabels);var l=b._inputPortLabels.enter().append("g").attr("class","port_input_label");if(l.append("svg:text").attr("class","input_label").attr("rx",0).attr("ry",0).attr("width",50).attr("height",10),b._inputPortLabels.exit().remove(),b._inputPortLabels){h=b.inputs||1,i=b.h/2-(h-1)/2*18;var k=-5,m=b;b._inputPortLabels.each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate("+k+","+(i+18*b-5)+")"}),m._def&&m._def.inputInfo&&b<m._def.inputInfo.length&&m._def.inputInfo[b].label?c.selectAll(".input_label").text(m._def.inputInfo[b].label):h>1?c.selectAll(".input_label").text(b):c.selectAll(".input_label").text("")})}var n=b.outputs;i=b.h/2-(n-1)/2*18,b.outputPorts=b.outputPorts||d3.range(n),b._outputPorts=g.selectAll(".port_output").data(b.outputPorts);var o=b._outputPorts.enter().append("g").attr("class","port_output");if(o.append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(){var a=b;return function(b,c){z(a,Ba,c)}}()).on("touchstart",function(){var a=b;return function(b,c){z(a,Ba,c)}}()).on("mouseup",function(){var a=b;return function(b,c){A(a,Ba,c)}}()).on("touchend",function(){var a=b;return function(b,c){A(a,Ba,c)}}()).on("mouseover",function(){var a=b;return function(b,c){B(d3.select(this),a,Ba,c)}}()).on("mouseout",function(){var a=b;return function(b,c){C(d3.select(this),a,Ba,c)}}()),o.each(function(a){if(b._def&&b._def.outputInfo&&a<b._def.outputInfo.length){var c=b._def.outputInfo[a],d=i18n.t(b.namespace+"/"+b.type+".hni:"+b.type+".output"+(a+1)+"Description");if(c.types){var e=c.label?"<p><b>"+c.label+"</b></p>":"";e+="<p><i>";for(var a=0;a<c.types.length;a++)0!=a&&(e+=", "),e+=c.types[a];e+="</i></p>"+d;var f=RED.popover.create({target:$(this),trigger:"hover",width:"250px",content:e,offsetX:10,offsetY:4,delay:{show:750,hide:50}});$(this).data("popover",f)}}}),b._outputPorts.exit().remove(),b._outputPorts){n=b.outputs||1,i=b.h/2-(n-1)/2*18;var k=b.w-5;b._outputPorts.each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate("+k+","+(i+18*b-5)+")"})})}n=b.outputs,i=b.h/2-(n-1)/2*18,b.outputPortLabels&&b.outputPortLabels.length!=n&&(b.outputPortLabels=null),b.outputPortLabels=b.outputPortLabels||d3.range(n),b._outputPortLabels=g.selectAll(".port_output_label").data(b.outputPortLabels);var p=b._outputPortLabels.enter().append("g").attr("class","port_output_label");if(p.append("svg:text").attr("class","output_label").attr("rx",0).attr("ry",0).attr("width",50).attr("height",10),b._outputPortLabels.exit().remove(),b._outputPortLabels){n=b.outputs||1,i=b.h/2-(n-1)/2*18;var k=b.w+5,m=b;b._outputPortLabels.each(function(a,b){var c=d3.select(this);c.attr("transform",function(a){return"translate("+k+","+(i+18*b-5)+")"}),m._def&&m._def.outputInfo&&b<m._def.outputInfo.length&&m._def.outputInfo[b].label?c.selectAll(".input_label").text(m._def.outputInfo[b].label):n>1?c.selectAll(".output_label").text(b):c.selectAll(".output_label").text("")})}if(g.selectAll("text.node_label").text(function(a,b){var c="";if(a._def.label){c=a._def.label;try{c=("function"==typeof c?c.call(a):c)||"",c=RED.text.bidi.enforceTextDirectionWithUCC(c)}catch(b){console.log("Definition error: "+a.type+".label",b),c=a.type}}return c}).attr("y",function(a){return a.h/2-1}).attr("class",function(a){var b="";if(a._def.labelStyle){b=a._def.labelStyle;try{b=("function"==typeof b?b.call(a):b)||""}catch(c){console.log("Definition error: "+a.type+".labelStyle",c),b=""}b=" "+b}return"node_label"+(a._def.align?" node_label_"+a._def.align:"")+b}),b._def.icon){icon=g.select(".node_icon");var q=icon.attr("xlink:href"),r=RED.utils.getNodeIcon(b._def,b);if(r!==q){icon.attr("xlink:href",r);var s=new Image;s.src=r,s.onload=function(){icon.attr("width",Math.min(s.width,30)),icon.attr("height",Math.min(s.height,30)),icon.attr("x",15-Math.min(s.width,30)/2)}}}g.selectAll(".node_tools").attr("x",function(a){return a.w-35}).attr("y",function(a){return a.h-20}),g.selectAll(".node_changed").attr("x",function(a){return a.w-10}).classed("hidden",function(a){return!a.changed}),g.selectAll(".node_error").attr("x",function(a){return a.w-10-(a.changed?13:0)}).classed("hidden",function(a){return a.valid}),g.selectAll(".node_icon").attr("y",function(a){return(a.h-d3.select(this).attr("height"))/2}),g.selectAll(".node_icon_shade").attr("height",function(a){return a.h}),g.selectAll(".node_icon_shade_border").attr("d",function(a){return"M "+("right"==a._def.align?0:30)+" 1 l 0 "+(a.h-2)}),g.selectAll(".node_button").attr("opacity",function(a){return ea||!F(a)?.4:1}),g.selectAll(".node_button_button").attr("cursor",function(a){return ea||!F(a)?"":"pointer"}),g.selectAll(".node_right_button").attr("transform",function(a){var b=a.w-6;return a._def.button.toggle&&!a[a._def.button.toggle]&&(b-=8),"translate("+b+",2)"}),g.selectAll(".node_right_button rect").attr("fill-opacity",function(a){return a._def.button.toggle?a[a._def.button.toggle]?1:.2:1}),g.selectAll(".node_badge_group").attr("transform",function(a){return"translate("+(a.w-40)+","+(a.h+3)+")"}),g.selectAll("text.node_badge_label").text(function(a,b){if(a._def.badge){if("function"!=typeof a._def.badge)return a._def.badge;try{return a._def.badge.call(a)}catch(b){return console.log("Definition error: "+a.type+".badge",b),""}}return""})}if(ta&&b.statusTop?b.statusTop.text&&g.selectAll(".node_status_label_top").style("display","inline").text(b.statusTop.text):g.selectAll(".node_status_label_top").style("display","none"),ta&&b.statusBottom){g.selectAll(".node_status_group_bottom").style("display","inline").attr("transform","translate(3,"+(b.h+3)+")");var t=za[b.statusBottom.fill];if(null==b.statusBottom.shape&&null==t)g.selectAll(".node_status_bottom").style("display","none");else{var u;null==b.statusBottom.shape||"dot"==b.statusBottom.shape?u={display:"inline",fill:t,stroke:t}:"ring"==b.statusBottom.shape&&(u={display:"inline",fill:"#fff",stroke:t}),g.selectAll(".node_status_bottom").style(u)}b.statusBottom.text?(g.selectAll(".node_status_label_bottom").text(b.statusBottom.text),null==b.statusBottom.shape&&null==t?g.selectAll(".node_status_label_bottom").attr("x",0):g.selectAll(".node_status_label_bottom").attr("x",20)):g.selectAll(".node_status_label_bottom").text("")}else g.selectAll(".node_status_group_bottom").style("display","none");b.dirty=!1}});var h=Da.selectAll(".link").data(ga,function(a){a.target.id;return a.source.id+":"+a.sourcePort+":"+a.target.id+":"+a.targetPort+":"+a.target.i}),j=h.enter().insert("g",".node").attr("class","link");j.each(function(a,b){var c=d3.select(this);a.added=!0,c.append("svg:path").attr("class","link_background link_path").on("mousedown",function(a){ja=a,o(),ia=ja,p(),I(),J(),d3.event.stopPropagation()}).on("touchstart",function(a){ja=a,o(),ia=ja,p(),I(),J(),d3.event.stopPropagation();var b=d3.select(document.body),c=d3.event.touches.item(0),d=[c.pageX,c.pageY];_=setTimeout(function(){_=null,H(b,d)},W)}),c.append("svg:path").attr("class","link_outline link_path"),c.append("svg:path").attr("class","link_line link_path").classed("link_link",function(a){return a.link}).classed("link_subflow",function(a){return!a.link&&ea})}),h.exit().remove();var k=Da.selectAll(".link_path");k.each(function(b){var c=d3.select(this);(b.added||b===ia||b.selected||a[b.source.id]||a[b.target.id])&&c.attr("d",function(a){var b=a.source.outputs||1,c=a.target.inputs||1,d=a.sourcePort||0,e=a.targetPort||0;"subflow"==a.source.type&&(b=1,d=0),"subflow"==a.target.type&&(c=1,e=0);var f=18*-((b-1)/2)+18*d,g=18*-((c-1)/2)+18*e,h=a.target.y-(a.source.y+f),i=a.target.x-a.target.w/2-(a.source.x+a.source.w/2),j=Math.sqrt(h*h+i*i),k=S,l=0;return j<U&&(k=.75-.75*((U-j)/U)),i<0&&(k+=2*(Math.min(5*U,Math.abs(i))/(5*U)),Math.abs(h)<3*V&&(l=(h>0?.5:-.5)*((3*V-Math.abs(h))/(3*V))*(Math.min(U,Math.abs(i))/U))),a.x1=a.source.x+a.source.w/2,a.y1=a.source.y+f,a.x2=a.target.x-a.target.w/2,a.y2=a.target.y+g,"M "+a.x1+" "+a.y1+" C "+(a.x1+k*U)+" "+(a.y1+l*V)+" "+(a.x2-k*U)+" "+(a.y2-l*V)+" "+a.x2+" "+a.y2})}),h.classed("link_selected",function(a){return a===ia||a.selected}),h.classed("link_working",function(a){return a.working}),h.classed("link_unknown",function(a){return delete a.added,"unknown"==a.target.type||"unknown"==a.source.type});var l=Da.selectAll(".link_flow_link_g").data(ha,function(a){return a.node.id+":"+a.refresh}),m=l.enter().insert("g",".node").attr("class","link_flow_link_g");m.each(function(a,b){var c=d3.select(this),d=1,e="start";"link in"===a.node.type&&(d=-1,e="end");var f=30*d,g=20*d,h=(c.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+f),a.links),i=Object.keys(h),j=RED.nodes.getWorkspaceOrder();i.sort(function(a,b){return j.indexOf(a)-j.indexOf(b)});var k=10,l=V,m=-(i.length-1)*l/2,n=c.selectAll(".link_group").data(i),o=n.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(b){d3.event.stopPropagation();var c=a.links[b];RED.workspaces.show(b),c.forEach(function(a){a.selected=!0,a.dirty=!0,ra.push({n:a})}),p(),I()});o.each(function(a){var b=d3.select(this);b.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+f+" 0 C "+(f+1.7*g)+" 0 "+(f+.1*g)+" "+m+" "+(f+1.5*g)+" "+m+" "),b.append("svg:path").attr("class","link_port").attr("d","M "+(f+1.5*g+d*(k+7))+" "+(m-12)+" h "+-d*k+" a 3 3 45 0 "+(1===d?"0":"1")+" "+d*-3+" 3 v 18 a 3 3 45 0 "+(1===d?"0":"1")+" "+3*d+" 3 h "+d*k),b.append("svg:path").attr("class","link_port").attr("d","M "+(f+1.5*g+d*(k+10))+" "+(m-12)+" h "+d*(3*k)+" M "+(f+1.5*g+d*(k+10))+" "+(m+12)+" h "+d*(3*k)).style("stroke-dasharray","12 3 8 4 3"),b.append("rect").attr("class","port link_port").attr("x",f+1.5*g-4+4*d).attr("y",m-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),b.append("rect").attr("x",f+1.5*g-(d===-1?U:0)).attr("y",m-12).attr("width",U).attr("height",24).style("stroke","none").style("fill","transparent");var c,h=RED.nodes.workspace(a);h&&(c=h.label||h.id),b.append("svg:text").attr("class","port_label").attr("x",f+1.5*g+15*d).attr("y",m+1).style("font-size","10px").style("text-anchor",e).text(c),m+=l}),n.exit().remove()}),l.exit().remove(),l=Da.selectAll(".link_flow_link_g"),l.each(function(a){var b=1;"link in"===a.node.type&&(b=-1);var c=d3.select(this);c.attr("transform",function(a){return"translate("+(a.node.x+b*a.node.w/2)+","+a.node.y+")"})})}else Da.selectAll(".link_selected").data(ga,function(a){return a.source.id+":"+a.sourcePort+":"+a.target.id+":"+a.targetPort+":"+a.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function J(){try{var a=window.parent.window.scrollX,b=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(a,b)}catch(a){$("#chart").focus()}}function K(a,b,c){try{var e;ea&&(e=ea.changed);var f=RED.nodes.import(a,!0,b);if(f){var g=f[0],h=f[1],i=f[2],j=f[3],k=f[4];b&&k&&RED.workspaces.show(k.id);var l=g.filter(function(a){return a.hasOwnProperty("x")&&a.hasOwnProperty("y")&&a.z==RED.workspaces.active()}).map(function(a){return{n:a}}),m=g.map(function(a){return a.id});if(l.length>0){var n=l[0].n,p=n.x,q=n.y;null==pa&&(pa=[0,0]);var r,s,t=0,u=0;for(r=0;r<l.length;r++)s=l[r],s.n.selected=!0,s.n.changed=!0,s.n.moved=!0,s.n.x-=p-pa[0],s.n.y-=q-pa[1],s.dx=s.n.x-pa[0],s.dy=s.n.y-pa[1],t=Math.min(s.n.x-U/2-5,t),u=Math.min(s.n.y-V/2-5,u);for(r=0;r<l.length;r++)if(s=l[r],s.n.x-=t,s.n.y-=u,s.dx-=t,s.dy-=u,s.n._def.onadd)try{s.n._def.onadd.call(s.n)}catch(a){console.log("onadd:",a)}c||(qa=RED.state.IMPORT_DRAGGING,da=!1,1===l.length&&(s=l[0],da=s.n.hasOwnProperty("_def")&&s.n._def.inputs>0&&s.n._def.outputs>0)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),o(),RED.history.pop(),qa=0}),o(),ra=l}var v={t:"add",nodes:m,links:h,workspaces:i,subflows:j,dirty:RED.nodes.dirty()};if(0===l.length&&RED.nodes.dirty(!0),ea){var w=RED.subflow.refresh(!0);w&&(v.subflow={id:ea.id,changed:e,instances:w.instances})}RED.history.push(v),d(),I()}}catch(a){"NODE_RED"!=a.code?(console.log(a.stack),RED.notify(RED._("notification.error",{message:a.toString()}),"error")):RED.notify(RED._("notification.error",{message:a.message}),"error")}}function L(a){a?Ga.style("visibility","visible"):Ga.style("visibility","hidden")}function M(a){ca=a,I()}function N(a){ta=a,RED.nodes.eachNode(function(a){a.dirty=!0}),I()}var O,P,Q=5e3,R=5e3,S=.75,T=1,U=100,V=30,W=1e3,X=0,Y=[],Z=[],_=0,aa={},ba=10,ca=!1,da=!1,ea=null,fa=[],ga=[],ha=[],ia=null,ja=null,ka=null,la=null,ma=0,na=null,oa=[0,0],pa=null,qa=0,ra=[],sa=null,ta=!1,ua=null,va=null,wa=0,xa=0,ya="",za={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},Aa=1,Ba=0,Ca=d3.select("#chart").append("svg:svg").attr("width",Q).attr("height",R).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){J()}),Da=Ca.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",h).on("mousedown",g).on("mouseup",j).on("touchend",function(){clearTimeout(_),_=null,RED.touch.radialMenu.active()||(sa&&Ea.attr("fill","#fff"),j.call(this))}).on("touchcancel",j).on("touchstart",function(){var a;if(d3.event.touches.length>1){clearTimeout(_),_=null,d3.event.preventDefault(),a=d3.event.touches.item(0);var b=d3.event.touches.item(1),c=a.pageY-b.pageY,d=a.pageX-b.pageX,e=$("#chart").offset(),f=[$("#chart").scrollLeft(),$("#chart").scrollTop()];Y=[(b.pageX+d/2-e.left+f[0])/T,(b.pageY+c/2-e.top+f[1])/T],Z=[b.pageX+d/2,b.pageY+c/2],X=Math.sqrt(c*c+d*d)}else{var g=d3.select(document.body);a=d3.event.touches.item(0);var h=[a.pageX,a.pageY];Y=[a.pageX,a.pageY],X=0;d3.touches(this)[0];_=setTimeout(function(){_=null,H(g,h)},W)}}).on("touchmove",function(){if(RED.touch.radialMenu.active())return void d3.event.preventDefault();var a;if(d3.event.touches.length<2){if(_){a=d3.event.touches.item(0);var b=a.pageX-Y[0],c=a.pageY-Y[1],d=Math.abs(b*b+c*c);d>64&&(clearTimeout(_),_=null)}else sa&&d3.event.preventDefault();h.call(this)}else{a=d3.event.touches.item(0);var e=d3.event.touches.item(1),f=a.pageY-e.pageY,g=a.pageX-e.pageX,i=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),j=Math.sqrt(f*f+g*g),k=[e.pageX+g/2,e.pageY+f/2];if(!isNaN(j)){oldScaleFactor=T,T=Math.min(2,Math.max(.3,T+Math.floor(100*j-100*X)/1e4));var l=[Y[0]*(T-oldScaleFactor),Y[1]*(T-oldScaleFactor)];X=j,Z=k,$("#chart").scrollLeft(i[0]+l[0]),$("#chart").scrollTop(i[1]+l[1]),I()}}}),Ea=Da.append("svg:rect").attr("width",Q).attr("height",R).attr("fill","#fff"),Fa=d3.scale.linear().range([0,Q]).domain([0,Q]),Ga=Da.append("g");Ga.selectAll("line.horizontal").data(Fa.ticks(Q/ba)).enter().append("line").attr({class:"horizontal",x1:0,x2:Q,y1:function(a){return Fa(a)},y2:function(a){return Fa(a)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),Ga.selectAll("line.vertical").data(Fa.ticks(Q/ba)).enter().append("line").attr({class:"vertical",y1:0,y2:Q,x1:function(a){return Fa(a)},x2:function(a){return Fa(a)},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),Ga.style("visibility","hidden"),a();var Ha=Da.append("g"),Ia=[],Ja=null,Ka=!1;return{init:e,state:function(a){return null==a?qa:void(qa=a)},redraw:function(a){a&&(d(),p()),I()},focus:J,importNodes:K,calculateTextWidth:v,select:function(a){if("undefined"!=typeof a&&(o(),"string"==typeof a)){var b=RED.nodes.node(a);b&&(b.selected=!0,b.dirty=!0,ra=[{n:b}])}p(),I()},selection:function(){var a={};return ra.length>0&&(a.nodes=ra.map(function(a){return a.n})),null!=ia&&(a.link=ia),a},scale:function(){return T},getLinksAtPoint:function(a,b){for(var c=[],d=Ca.selectAll(".link_background")[0],e=0;e<d.length;e++){var f=d[e].getBBox();a>=f.x&&b>=f.y&&a<=f.x+f.width&&b<=f.y+f.height&&c.push(d[e])}return c},reveal:function(a){if(RED.nodes.workspace(a)||RED.nodes.subflow(a))RED.workspaces.show(a);else{var b=RED.nodes.node(a);if("config"!==b._def.category&&b.z){b.highlighted=!0,b.dirty=!0,RED.workspaces.show(b.z);var c=[$("#chart").width(),$("#chart").height()],d=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(b.x<d[0]||b.y<d[1]||b.x>c[0]+d[0]||b.y>c[1]+d[1]){var e="-="+(d[0]-b.x+c[0]/2),f="-="+(d[1]-b.y+c[1]/2);$("#chart").animate({scrollLeft:e,scrollTop:f},200)}if(!b._flashing){b._flashing=!0;var g=22,h=function(){g--,b.dirty=!0,g>=0?(b.highlighted=!b.highlighted,
setTimeout(h,100)):(b.highlighted=!1,delete b._flashing),RED.view.redraw()};h()}}else"config"===b._def.category&&RED.sidebar.config.show(a)}},gridSize:function(b){return void 0===b?ba:(ba=b,void a())}}}(),RED.sidebar=function(){function a(a,b,c,e){var f;"string"==typeof a?f={id:b.id,label:a,name:a,content:b,closeable:c,visible:e}:"object"==typeof a&&(f=a),f.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),f.wrapper.append(f.content),f.wrapper.hide(),f.enableOnEdit||(f.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(f.wrapper)),f.toolbar&&($("#sidebar-footer").append(f.toolbar),$(f.toolbar).hide());f.id;RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+f.id,label:f.name,onselect:function(){d(f.id)},group:"sidebar-tabs"}),h[f.id]=f,f.visible!==!1&&g.addTab(h[f.id])}function b(a){g.removeTab(a),$(h[a].wrapper).remove(),h[a].footer&&h[a].footer.remove(),delete h[a],RED.menu.removeItem("menu-item-view-menu-"+a)}function c(a){a?($("#main-container").removeClass("sidebar-closed"),g.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function d(a){a&&(e(a)||g.addTab(h[a]),g.activateTab(a),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function e(a){return g.contains(a)}function f(){RED.actions.add("core:toggle-sidebar",function(a){void 0===a?RED.menu.toggleSelected("menu-item-sidebar"):c(a)}),d(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)}var g=RED.tabs.create({id:"sidebar-tabs",onchange:function(a){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),a.onchange&&a.onchange.call(a),$(a.wrapper).show(),a.toolbar&&$(a.toolbar).show()},onremove:function(a){$(a.wrapper).hide(),a.onremove&&a.onremove.call(a)},minimumActiveTabWidth:110}),h={},i={};return $("#sidebar-separator").draggable({axis:"x",start:function(a,b){i.closing=!1,i.opening=!1;var c=$(window).width();if(i.start=b.position.left,i.chartWidth=$("#workspace").width(),i.chartRight=c-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){i.opening=!0;var d=7;$("#sidebar").addClass("closing"),$("#workspace").css("right",d),$("#editor-stack").css("right",d+1),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}i.width=$("#sidebar").width()},drag:function(a,b){var c=b.position.left-i.start,d=i.width-c;i.opening&&(d-=3),d>150&&i.chartWidth+c<200&&(b.position.left=200+i.start-i.chartWidth,c=b.position.left-i.start,d=i.width-c),d<150?(i.closing||($("#sidebar").addClass("closing"),i.closing=!0),i.opening||(d=150,b.position.left=i.width-(150-i.start),c=b.position.left-i.start)):d>150&&(i.closing||i.opening)&&(i.closing=!1,$("#sidebar").removeClass("closing"));var e=i.chartRight-c;$("#workspace").css("right",e),$("#editor-stack").css("right",e+1),$("#sidebar").width(d),g.resize(),RED.events.emit("sidebar:resize")},stop:function(a,b){i.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:f,addTab:a,removeTab:b,show:d,containsTab:e,toggleSidebar:c}}(),RED.palette=function(){function a(a,b){b=b||a.replace("_"," ");var c=$('<div id="palette-container-'+a+'" class="palette-category palette-close hide"><div id="palette-header-'+a+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+b+'</span></div><div class="palette-content" id="palette-base-category-'+a+'"><div id="palette-'+a+'-input"></div><div id="palette-'+a+'-output"></div><div id="palette-'+a+'-function"></div></div></div>').appendTo("#palette-container");m[a]={container:c,close:function(){c.removeClass("palette-open"),c.addClass("palette-closed"),$("#palette-base-category-"+a).slideUp(),$("#palette-header-"+a+" i").removeClass("expanded")},open:function(){c.addClass("palette-open"),c.removeClass("palette-closed"),$("#palette-base-category-"+a).slideDown(),$("#palette-header-"+a+" i").addClass("expanded")},toggle:function(){c.hasClass("palette-open")?m[a].close():m[a].open()}},$("#palette-header-"+a).on("click",function(b){m[a].toggle()})}function b(a,b,c,d,e){for(var f=82,g=20,h=c.split(/[ -]/),i=[],j=h[0],k=RED.view.calculateTextWidth(j,"palette_label",0),l=1;l<h.length;l++){var m=RED.view.calculateTextWidth(j+" "+h[l],"palette_label",0);m<f?(j+=" "+h[l],k=m):(i.push(j),j=h[l],k=RED.view.calculateTextWidth(j,"palette_label",0))}i.push(j);var n=i.join("<br/>"),o=8+g*i.length;b.css({height:o+"px"});var p=b.find(".palette_label");p.html(n).attr("dir",RED.text.bidi.resolveBaseTextDir(n)),b.find(".palette_port").css({top:o/2-5+"px"});var q;try{var r="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(c)+"</b></p>";c!=a&&(r="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(c)+"</b><br/><i>"+a+"</i></p>");var s=i18n.t(e+"/"+a+".hni:"+a+".paletteHelp");q=$(r+(d?d:s||"<p>"+RED._("palette.noInfo")+"</p>").trim())}catch(b){console.log("Error generating pop-over label for ",a),console.log(b.toString()),q="<p><b>"+c+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}b.data("popover").setContent(q)}function c(a){return a.replace(" ","_").replace(".","_").replace(":","_")}function d(d,e){var f=c(d);if(!$("#palette_node_"+f).length&&k.indexOf(e.category)===-1){var g=e.category.replace(" ","_"),h=g.split("-")[0],i=document.createElement("div");i.id="palette_node_"+f,i.type=d,i.namespace=e.namespace?e.namespace:d;var j=/^(.*?)([ -]in|[ -]out)?$/.exec(d)[1];if("undefined"!=typeof e.paletteLabel)try{j=("function"==typeof e.paletteLabel?e.paletteLabel.call(e):e.paletteLabel)||""}catch(a){console.log("Definition error: "+d+".paletteLabel",a)}if($("<div/>",{class:"palette_label"+("right"==e.align?" palette_label_right":"")}).appendTo(i),i.className="palette_node",e.icon){var n=RED.utils.getNodeIcon(e),o=$("<div/>",{class:"palette_icon_container"+("right"==e.align?" palette_icon_container_right":"")}).appendTo(i);$("<div/>",{class:"palette_icon",style:"background-image: url("+n+")"}).appendTo(o)}if(i.style.backgroundColor=e.color,e.outputs>0){var p=document.createElement("div");p.className="palette_port palette_port_output",i.appendChild(p)}if(e.inputs>0){var q=document.createElement("div");q.className="palette_port palette_port_input",i.appendChild(q)}if(0===$("#palette-base-category-"+h).length)if(l.indexOf(h)!==-1)a(h,RED._("node-red:palette.label."+h,{defaultValue:h}));else{var r=e.set.id;a(h,RED._(r+":palette.label."+h,{defaultValue:h}))}$("#palette-container-"+h).show(),0===$("#palette-"+g).length&&$("#palette-base-category-"+h).append('<div id="palette-'+g+'"></div>'),$("#palette-"+g).append(i),i.onmousedown=function(a){a.preventDefault()};var s=RED.popover.create({target:$(i),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(i).data("popover",s),$(i).click(function(){RED.view.focus();var a;a=0===d.indexOf("subflow:")?marked(RED.nodes.subflow(d.substring(8)).info||""):i18n.t((e.namespace?e.namespace:d)+"/"+d+".hni:"+d+".help");var b='<div class="node-help">'+a+"</div>";RED.sidebar.info.set(b)});var t,u,v,w,x=$("#chart"),y=x.offset(),z=$("#chart>svg").get(0);$(i).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),w&&(clearTimeout(w),w=null)},drag:function(a,b){b.position.left+=17.5,e.inputs>0&&e.outputs>0&&(u=b.position.left+b.helper.width()/2-y.left+x.scrollLeft(),v=b.position.top+b.helper.height()/2-y.top+x.scrollTop(),w||(w=setTimeout(function(){var a=[],c=1/0,d=null;if(z.getIntersectionList){var e=z.createSVGRect();e.x=u,e.y=v,e.width=1,e.height=1,a=z.getIntersectionList(e,z),u/=RED.view.scale(),v/=RED.view.scale()}else u/=RED.view.scale(),v/=RED.view.scale(),a=RED.view.getLinksAtPoint(u,v);for(var f=0;f<a.length;f++)if(d3.select(a[f]).classed("link_background"))for(var g=a[f].getTotalLength(),h=0;h<g;h+=10){var i=a[f].getPointAtLength(h),j=(i.x-u)*(i.x-u)+(i.y-v)*(i.y-v);j<200&&j<c&&(c=j,d=a[f])}t&&t!==d&&d3.select(t.parentNode).classed("link_splice",!1),d?d3.select(d.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),t!==d&&(d?$(b.helper).data("splice",d3.select(d).data()[0]):$(b.helper).removeData("splice")),t=d,w=null},200)))}});var A=null;"subflows"==e.category&&($(i).dblclick(function(a){RED.workspaces.show(d.substring(8)),a.preventDefault()}),A=marked(e.info||"")),b(d,$(i),j,A,e.namespace?e.namespace:d);var B=$("#palette-container-"+g);1===B.find(".palette_node").length&&m[g].open()}}function e(a){var b=c(a),d=$("#palette_node_"+b),e=d.closest(".palette-category");d.remove(),0===e.find(".palette_node").length&&e.find("i").hasClass("expanded")&&(e.find(".palette-content").slideToggle(),e.find("i").toggleClass("expanded"))}function f(a){var b=c(a);$("#palette_node_"+b).hide()}function g(a){var b=c(a);$("#palette_node_"+b).show()}function h(){RED.nodes.eachSubflow(function(a){var c=$("#palette_node_subflow_"+a.id.replace(".","_")),d=c.find(".palette_port_input"),e=c.find(".palette_port_output");if(0===d.length&&a.in.length>0){var f=document.createElement("div");f.className="palette_port palette_port_input",c.append(f)}else 0!==d.length&&0===a.in.length&&d.remove();if(0===e.length&&a.out.length>0){var g=document.createElement("div");g.className="palette_port palette_port_output",c.append(g)}else 0!==e.length&&0===a.out.length&&e.remove();b(a.type+":"+a.id,c,a.name,marked(a.info||""),a.type+":"+a.id)})}function i(a){var b=new RegExp(a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");$("#palette-container .palette_node").each(function(c,d){var e=$(d).find(".palette_label").text();""===a||b.test(d.id)||b.test(e)?$(this).show():$(this).hide()});for(var c in m)m.hasOwnProperty(c)&&(0===m[c].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?m[c].close():m[c].open())}function j(){RED.events.on("registry:node-type-added",function(a){var b=RED.nodes.getType(a);d(a,b),b.onpaletteadd&&"function"==typeof b.onpaletteadd&&b.onpaletteadd.call(b)}),RED.events.on("registry:node-type-removed",function(a){e(a)}),RED.events.on("registry:node-set-enabled",function(a){for(var b=0;b<a.types.length;b++){g(a.types[b]);var c=RED.nodes.getType(a.types[b]);c.onpaletteadd&&"function"==typeof c.onpaletteadd&&c.onpaletteadd.call(c)}}),RED.events.on("registry:node-set-disabled",function(a){for(var b=0;b<a.types.length;b++){f(a.types[b]);var c=RED.nodes.getType(a.types[b]);c.onpaletteremove&&"function"==typeof c.onpaletteremove&&c.onpaletteremove.call(c)}}),RED.events.on("registry:node-set-removed",function(a){if(a.added)for(var b=0;b<a.types.length;b++){e(a.types[b]);var c=RED.nodes.getType(a.types[b]);c.onpaletteremove&&"function"==typeof c.onpaletteremove&&c.onpaletteremove.call(c)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){i($(this).val())}});var b=l;RED.settings.paletteCategories?b=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(b=RED.settings.theme("palette.categories")),Array.isArray(b)||(b=l),b.forEach(function(b){a(b,RED._("palette.label."+b,{defaultValue:b}))}),$("#palette-collapse-all").on("click",function(a){a.preventDefault();for(var b in m)m.hasOwnProperty(b)&&m[b].close()}),$("#palette-expand-all").on("click",function(a){a.preventDefault();for(var b in m)m.hasOwnProperty(b)&&m[b].open()})}var k=["config","unknown","deprecated"],l=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],m={};return{init:j,add:d,remove:e,hide:f,show:g,refresh:h}}(),RED.sidebar.info=function(){function a(){g=document.createElement("div"),g.className="sidebar-node-info",RED.actions.add("core:show-info-tab",b);var a=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(g);h=RED.stack.create({container:a}).hide(),i=h.add({title:"Node",collapsible:!1}),j=h.add({title:"Information",collapsible:!1}),j.content.css("padding","6px"),j.container.css("border-bottom","none");var c=$('<div class="node-info-tips"></div>').appendTo(g);k=$('<div class="node-info-tip"></div>').appendTo(c);var d=$('<div class="node-info-tips-buttons"></div>').appendTo(c),e=$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(d);e.click(function(a){a.preventDefault(),m.next()});var f=$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(d);f.click(function(a){a.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:g,enableOnEdit:!0}),m.enabled()?m.start():m.stop()}function b(){RED.sidebar.show("info")}function c(a){return $(a).find("a").each(function(a){var b=$(this).attr("href");/^https?:/.test(b)&&$(this).attr("target","_blank")}),a}function d(a){h.show(),$(i.content).empty(),$(j.content).empty();var b,d,e=$('<table class="node-info"></table>'),f=$("<tbody>").appendTo(e);if("tab"===a.type)i.title.html("Flow"),b=$('<tr class="node-info-node-row"><td>Name</td><td></td></tr>').appendTo(f),$(b.children()[1]).html("&nbsp;"+(a.label||"")),b=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.id")+"</td><td></td></tr>").appendTo(f),RED.utils.createObjectElement(a.id).appendTo(b.children()[1]),b=$('<tr class="node-info-node-row"><td>Status</td><td></td></tr>').appendTo(f),$(b.children()[1]).html(a.disabled?"Disabled":"Enabled");else{i.title.html("Node"),"subflow"!==a.type&&a.name&&$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+'</td><td>&nbsp;<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(a.name)+'">'+a.name+"</span></td></tr>").appendTo(f),$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td>&nbsp;"+a.type+"</td></tr>").appendTo(f),b=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.id")+"</td><td></td></tr>").appendTo(f),RED.utils.createObjectElement(a.id).appendTo(b.children()[1]);var g=/^subflow(:(.+))?$/.exec(a.type);if(!g&&"subflow"!=a.type&&"comment"!=a.type&&a._def){var k=0,m=a._def.defaults;for(var n in m)if("name"!=n&&m.hasOwnProperty(n)){var o=a[n];if(k++,b=$('<tr class="node-info-property-row'+(l.property?"":" hide")+'"><td>'+n+"</td><td></td></tr>").appendTo(f),m[n].type){var p=RED.nodes.node(o);if(p){var q=RED.utils.getNodeLabel(p,o),r=b.children()[1],s=$("<span>",{class:""}).appendTo(r),t=$("<div>",{class:"palette_node palette_node_small"}).appendTo(s),u=p._def.color,v=RED.utils.getNodeIcon(p._def);t.css({backgroundColor:u,cursor:"pointer"});var w=$("<div/>",{class:"palette_icon_container"}).appendTo(t);$("<div/>",{class:"palette_icon",style:"background-image: url("+v+")"}).appendTo(w);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).html(q).appendTo(r);t.on("dblclick",function(){RED.editor.editConfig("",p.type,p.id)})}else RED.utils.createObjectElement(void 0).appendTo(b.children()[1])}else RED.utils.createObjectElement(o).appendTo(b.children()[1])}k>0&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(l.property?" expanded":"")+'"><span class="node-info-property-show-more">show more</span><span class="node-info-property-show-less">show less</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(f)}if(g){d=g[2]?RED.nodes.subflow(g[2]):a,$('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(f);var x=0,y="subflow:"+d.id;RED.nodes.eachNode(function(a){a.type===y&&x++}),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(d.name)+'">'+d.name+"</span></td></tr>").appendTo(f),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+x+"</td></tr>").appendTo(f)}}$(e).appendTo(i.content);var z="";if(d||"comment"===a.type||"tab"===a.type)"tab"===a.type&&(z=marked(a.info||""));else{var A=i18n.t((a._def.namespace?a._def.namespace:a.type)+"/"+a.type+".hni:"+a.type+".help");z=A}if(d)z+=marked(d.info||"");else if(a._def&&a._def.info){var B=a._def.info,C="function"==typeof B?B.call(a):B;z+=marked(C)}if(z){var B=c($('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(z)+'">'+z+"</span></div>")).appendTo(j.content);B.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");var D="H3";B.find(D).wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(a){a.preventDefault();for(var b=$(this).hasClass("expanded"),c=$(this).parent().next();1===c.length&&c[0].nodeName!==D;)c.toggle(!b),c=c.next();$(this).toggleClass("expanded",!b)})}$(".node-info-property-header").click(function(a){a.preventDefault(),l.property=!l.property,$(this).toggleClass("expanded",l.property),$(".node-info-property-row").toggle(l.property)})}function e(){h.hide()}function f(a){h.show(),i.container.hide();var b=$('<div class="node-help"></div>').html(a);$(j.content).empty().append(b)}marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var g,h,i,j,k,l={property:!1},m=function(){function a(){for(var a,c=Math.floor(Math.random()*l),d=RED._("infotips:info.tip"+c);a=/({{(.*?)}})/.exec(d);){var e=RED.keyboard.getShortcut(a[2]);if(!e)return;d=d.replace(a[1],RED.keyboard.formatKey(e.key))}for(;a=/(\[(.*?)\])/.exec(d);)d=d.replace(a[1],RED.keyboard.formatKey(a[2]));k.html(d).fadeIn(200),f&&(f=null,g=setInterval(b,j))}function b(){k.fadeOut(300,function(){a()})}function c(){if($(".sidebar-node-info").addClass("show-tips"),h&&!f&&!g){if(l===-1)do l++;while(RED._("infotips:info.tip"+l)!=="infotips:info.tip"+l);f=setTimeout(a,i)}}function d(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(g),clearTimeout(f),g=null,f=null}function e(){clearInterval(g),f=!0,a()}var f,g,h=!0,i=1e3,j=15e3,l=-1;return RED.actions.add("core:toggle-show-tips",function(a){void 0===a?RED.userSettings.toggle("view-show-tips"):(h=a,h?c():d())}),{start:c,stop:d,next:e,enabled:function(){return h}}}();return RED.events.on("view:selection-changed",function(a){if(a.nodes){if(1==a.nodes.length){var b=a.nodes[0];d("subflow"===b.type&&b.direction?RED.nodes.subflow(b.z):b)}}else{var c=RED.workspaces.active(),f=RED.nodes.workspace(c)||RED.nodes.subflow(c);if(f)d(f);else{var g=RED.nodes.workspace(RED.workspaces.active());g.info?d(g):e()}}}),{init:a,show:b,refresh:d,clear:e,set:f}}(),RED.sidebar.config=function(){function a(a,b,c){if(a=a.replace(/\./i,"-"),l[a])l[a].label!==c&&(l[a].list.parent().find(".config-node-label").text(c),l[a].label=c);else{var d=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+a+'"></div>').appendTo(b),e=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(d);c?$('<span class="config-node-label"/>').text(c).appendTo(e):$('<span class="config-node-label" data-i18n="sidebar.config.'+a+'">').appendTo(e),$('<span class="config-node-filter-info"></span>').appendTo(e),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(d),d.i18n();var f=e.find("i"),g={label:c,list:category,size:function(){return g.list.find("li:not(.config_node_none)").length},open:function(a){f.hasClass("expanded")||(f.addClass("expanded"),a?g.list.show():g.list.slideDown())},close:function(a){f.hasClass("expanded")&&(f.removeClass("expanded"),a?g.list.hide():g.list.slideUp())},isOpen:function(){return f.hasClass("expanded")}};e.on("click",function(a){g.isOpen()?g.close():g.open()}),l[a]=g}return l[a]}function b(b,c){var d=a(b.replace(/\./i,"-")),e=d.list;if(c.sort(function(a,b){return a.type<b.type?-1:a.type>b.type?1:0}),k){var f=c.length;c=c.filter(function(a){return a._def.hasUsers!==!1&&0===a.users.length}),f-=c.length,f>0?e.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:f})).show():e.parent().find(".config-node-filter-info").hide()}else e.parent().find(".config-node-filter-info").hide();if(e.empty(),0===c.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(e),d.close(!0);else{var g="";c.forEach(function(a){var b=RED.utils.getNodeLabel(a,a.id);a.type!=g&&($('<li class="config_node_type">'+a.type+"</li>").appendTo(e),g=a.type);var c=$('<li class="palette_node config_node palette_node_id_'+a.id.replace(/\./g,"-")+'"></li>').appendTo(e);if($('<div class="palette_label"></div>').text(b).appendTo(c),a._def.hasUsers!==!1){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(a.users.length).appendTo(c);0===a.users.length&&c.addClass("config_node_unused")}c.on("click",function(b){RED.sidebar.info.refresh(a)}),c.on("dblclick",function(b){RED.editor.editConfig("",a.type,a.id)});var d=a.users.map(function(a){return a.id});c.on("mouseover",function(a){RED.nodes.eachNode(function(a){d.indexOf(a.id)!=-1&&(a.highlighted=!0,a.dirty=!0)}),RED.view.redraw()}),c.on("mouseout",function(a){RED.nodes.eachNode(function(a){a.highlighted&&(a.highlighted=!1,a.dirty=!0)}),RED.view.redraw()})}),d.open(!0)}}function c(){var c={global:!0};a("global",h),RED.nodes.eachWorkspace(function(b){c[b.id.replace(/\./g,"-")]=!0,a(b.id,i,b.label)}),RED.nodes.eachSubflow(function(b){c[b.id.replace(/\./g,"-")]=!0,a(b.id,j,b.name)}),$(".workspace-config-node-category").each(function(){var a=$(this).attr("id").substring("workspace-config-node-category-".length);c[a]||($(this).remove(),delete l[a])});var d=[],e={};RED.nodes.eachConfig(function(a){a.z?(e[a.z.replace(/\./g,"-")]=e[a.z.replace(/\./g,"-")]||[],e[a.z.replace(/\./g,"-")].push(a)):a.z||d.push(a)});for(var f in c)c.hasOwnProperty(f)&&b(f,e[f]||[]);b("global",d)}function d(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:f,toolbar:g,closeable:!0,visible:!1,onchange:function(){c()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(a){a.preventDefault();for(var b in l)l.hasOwnProperty(b)&&l[b].close()}),$("#workspace-config-node-expand-all").on("click",function(a){a.preventDefault();for(var b in l)l.hasOwnProperty(b)&&l[b].size()>0&&l[b].open()}),$("#workspace-config-node-filter-all").on("click",function(a){a.preventDefault(),k&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),k=!k,c())}),$("#workspace-config-node-filter-unused").on("click",function(a){a.preventDefault(),k||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),k=!k,c())})}function e(a){"boolean"==typeof a&&(a?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),c(),"string"==typeof a&&($("#workspace-config-node-filter-all").click(),a=a.replace(/\./g,"-"),setTimeout(function(){var b=$(".palette_node_id_"+a),c=b.position().top,d=b.height(),e=$(".sidebar-node-config"),f=e.height();c+d>f?e.animate({scrollTop:"-="+(f-(c+d)-30)},150):c<0&&e.animate({scrollTop:"+="+(c-10)},150);var g=21,h=function(){g%2===0?b.removeClass("node_highlighted"):b.addClass("node_highlighted"),g--,g>=0&&setTimeout(h,100)};h()},100)),RED.sidebar.show("config")}var f=document.createElement("div");f.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(f);var g=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),h=$("<div>").appendTo(f),i=$("<div>").appendTo(f),j=$("<div>").appendTo(f),k=!1,l={};return{init:d,show:e,refresh:c}}(),RED.palette.editor=function(){function a(a,b){for(var c=a.split(".").map(function(a){return parseInt(a)}),d=b.split(".").map(function(a){return parseInt(a)}),e=0;e<3;e++){var f=c[e]-d[e];if(f<0)return-1;if(f>0)return 1}return 0}function b(a,b){var c=Date.now()-a;c=c<300?300:0,setTimeout(function(){b()},c)}function c(a,c,d,e){d.show();var f=Date.now();$.ajax({url:"nodes/"+a,type:"PUT",data:JSON.stringify({enabled:c}),contentType:"application/json; charset=utf-8"}).done(function(a,c,g){b(f,function(){d.hide(),e()})}).fail(function(a,c,g){b(f,function(){d.hide(),e(a)})})}function d(a,b,c,d){var e={module:a};void 0===d?(d=c,c=b):e.version=b,c.show(),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(e),contentType:"application/json; charset=utf-8"}).done(function(a,b,e){c.hide(),d()}).fail(function(a,b,e){c.hide(),d(a)})}function e(a,b){$.ajax({url:"nodes/"+a,type:"DELETE"}).done(function(a,c,d){b()}).fail(function(a,c,d){b(a)})}function f(){for(var a in F)F.hasOwnProperty(a)&&j(a)}function g(a){G.hasOwnProperty(a)||(G[a]=setTimeout(function(){delete G[a],j(a)},100))}function h(a){var b=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(a);if(b){var c=parseInt(b[1]),d=parseInt(b[2]),e=parseInt(b[3]),f=(299*c+587*d+114*e)/1e3;if(f>160)return c=Math.floor(.8*c),d=Math.floor(.8*d),e=Math.floor(.8*e),"rgb("+c+","+d+","+e+")"}return a}function i(a){var b=(new Date,new Date(a),(Date.now()-new Date(a).getTime())/1e3);if(b<60)return RED._("palette.editor.times.seconds");if(b=Math.floor(b/60),b<10)return RED._("palette.editor.times.minutes");if(b<60)return RED._("palette.editor.times.minutesV",{count:b});if(b=Math.floor(b/60),b<24)return RED._("palette.editor.times.hoursV",{count:b});if(b=Math.floor(b/24),b<7)return RED._("palette.editor.times.daysV",{count:b});var c=Math.floor(b/7);if(c<4)return RED._("palette.editor.times.weeksV",{count:c});var d=Math.floor(c/4);if(c%=4,d<12)return RED._("palette.editor.times.monthsV",{count:d});var e=Math.floor(d/12);return d%=12,0===d?RED._("palette.editor.times.yearsV",{count:e}):RED._("palette.editor.times.year"+(e>1?"s":"")+"MonthsV",{y:e,count:d})}function j(b){if(F.hasOwnProperty(b)){var c=F[b].info,d=F[b].elements;if(d){var e=0,f=0;F[b].totalUseCount=0,F[b].setUseCount={};for(var g in c.sets)if(c.sets.hasOwnProperty(g)){var i=0,j=c.sets[g],k=d.sets[g];j.enabled&&(e+=j.types.length),f+=j.types.length;for(var l=0;l<c.sets[g].types.length;l++){var m=c.sets[g].types[l];i+=E[m]||0;var n=k.swatches[m];if(j.enabled){var o=RED.nodes.getType(m);o&&o.color?(n.css({background:o.color}),n.css({border:"1px solid "+h(n.css("backgroundColor"))})):n.css({background:"#eee",border:"1px dashed #999"})}else n.css({background:"#eee",border:"1px dashed #999"})}F[b].setUseCount[g]=i,F[b].totalUseCount+=i,i>0?(k.enableButton.html(RED._("palette.editor.inuse")),k.enableButton.addClass("disabled")):(k.enableButton.removeClass("disabled"),j.enabled?k.enableButton.html(RED._("palette.editor.disable")):k.enableButton.html(RED._("palette.editor.enable"))),k.setRow.toggleClass("palette-module-set-disabled",!j.enabled)}var p=e===f?f:e+" / "+f;d.setCount.html(RED._("palette.editor.nodeCount",{count:f,label:p})),F[b].totalUseCount>0?(d.enableButton.html(RED._("palette.editor.inuse")),d.enableButton.addClass("disabled"),d.removeButton.hide()):(d.enableButton.removeClass("disabled"),c.local&&d.removeButton.css("display","inline-block"),0===e?d.enableButton.html(RED._("palette.editor.enableall")):d.enableButton.html(RED._("palette.editor.disableall")),d.container.toggleClass("disabled",0===e))}c.pending_version?(d.versionSpan.html(c.version+' <i class="fa fa-long-arrow-right"></i> '+c.pending_version).appendTo(d.metaRow),d.updateButton.html(RED._("palette.editor.updated")).addClass("disabled").show()):D.hasOwnProperty(b)&&1===a(D[b].version,c.version)?(d.updateButton.show(),d.updateButton.html(RED._("palette.editor.update",{version:D[b].version}))):d.updateButton.hide()}else{F[b]={info:RED.nodes.registry.getModule(b)};var q=[b];for(var r in F[b].info.sets)F[b].info.sets.hasOwnProperty(r)&&(q.push(r),q=q.concat(F[b].info.sets[r].types));F[b].index=q.join(",").toLowerCase(),w.editableList("addItem",F[b])}}function k(a){H=a.toLowerCase();var b=w.editableList("filter"),c=w.editableList("length");""===a?u.searchBox("count"):u.searchBox("count",b+" / "+c)}function l(a,b,c,d){if(I.push(a||d),a?J=!0:(d.modules&&(d.modules.forEach(function(a){D[a.id]=a,a.index=[a.id],a.keywords&&(a.index=a.index.concat(a.keywords)),a.updated_at?a.timestamp=new Date(a.updated_at).getTime():a.timestamp=0,a.index=a.index.join(",").toLowerCase()}),B=B.concat(d.modules)),v.searchBox("count",B.length)),y>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+I.length+"/"+y),I.length===y){J&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:b}),"error",!1,8e3);var e=250-(Date.now()-z);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(e,0))}}function m(){if(0===B.length){B=[],D={},x.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var a=RED.settings.theme("palette.catalogues")||["http://homegear.eu/node-blue/catalog.json"];I=[],J=!1,y=a.length,a.length>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+a.length),$("#palette-module-install-shade").show(),z=Date.now();var b=0;a.forEach(function(a,c){$.getJSON(a,{_:(new Date).getTime()},function(b){l(null,a,c,b),f()}).fail(function(b,d,e){l(b,a,c)}).always(function(){b++,b===y&&v.searchBox("change")})})}}function n(){x.editableList("empty");var a=v.searchBox("value").trim();if(""===a)return void x.editableList("addItem",{count:B.length});C.sort(K);for(var b=0;b<Math.min(10,C.length);b++)x.editableList("addItem",C[b]);0===C.length&&x.editableList("addItem",{}),C.length>10&&x.editableList("addItem",{start:10,more:C.length-10})}function o(a,b){return a.info.id.localeCompare(b.info.id)}function p(a,b){return-1*(a.info.timestamp-b.info.timestamp)}function q(){RED.settings.theme("palette.editable")!==!1&&(s(),RED.userSettings.add({id:"palette",title:"Palette",get:r,close:function(){A.detach()},focus:function(){t.resize(),setTimeout(function(){u.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(a){g(a.module)}),RED.events.on("registry:node-set-enabled",function(a){g(a.module)}),RED.events.on("registry:node-set-disabled",function(a){g(a.module)}),RED.events.on("registry:node-type-added",function(a){if(!/^subflow:/.test(a)){var b=RED.nodes.registry.getNodeSetForType(a);g(b.module)}}),RED.events.on("registry:node-type-removed",function(a){if(!/^subflow:/.test(a)){var b=RED.nodes.registry.getNodeSetForType(a);g(b.module)}}),RED.events.on("registry:node-set-added",function(a){g(a.module);for(var b=0;b<C.length;b++)if(C[b].info.id===a.module){var c=C[b].elements.installButton;c.addClass("disabled"),c.html(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(a){var b=RED.nodes.registry.getModule(a.module);if(!b){var c=F[a.module];if(c){w.editableList("removeItem",c),delete F[a.module];for(var d=0;d<C.length;d++)if(C[d].info.id===a.module){var e=C[d].elements.installButton;e.removeClass("disabled"),e.html(RED._("palette.editor.install"));break}}}
}),RED.events.on("nodes:add",function(a){if(!/^subflow:/.test(a.type)&&(E[a.type]=(E[a.type]||0)+1,1===E[a.type])){var b=RED.nodes.registry.getNodeSetForType(a.type);g(b.module)}}),RED.events.on("nodes:remove",function(a){if(E.hasOwnProperty(a.type)&&(E[a.type]--,0===E[a.type])){delete E[a.type];var b=RED.nodes.registry.getNodeSetForType(a.type);g(b.module)}}))}function r(){return m(),t.activateTab("nodes"),A}function s(){A=$('<div id="user-settings-tab-palette"></div>');var a=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(A);t=RED.tabs.create({element:A.find("#palette-editor-tabs"),onchange:function(a){$("#palette-editor .palette-editor-tab").hide(),a.content.show(),u&&u.searchBox("value",""),v&&v.searchBox("value",""),"install"===a.id?v&&v.focus():u&&u.focus()},minimumActiveTabWidth:110});var b=$("<div>",{class:"palette-editor-tab"}).appendTo(a);t.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:b});var f=$("<div>",{class:"palette-search"}).appendTo(b);u=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(f).searchBox({delay:200,change:function(){k($(this).val())}}),w=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(b).editableList({addButton:!1,scrollOnAdd:!1,sort:function(a,b){return a.info.name.localeCompare(b.info.name)},filter:function(a){return""===H||(""===H||a.index.indexOf(H)>-1)},addItem:function(a,b,d){var e=d.info;if(e){var f=$("<div>",{class:"palette-module-header"}).appendTo(a),h=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(f);$("<span>").html(e.name).appendTo(h);var i=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(f),j=$("<span>").html(e.version).appendTo(i),k=$("<div>",{class:"palette-module-meta"}).appendTo(f),l=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(k),m=$("<span>").appendTo(l),n=$("<div>",{class:"palette-module-button-group"}).appendTo(k),o=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.update")).appendTo(n);o.attr("id","up_"+Math.floor(1e9*Math.random())),o.click(function(a){a.preventDefault(),$(this).hasClass("disabled")||($("#palette-module-install-confirm").data("module",e.name),$("#palette-module-install-confirm").data("version",D[e.name].version),$("#palette-module-install-confirm").data("shade",s),$("#palette-module-install-confirm-body").html(e.local?RED._("palette.editor.confirm.update.body"):RED._("palette.editor.confirm.cannotUpdate.body")),$(".palette-module-install-confirm-button-install").hide(),$(".palette-module-install-confirm-button-remove").hide(),e.local?$(".palette-module-install-confirm-button-update").show():$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.update.title")).dialog("open"))});var p=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.remove")).appendTo(n);p.attr("id","up_"+Math.floor(1e9*Math.random())),p.click(function(a){a.preventDefault(),$("#palette-module-install-confirm").data("module",e.name),$("#palette-module-install-confirm").data("shade",s),$("#palette-module-install-confirm-body").html(RED._("palette.editor.confirm.remove.body")),$(".palette-module-install-confirm-button-install").hide(),$(".palette-module-install-confirm-button-remove").show(),$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.remove.title")).dialog("open")}),e.local||p.hide();var q=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.disableall")).appendTo(n),r=$("<div>",{class:"palette-module-content"}).appendTo(a),s=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(a);d.elements={updateButton:o,removeButton:p,enableButton:q,setCount:m,container:a,shade:s,versionSpan:j,sets:{}},l.click(function(b){b.preventDefault(),a.hasClass("expanded")?(a.removeClass("expanded"),r.slideUp()):(a.addClass("expanded"),r.slideDown())});var t=Object.keys(e.sets);t.sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())}),t.forEach(function(a){var b=e.sets[a],f=$("<div>",{class:"palette-module-set"}).appendTo(r),g=$("<div>",{class:"palette-module-set-button-group"}).appendTo(f),h={};b.types.forEach(function(a){var b=$("<div>",{class:"palette-module-type"}).appendTo(f);h[a]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(b),$("<span>",{class:"palette-module-type-node"}).html(a).appendTo(b)});var i=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(g);i.click(function(e){if(e.preventDefault(),0===d.setUseCount[a]){var f=RED.nodes.registry.getNodeSet(b.id);s.show();var g=!f.enabled;c(b.id,g,s,function(a){a&&a.responseJSON&&RED.notify(RED._("palette.editor.errors."+(g?"enable":"disable")+"Failed",{module:id,message:a.responseJSON.message}))})}}),d.elements.sets[b.name]={setRow:f,enableButton:i,swatches:h}}),q.click(function(b){b.preventDefault(),0===d.totalUseCount&&c(e.name,a.hasClass("disabled"),s,function(a){a&&a.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:a.responseJSON.message}))})}),g(e.name)}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(a)}});var h=$("<div>",{class:"palette-editor-tab hide"}).appendTo(a);t.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:h});var j=$("<div>",{class:"palette-editor-toolbar"}).appendTo(h),l=$("<div>",{class:"palette-search"}).appendTo(h);v=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(l).searchBox({delay:300,change:function(){var a=$(this).val().trim().toLowerCase();a.length>0?(C=B.filter(function(b){return b.index.indexOf(a)>-1}).map(function(a){return{info:a}}),n(),v.searchBox("count",C.length+" / "+B.length)):(v.searchBox("count",B.length),x.editableList("empty"),x.editableList("addItem",{count:B.length}))}}),$("<span>").html(RED._("palette.editor.sort")+" ").appendTo(j);var q=$('<span class="button-group"></span>').appendTo(j),r=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(q),s=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(q);r.click(function(a){a.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),s.removeClass("selected"),K=o,n())}),s.click(function(a){a.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),r.removeClass("selected"),K=p,n())});var y=$("<span>").appendTo(j),z=$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(y);z.click(function(a){a.preventDefault(),B=[],D={},m()}),x=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(h).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(a,b,c){if(c.count)return void $("<div>",{class:"red-ui-search-empty"}).html(RED._("palette.editor.moduleCount",{count:c.count})).appendTo(a);if(c.more){a.addClass("palette-module-more");var d=$("<div>",{class:"palette-module-header palette-module"}).appendTo(a),e=$('<a href="#"></a>').html(RED._("palette.editor.more",{count:c.more})).appendTo(d);return void e.click(function(a){a.preventDefault(),x.editableList("removeItem",c);for(var b=c.start;b<Math.min(c.start+10,c.start+c.more);b++)x.editableList("addItem",C[b]);c.more>10&&x.editableList("addItem",{start:c.start+10,more:c.more-10})})}if(c.info){var f=c.info,g=$("<div>",{class:"palette-module-header"}).appendTo(a),h=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(g);$("<span>",{class:"palette-module-name"}).html(f.name||f.id).appendTo(h),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",f.url).appendTo(h);var j=$('<div class="palette-module-meta"></div>').appendTo(g);$("<div>",{class:"palette-module-description"}).html(f.description).appendTo(j);var k=$('<div class="palette-module-meta"></div>').appendTo(g);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+f.version+"</span>").appendTo(k),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+i(f.updated_at)+"</span>").appendTo(k);var l=$("<div>",{class:"palette-module-meta"}).appendTo(g),m=$("<div>",{class:"palette-module-button-group"}).appendTo(l),n=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(a),o=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.install")).appendTo(m);o.click(function(a){a.preventDefault(),$(this).hasClass("disabled")||($("#palette-module-install-confirm").data("module",f.id),$("#palette-module-install-confirm").data("version",f.version),$("#palette-module-install-confirm").data("url",f.url),$("#palette-module-install-confirm").data("shade",n),$("#palette-module-install-confirm-body").html(RED._("palette.editor.confirm.install.body")),$(".palette-module-install-confirm-button-install").show(),$(".palette-module-install-confirm-button-remove").hide(),$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.install.title")).dialog("open"))}),F.hasOwnProperty(f.id)&&(o.addClass("disabled"),o.html(RED._("palette.editor.installed"))),c.elements={installButton:o}}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(a)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(h),$('<div id="palette-module-install-confirm" class="hide"><form class="form-horizontal"><div id="palette-module-install-confirm-body" class="node-dialog-confirm-row"></div></form></div>').appendTo(document.body),$("#palette-module-install-confirm").dialog({title:RED._("palette.editor.confirm.title"),modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var a=$(this).data("url");window.open(a)}},{text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var a=$(this).data("module"),b=$(this).data("version"),c=$(this).data("shade");d(a,b,c,function(b){b&&b.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:a,message:b.responseJSON.message}))}),$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var a=$(this).data("module"),b=$(this).data("shade");b.show(),e(a,function(c){b.hide(),c&&c.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:a,message:c.responseJSON.message}))}),$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var a=$(this).data("module"),b=$(this).data("version"),c=$(this).data("shade");c.show(),d(a,b,c,function(b){b&&b.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:a,message:b.responseJSON.message}))}),$(this).dialog("close")}}]})}var t,u,v,w,x,y,z,A,B=[],C=[],D={},E={},F={},G={},H="",I=[],J=!1,K=o;return{init:q}}(),RED.editor=function(){function a(a,b){var c=a.replace(/\s+/g,"-");return"credentials/"+c+"/"+b}function b(a){var d=a.valid,e=a.changed;a.valid=!0;var f,g,h;if(0===a.type.indexOf("subflow:"))f=RED.nodes.subflow(a.type.substring(8)),g=f.valid,h=f.changed,void 0===g&&(g=b(f),h=f.changed),a.valid=g,a.changed=a.changed||h;else if(a._def)a.valid=c(a,a._def.defaults,a),a._def._creds&&(a.valid=a.valid&&c(a,a._def.credentials,a._def._creds));else if("subflow"==a.type){for(var i=RED.nodes.filterNodes({z:a.id}),j=0;j<i.length;j++)g=i[j].valid,h=i[j].changed,void 0===g&&(g=b(i[j]),h=i[j].changed),a.valid=a.valid&&g,a.changed=a.changed||h;var k=RED.nodes.filterNodes({type:"subflow:"+a.id}),l={};for(j=0;j<k.length;j++)k[j].valid=a.valid,k[j].changed=k[j].changed||a.changed,k[j].dirty=!0,l[k[j].z]=!0;Object.keys(l).forEach(function(a){var c=RED.nodes.subflow(a);c&&b(c)})}return d===a.valid&&e===a.changed||(a.dirty=!0,f=RED.nodes.subflow(a.z),f&&b(f)),a.valid}function c(a,b,c){var e=!0;for(var f in b)b.hasOwnProperty(f)&&(d(a,b,f,c[f])||(e=!1));return e}function d(a,b,c,d){var e=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(d))return!0;if("required"in b[c]&&b[c].required&&(e=""!==d),e&&"validate"in b[c])try{e=b[c].validate.call(a,d)}catch(b){console.log("Validation error:",a.type,a.id,"property: "+c,"value:",d,b)}if(e&&b[c].type&&RED.nodes.getType(b[c].type)&&!("validate"in b[c]))if(d&&"_ADD_"!=d){var f=RED.nodes.node(d);e=null!==f&&(null==f.valid||f.valid)}else e=b[c].hasOwnProperty("required")&&!b[c].required;return e}function e(a,b){for(var c in a._def.defaults)a._def.defaults.hasOwnProperty(c)&&f(a,a._def.defaults,c,b);if(a._def.credentials)for(c in a._def.credentials)a._def.credentials.hasOwnProperty(c)&&f(a,a._def.credentials,c,b)}function f(a,b,c,e){var f=$("#"+e+"-"+c);if(f.length>0){var g=f.val();b[c].hasOwnProperty("format")&&""!==b[c].format&&"DIV"===f[0].nodeName&&(g=f.text()),d(a,b,c,g)?f.removeClass("input-error"):f.addClass("input-error")}}function g(a,b){a.resize=!0,a.dirty=!0;var c=[];if(a.inputPorts)if(a.inputs<a.inputPorts.length){for(;a.inputs<a.inputPorts.length;)a.inputPorts.pop();RED.nodes.eachLink(function(b){b.target===a&&b.targetPort>=a.inputs&&c.indexOf(b)===-1&&c.push(b)})}else if(a.inputs>a.inputPorts.length)for(;a.inputs>a.inputPorts.length;)a.inputPorts.push(a.inputPorts.length);if(a.outputPorts)if(b&&RED.nodes.eachLink(function(d){d.source===a&&b.hasOwnProperty(d.sourcePort)&&("-1"===b[d.sourcePort]?c.push(d):d.sourcePort=b[d.sourcePort])}),a.outputs<a.outputPorts.length){for(;a.outputs<a.outputPorts.length;)a.outputPorts.pop();RED.nodes.eachLink(function(b){b.source===a&&b.sourcePort>=a.outputs&&c.indexOf(b)===-1&&c.push(b)})}else if(a.outputs>a.outputPorts.length)for(;a.outputs>a.outputPorts.length;)a.outputPorts.push(a.outputPorts.length);for(var d=0;d<c.length;d++)RED.nodes.removeLink(c[d]);return c}function h(a,b,c,d){var e=$("#"+d+"-"+b);if(0!==e.length){var f,g=e.width(),h=e.attr("style");g=null!==(f=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(h))?f[1]:"70%";var i=$("<div></div>").css({display:"inline-block",position:"relative"}),j=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(i),k=$('<select id="'+d+"-"+b+'"></select>').appendTo(j);i.width(g).height(e.height()),0===i.width()&&i.width("70%"),e.replaceWith(i),k.attr("style","width:100%"),t(b,c,a[b],d),$('<a id="'+d+"-lookup-"+b+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(i),$("#"+d+"-lookup-"+b).click(function(a){r(b,c,k.find(":selected").val(),d),a.preventDefault()});var l="",m=RED.nodes.node(a[b]);RED.nodes.getType(c);m&&(l=RED.utils.getNodeLabel(m,m.id)),e.val(l)}}function i(a,b,c,d){var e=$("#"+d+"-"+b);e.val(a[b]),e.attr("type","hidden");var f=$("<a>",{id:d+"-edit-"+b,class:"editor-button"});e.after(f),a[b]?f.text(RED._("editor.configEdit")):f.text(RED._("editor.configAdd")),f.click(function(a){r(b,c,e.val()||"_ADD_",d),a.preventDefault()})}function j(a,b,c,d){var e=$("#"+c+"-"+b);if(0!==e.length)if("checkbox"===e.attr("type"))e.prop("checked",a[b]);else{var f=a[b];null==f&&(f=""),void 0!==d&&d[b].hasOwnProperty("format")&&""!==d[b].format&&"DIV"===e[0].nodeName?(e.html(RED.text.format.getHtml(f,d[b].format,{},!1,"en")),RED.text.format.attach(e[0],d[b].format,{},!1,"en")):(e.val(f),"INPUT"!==e[0].nodeName&&"TEXTAREA"!==e[0].nodeName||RED.text.bidi.prepareInput(e))}}function k(a,b,c,d){var f=$("#"+d+"-"+c);void 0!==b&&"format"in b[c]&&""!==b[c].format&&"DIV"===f[0].nodeName?$("#"+d+"-"+c).on("change keyup",function(b,c){c||e(a,d)}):$("#"+d+"-"+c).change(function(b,c){c||e(a,d)})}function l(a,b,c,d){var e;for(e in b)b.hasOwnProperty(e)&&("password"==b[e].type?c[e]?$("#"+d+"-"+e).val(c[e]):c["has_"+e]?$("#"+d+"-"+e).val("__PWRD__"):$("#"+d+"-"+e).val(""):j(c,e,d,b),k(a,b,e,d))}function m(a,b,c){var d=!1;a.credentials||(a.credentials={_:{}});for(var e in b)if(b.hasOwnProperty(e)){var f=$("#"+c+"-"+e),g=f.val();if("password"==b[e].type){if(a.credentials["has_"+e]=""!==g,"__PWRD__"==g)continue;d=!0}a.credentials[e]=g,g!=a.credentials._[e]&&(d=!0)}return d}function n(b,c,d,f){for(var g in c.defaults)if(c.defaults.hasOwnProperty(g)){if(c.defaults[g].type){var m=RED.nodes.getType(c.defaults[g].type);m?m.exclusive?i(b,g,c.defaults[g].type,d):h(b,g,c.defaults[g].type,d):(console.log("Unknown type:",c.defaults[g].type),j(b,g,d,c.defaults))}else j(b,g,d,c.defaults);k(b,c.defaults,g,d)}var n=function(){if(c.oneditprepare)try{c.oneditprepare.call(b)}catch(a){console.log("oneditprepare",b.id,b.type,a.toString())}for(var a in c.defaults)c.defaults.hasOwnProperty(a)&&$("#"+d+"-"+a).trigger("change",[!0]);if(c.credentials)for(a in c.credentials)c.credentials.hasOwnProperty(a)&&$("#"+d+"-"+a).trigger("change",[!0]);e(b,d),f&&f()};c.credentials?b.credentials?(l(b,c.credentials,b.credentials,d),n()):$.getJSON(a(b.type,b.id),function(a){b.credentials=a,b.credentials._=$.extend(!0,{},a),l(b,c.credentials,b.credentials,d),n()}):n()}function o(){for(var a='<ul class="editor-tray-breadcrumbs">',b=0;b<x.length;b++){var c=x[b],d=c.type;if("_expression"===c.type)d=RED._("expressionEditor.title");else if("_json"===c.type)d=RED._("jsonEditor.title");else if("subflow"===c.type)d=RED._("subflow.editSubflow",{name:c.name});else if(0===c.type.indexOf("subflow:")){var e=RED.nodes.subflow(c.type.substring(8));d=RED._("subflow.editSubflow",{name:e.name})}else{if("undefined"!=typeof c._def.paletteLabel)try{d=("function"==typeof c._def.paletteLabel?c._def.paletteLabel.call(c._def):c._def.paletteLabel)||""}catch(a){console.log("Definition error: "+c.type+".paletteLabel",a)}b===x.length-1&&(d=RED.nodes.node(c.id)?RED._("editor.editNode",{type:d}):RED._("editor.addNewConfig",{type:d}))}a+="<li>"+d+"</li>"}return a+="</ul>"}function p(a,b,c,d){var e=$('<form id="'+b+'" class="form-horizontal" autocomplete="off"></form>').appendTo(a);return e.html($("script[data-template-name='"+c+"']").html()),d=d||"node-red",e.find("[data-i18n]").each(function(){for(var a=$(this).attr("data-i18n"),b=a.split(";"),c=0;c<b.length;c++){var e=b[c];if(e.indexOf(":")===-1){var f="";if(0===e.indexOf("[")){var g=e.split("]");f=g[0]+"]",e=g[1]}b[c]=f+d+":"+e}}$(this).attr("data-i18n",b.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(e),$('<input type="text" style="display: none;" />').prependTo(e),e.submit(function(a){a.preventDefault()}),e}function q(a){var c=a;x.push(a),RED.view.state(RED.state.EDITING);var d=a.type;"subflow:"==a.type.substring(0,8)&&(d="subflow");var e={title:o(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var a=RED.nodes.dirty(),b=[],d=[],e=RED.nodes.remove(c.id);b.push(c),b=b.concat(e.nodes),d=d.concat(e.links);var f={t:"delete",nodes:b,links:d,changes:{},dirty:a};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(f),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(c._def){if(c._def.oneditcancel)try{c._def.oneditcancel.call(c)}catch(a){console.log("oneditcancel",c.id,c.type,a.toString())}for(var a in c._def.defaults)if(c._def.defaults.hasOwnProperty(a)){var b=c._def.defaults[a];if(b.type){var d=RED.nodes.getType(b.type);if(d&&d.exclusive){var e=$("#node-input-"+a).val()||"";""===e||c[a]||RED.nodes.remove(e)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var a,d,e={},f=!1,h=RED.nodes.dirty();if(c._def.oneditsave){var i={};for(a in c._def.defaults)c._def.defaults.hasOwnProperty(a)&&("string"==typeof c[a]||"number"==typeof c[a]?i[a]=c[a]:i[a]=$.extend(!0,{},{v:c[a]}).v);try{var j=c._def.oneditsave.call(c);j===!0&&(f=!0)}catch(a){console.log("oneditsave",c.id,c.type,a.toString())}for(a in c._def.defaults)c._def.defaults.hasOwnProperty(a)&&(null===i[a]||"string"==typeof i[a]||"number"==typeof i[a]?i[a]!==c[a]&&(e[a]=i[a],f=!0):JSON.stringify(i[a])!==JSON.stringify(c[a])&&(e[a]=i[a],f=!0))}var k;if(c._def.defaults)for(a in c._def.defaults)if(c._def.defaults.hasOwnProperty(a)){var l=$("#node-input-"+a);if(k="checkbox"===l.attr("type")?l.prop("checked"):"format"in c._def.defaults[a]&&""!==c._def.defaults[a].format&&"DIV"===l[0].nodeName?l.text():l.val(),null!=k){if("outputs"===a){if(""===k.trim())continue;if(isNaN(k)){d=JSON.parse(k);var n=0,o=!1,p=Object.keys(d);p.forEach(function(a){isNaN(a)?(n++,delete d[a]):(d[a]=d[a]+"","-1"!==d[a]?(n++,d[a]!==a?o=!0:delete d[a]):o=!0)}),k=n,o&&(f=!0)}}if(c[a]!=k){if(c._def.defaults[a].type){"_ADD_"==k&&(k="");var q=RED.nodes.node(c[a]);if(q){var r=q.users;r.splice(r.indexOf(c),1)}q=RED.nodes.node(k),q&&q.users.push(c)}e[a]=c[a],c[a]=k,f=!0}}}if(c._def.credentials){var s="node-input",t=c._def.credentials,u=m(c,t,s);f=f||u}var v=g(c,d),w=$("#node-label-form-inputs").children().find("input"),x=$("#node-label-form-outputs").children().find("input"),y=!1;if(k=w.map(function(){var a=$(this).val();return y=y||""!==a,a}).toArray().slice(0,c.inputs),(void 0===c.inputLabels&&y||void 0!==c.inputLabels&&JSON.stringify(k)!==JSON.stringify(c.inputLabels))&&(e.inputLabels=c.inputLabels,c.inputLabels=k,f=!0),y=!1,k=new Array(c.outputs),x.each(function(){var a=$(this).attr("id").substring(23);if(!d||!d.hasOwnProperty(a)||(a=parseInt(d[a]),a!==-1)){var b=$(this).val();y=y||""!==b,k[a]=b}}),(void 0===c.outputLabels&&y||void 0!==c.outputLabels&&JSON.stringify(k)!==JSON.stringify(c.outputLabels))&&(e.outputLabels=c.outputLabels,c.outputLabels=k,f=!0),f){var z=c.changed;c.changed=!0,RED.nodes.dirty(!0);var A=RED.nodes.subflow(RED.workspaces.active()),B=null;A&&(B=[],RED.nodes.eachNode(function(a){a.type=="subflow:"+RED.workspaces.active()&&(B.push({id:a.id,changed:a.changed}),a.changed=!0,a.dirty=!0,g(a))}));var C={t:"edit",node:c,changes:e,links:v,dirty:h,changed:z};d&&(C.outputMap=d),B&&(C.subflow={instances:B}),RED.history.push(C)}c.dirty=!0,b(c),RED.events.emit("editor:save",c),RED.tray.close()}}],resize:function(a){y[d]=a.width,$(".editor-tray-content").height(a.height-78);var b=$(".editor-tray-content form").height(a.height-78-40);if(c&&c._def.oneditresize)try{c._def.oneditresize.call(c,{width:b.width(),height:b.height()})}catch(a){console.log("oneditresize",c.id,c.type,a.toString())}},open:function(b,e){var f=(b.find(".editor-tray-footer"),b.find(".editor-tray-body"));f.parent().css("overflow","hidden");var g=RED.stack.create({container:f,singleExpanded:!0}),h=g.add({title:RED._("editor.nodeProperties"),expanded:!0});h.content.addClass("editor-tray-content"),c&&RED.sidebar.info.refresh(c);var i;i="node-red"===a._def.set.module?"node-red":a._def.set.id,p(h.content,"dialog-form",d,i),n(a,a._def,"node-input",function(){f.i18n(),e()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),c&&RED.sidebar.info.refresh(c),RED.workspaces.refresh(),RED.view.redraw(!0),x.pop()},show:function(){c&&RED.sidebar.info.refresh(c)}};if(y.hasOwnProperty(d)&&(e.width=y[d]),"subflow"===d){var f=c.type.substring(8);e.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(f),$("#node-dialog-ok").click()}})}RED.tray.show(e)}function r(a,c,d,e){var f,g="_ADD_"==d,h=RED.nodes.getType(c),i=RED.nodes.node(d);f="node-red"===h.set.module?"node-red":h.set.id;var j="",k=RED.nodes.subflow(RED.workspaces.active());if(k&&(j=k.id),null==i){i={id:RED.nodes.id(),_def:h,type:c,z:j,users:[]};for(var l in h.defaults)h.defaults[l].value&&(i[l]=JSON.parse(JSON.stringify(h.defaults[l].value)));i._=h._}x.push(i),RED.view.state(RED.state.EDITING);var q={title:o(),resize:function(){if(i&&i._def.oneditresize){var a=$("#node-config-dialog-edit-form");try{i._def.oneditresize.call(i,{width:a.width(),height:a.height()})}catch(a){console.log("oneditresize",i.id,i.type,a.toString())}}},open:function(a,b){var d=(a.find(".editor-tray-header"),a.find(".editor-tray-footer"));h.hasUsers!==!1&&d.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),d.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var e=p(a.find(".editor-tray-body"),"node-config-dialog-edit-form",c,f);n(i,h,"node-config-input",function(){i._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var a={};i.users.forEach(function(b){a[b.z]=!0});var c=Object.keys(a).length,d=$("#node-config-dialog-scope").empty();d.off("change"),d.append('<option value=""'+(i.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),d.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(b){var c=b.label;a[b.id]&&(c="* "+c),d.append('<option value="'+b.id+'"'+(b.id==i.z?" selected":"")+">"+c+"</option>")}),d.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(b){var c=b.name;a[b.id]&&(c="* "+c),d.append('<option value="'+b.id+'"'+(b.id==i.z?" selected":"")+">"+c+"</option>")}),c>0&&d.on("change",function(){var b=$(this).val();""===b?$("#node-config-dialog-scope-warning").hide():!a[b]||c>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),d.i18n(),e.i18n(),h.hasUsers!==!1&&$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:i.users.length})).parent().show(),b()})},close:function(){RED.workspaces.refresh(),x.pop()},show:function(){i&&RED.sidebar.info.refresh(i)}};q.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var a=c,b=i.id,d=RED.nodes.getType(a);if(d.oneditcancel&&d.oneditcancel){var e=RED.nodes.node(b);if(e)try{d.oneditcancel.call(e,!1)}catch(a){console.log("oneditcancel",e.id,e.type,a.toString())}else try{d.oneditcancel.call({id:b},!0)}catch(c){console.log("oneditcancel",b,a,c.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:g?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var d,f,h=a,j=(i.id,c),k=g,l=RED.nodes.getType(j),n=$("#node-config-dialog-scope").val();if(l.oneditsave)try{l.oneditsave.call(i)}catch(a){console.log("oneditsave",i.id,i.type,a.toString())}for(d in l.defaults)if(l.defaults.hasOwnProperty(d)){var o;if(f=$("#node-config-input-"+d),o="checkbox"===f.attr("type")?f.prop("checked"):"format"in l.defaults[d]&&""!==l.defaults[d].format&&"DIV"===f[0].nodeName?f.text():f.val(),null!=o&&o!==i[d]){if(i._def.defaults[d].type){"_ADD_"==o&&(o="");var p=RED.nodes.node(i[d]);if(p){var q=p.users;q.splice(q.indexOf(i),1)}p=RED.nodes.node(o),p&&p.users.push(i)}i[d]=o}}i.label=l.label,i.z=n,n&&(i.users=i.users.filter(function(a){var c=!0;for(var d in a._def.defaults)a._def.defaults.hasOwnProperty(d)&&a._def.defaults[d].type===i.type&&a[d]===i.id&&a.z!==n&&(c=!1,a[d]=null,a.dirty=!0,a.changed=!0,b(a));return c})),k&&RED.nodes.add(i),l.credentials&&m(i,l.credentials,"node-config-input"),b(i);var r={};r[i.id]=!0;for(var s=i.users.slice();s.length>0;){var u=s.pop();r[u.id]||(r[u.id]=!0,u.users&&(s=s.concat(u.users)),b(u))}RED.nodes.dirty(!0),RED.view.redraw(!0),k||RED.events.emit("editor:save",i),RED.tray.close(function(){t(h,j,i.id,e)})}}],g||q.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var d=a,f=i.id,g=c,h=RED.nodes.getType(g);try{h.ondelete&&(console.log("Deprecated API warning: config node type ",g," has an ondelete function - should be oneditdelete"),h.ondelete.call(i)),h.oneditdelete&&h.oneditdelete.call(i)}catch(a){console.log("oneditdelete",i.id,i.type,a.toString())}for(var j={t:"delete",nodes:[i],changes:{},dirty:RED.nodes.dirty()},k=0;k<i.users.length;k++){var l=i.users[k];j.changes[l.id]={changed:l.changed,valid:l.valid};for(var m in l._def.defaults)l._def.defaults.hasOwnProperty(m)&&l[m]==f&&(j.changes[l.id][m]=f,l[m]="",l.changed=!0,l.dirty=!0);b(l)}RED.nodes.remove(f),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(j),RED.tray.close(function(){t(d,g,"",e)})}}),RED.tray.show(q)}function s(a,b){return a.__label__<b.__label__?-1:a.__label__>b.__label__?1:0}function t(a,b,c,d){if(d){var e=$("#"+d+"-edit-"+a);if(e.length)c?e.text(RED._("editor.configEdit")):e.text(RED._("editor.configAdd")),$("#"+d+"-"+a).val(c);else{var f=$("#"+d+"-"+a),g=RED.nodes.getType(b);f.children().remove();var h=RED.nodes.workspace(RED.workspaces.active());h||(h=RED.nodes.subflow(RED.workspaces.active()));var i=[];RED.nodes.eachConfig(function(a){if(a.type==b&&(!a.z||a.z===h.id)){var c=RED.utils.getNodeLabel(a,a.id);a.__label__=c,i.push(a)}});var j=s;"function"==typeof g.sort&&(j=g.sort);try{i.sort(j)}catch(a){console.log("Definition error: "+g.type+".sort",a)}i.forEach(function(a){f.append('<option value="'+a.id+'"'+(c==a.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(a.__label__)+"</option>"),delete a.__label__}),f.append('<option value="_ADD_"'+(""===c?" selected":"")+">"+RED._("editor.addNewType",{type:b})+"</option>"),window.setTimeout(function(){f.change()},50)}}}function u(a){var b=a;x.push(a),RED.view.state(RED.state.EDITING);var c,d={title:o(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var a={},d=!1,e=RED.nodes.dirty(),f=$("#subflow-input-name").val();f!=b.name&&(a.name=b.name,b.name=f,d=!0);var h=c.getValue();h!=b.info&&(a.info=b.info,b.info=h,d=!0);var i=$("#node-label-form-inputs").children().find("input"),j=$("#node-label-form-outputs").children().find("input"),k=i.map(function(){return $(this).val()}).toArray().slice(0,b.inputs);if(JSON.stringify(k)!==JSON.stringify(b.inputLabels)&&(a.inputLabels=b.inputLabels,b.inputLabels=k,d=!0),k=j.map(function(){return $(this).val()}).toArray().slice(0,b.outputs),JSON.stringify(k)!==JSON.stringify(b.outputLabels)&&(a.outputLabels=b.outputLabels,b.outputLabels=k,d=!0),RED.palette.refresh(),d){var l=[];RED.nodes.eachNode(function(a){a.type=="subflow:"+b.id&&(l.push({id:a.id,changed:a.changed}),a.changed=!0,a.dirty=!0,g(a))});var m=b.changed;b.changed=!0,RED.nodes.dirty(!0);var n={t:"edit",node:b,changes:a,dirty:e,changed:m,subflow:{instances:l}};RED.history.push(n)}b.dirty=!0,RED.tray.close()}}],resize:function(a){$(".editor-tray-content").height(a.height-78);for(var b=($(".editor-tray-content form").height(a.height-78-40),$("#dialog-form>div:not(.node-text-editor-row)")),d=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),e=0;e<b.size();e++)d-=$(b[e]).outerHeight(!0);d-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",d+"px"),c.resize()},open:function(d){var e=(d.find(".editor-tray-footer"),d.find(".editor-tray-body"));e.parent().css("overflow","hidden");var f=RED.stack.create({container:e,singleExpanded:!0}),g=f.add({title:RED._("editor.nodeProperties"),
expanded:!0});g.content.addClass("editor-tray-content"),b&&RED.sidebar.info.refresh(b);p(g.content,"dialog-form","subflow-template");c=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(a.name),RED.text.bidi.prepareInput($("#subflow-input-name")),c.getSession().setValue(a.info||"",-1);var h=0,i="subflow:"+b.id;RED.nodes.eachNode(function(a){a.type===i&&h++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:h})).show(),e.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(b),RED.workspaces.refresh(),x.pop(),b=null},show:function(){}};RED.tray.show(d)}function v(a){var b="_";x.length>0&&(b=x[x.length-1].id);var c=a.value,d=a.complete,e="_expression";x.push({type:e}),RED.view.state(RED.state.EDITING);var f,g,h,i,j={title:o(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").html(""),d(f.getValue()),RED.tray.close()}}],resize:function(a){a&&(y[e]=a.width);var b=$("#dialog-form").height();i&&i.resize(b)},open:function(a){var d=a.find(".editor-tray-body");d.addClass("node-input-expression-editor");var e=p(a.find(".editor-tray-body"),"dialog-form","_expression","editor"),k=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(a){k.append($("<option></option>").val(a).text(a))}),k.change(function(a){var b=$(this).val(),c=RED._("jsonata:"+b+".args",{defaultValue:""}),d="<h5>"+b+"("+c+")</h5>",e=marked(RED._("jsonata:"+b+".desc",{defaultValue:""}));$("#node-input-expression-help").html(d+"<p>"+e+"</p>")}),f=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}});var l=null,m=-1,n=null;f.getSession().setValue(c||"",-1),f.on("changeSelection",function(){var a=f.getCursorPosition(),b=f.getSession().getTokenAt(a.row,a.column);if(b!==l||b&&/paren/.test(b.type)&&a.column!==m){l=b;var c,d,e=null;if(b&&"keyword"===b.type)c=a.row,e=b;else{var g=0,h=!1;for(b?("paren.rparen"===b.type&&(m=a.column,g=a.column-(b.start+b.value.length)),c=a.row,d=b.index):(c=a.row-1,d=-1);null===e&&c>-1;){var i=f.getSession().getTokens(c);for(d===-1&&(d=i.length-1);d>-1;){var j=i[d].type;if(h){if("keyword"===j){e=i[d];break}h=!1}"paren.lparen"===j?g-=i[d].value.length:"paren.rparen"===j&&(g+=i[d].value.length),g<0&&(h=!0,g=0),d--}e||c--}}f.session.removeMarker(n),e&&k.val(e.value).change()}}),e.i18n(),$("#node-input-expression-func-insert").click(function(a){a.preventDefault();var b=(f.getCursorPosition(),k.val()),c=jsonata.getFunctionSnippet(b);f.insertSnippet(c),f.focus()}),$("#node-input-expression-reformat").click(function(a){a.preventDefault();var b=f.getValue()||"";try{b=jsonata.format(b)}catch(a){}f.getSession().setValue(b||"",-1)});var o=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(a){$(".node-input-expression-tab-content").hide(),a.content.show(),j.resize()}});o.addTab({id:"expression-help",label:"Function reference",content:$("#node-input-expression-tab-help")}),o.addTab({id:"expression-tests",label:"Test",content:$("#node-input-expression-tab-test")}),g=RED.editor.createEditor({id:"node-input-expression-test-data",value:z[b]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1});var q;$(".node-input-expression-legacy").click(function(a){a.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var r=function(){var a,b,c=g.getValue(),d=f.getValue(),e=!1,i=!1;try{b=jsonata(d),b.assign("flowContext",function(a){return e=!0,null}),b.assign("globalContext",function(a){return e=!0,null}),i=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(d)}catch(a){return void h.setValue(RED._("expressionEditor.errors.invalid-expr",{message:a.message}))}$(".node-input-expression-legacy").toggle(i);try{a=JSON.parse(c)}catch(a){return void h.setValue(RED._("expressionEditor.errors.invalid-msg",{message:a.toString()}))}try{var j=b.evaluate(i?{msg:a}:a);if(e)return void h.setValue(RED._("expressionEditor.errors.context-unsupported"));var k;k=void 0!==j?JSON.stringify(j,null,4):RED._("expressionEditor.noMatch"),h.setValue(k)}catch(a){h.setValue(RED._("expressionEditor.errors.eval",{message:a.message}))}};g.getSession().on("change",function(){clearTimeout(q),q=setTimeout(r,200),z[b]=g.getValue()}),f.getSession().on("change",function(){clearTimeout(q),q=setTimeout(r,200)}),h=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),i=RED.panels.create({id:"node-input-expression-panels",resize:function(a,b){var c=$("#node-input-expression-panel-expr");a-=$(c.children()[0]).outerHeight(!0);var d=$(c.children()[1]);a-=parseInt(d.css("marginTop"))+parseInt(d.css("marginBottom")),$("#node-input-expression").css("height",a-5+"px"),f.resize();var e=$("#node-input-expression-panel-info > .form-row > div:first-child");b-=e.outerHeight(!0)+20,$(".node-input-expression-tab-content").height(b),$("#node-input-expression-test-data").css("height",b-5+"px"),g.resize(),$("#node-input-expression-test-result").css("height",b-5+"px"),h.resize()}}),r()},close:function(){x.pop()},show:function(){}};y.hasOwnProperty(e)&&(j.width=y[e]),RED.tray.show(j)}function w(a){var b=a.value,c=a.complete,d="_json";x.push({type:d}),RED.view.state(RED.state.EDITING);var e,f={title:o(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){c(e.getValue()),RED.tray.close()}}],resize:function(a){y[d]=a.width;for(var b=$("#dialog-form>div:not(.node-text-editor-row)"),c=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),f=0;f<b.size();f++)c-=$(b[f]).outerHeight(!0);c-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",c+"px"),e.resize()},open:function(a){var c=(a.find(".editor-tray-body"),p(a.find(".editor-tray-body"),"dialog-form",d,"editor"));e=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"}),e.getSession().setValue(b||"",-1),$("#node-input-expression-reformat").click(function(a){a.preventDefault();var b=e.getValue()||"";try{b=JSON.stringify(JSON.parse(b),null,4)}catch(a){}e.getSession().setValue(b||"",-1)}),c.i18n()},close:function(){x.pop()},show:function(){}};y.hasOwnProperty(d)&&(f.width=y[d]),RED.tray.show(f)}var x=[],y={},z={};return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:q,editConfig:r,editSubflow:u,editExpression:v,editJSON:w,validateNode:b,updateNodeProperties:g,createEditor:function(a){var b=ace.edit(a.id);b.setTheme("ace/theme/tomorrow");var c=b.getSession();return a.mode&&c.setMode(a.mode),a.foldStyle?c.setFoldStyle(a.foldStyle):c.setFoldStyle("markbeginend"),a.options?b.setOptions(a.options):b.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),a.readOnly&&b.setOption("readOnly",a.readOnly),a.hasOwnProperty("lineNumbers")&&b.renderer.setOption("showGutter",a.lineNumbers),b.$blockScrolling=1/0,a.value&&c.setValue(a.value,-1),a.globals&&setTimeout(function(){c.$worker&&c.$worker.send("setOptions",[{globals:a.globals,esversion:6}])},100),b}}}(),RED.tray=function(){function a(a){function f(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),r.preferredWidth=Math.max(g.width(),500),j.css({minWidth:r.preferredWidth-40}),a.width?(a.width>$("#editor-stack").position().left-8&&(a.width=$("#editor-stack").position().left-8),g.width(a.width)):g.width(r.preferredWidth),r.width=g.width(),r.width>$("#editor-stack").position().left-8&&(r.width=Math.max(0,$("#editor-stack").position().left-8),g.width(r.width)),g.css({right:-(g.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),b(),e=!0,setTimeout(function(){setTimeout(function(){a.width||g.width(Math.min(r.preferredWidth,$("#editor-stack").position().left-8)),a.resize&&a.resize({width:g.width()}),a.show&&a.show(),setTimeout(function(){e=!1},200),j.find(":focusable:first").focus()},150),g.css({right:0})},0)}var g=$('<div class="editor-tray"></div>'),h=$('<div class="editor-tray-header"></div>').appendTo(g),i=$('<div class="editor-tray-body-wrapper"></div>').appendTo(g),j=$('<div class="editor-tray-body"></div>').appendTo(i),k=$('<div class="editor-tray-footer"></div>').appendTo(g),l=$('<div class="editor-tray-resize-handle"></div>').appendTo(g);a.title&&$('<div class="editor-tray-titlebar">'+a.title+"</div>").appendTo(h);var m,n=$('<div class="editor-tray-toolbar"></div>').appendTo(h);if(a.buttons)for(var o=0;o<a.buttons.length;o++){var p=a.buttons[o],q=$("<button>").button().appendTo(n);p.id&&q.attr("id",p.id),p.text&&q.html(p.text),p.click&&q.click(function(a){return function(b){$(this).hasClass("disabled")||a(b)}}(p.click)),p.class&&(q.addClass(p.class),"primary"===p.class&&(m=p))}g.appendTo(d);var r={tray:g,header:h,body:j,footer:k,options:a,primaryButton:m};c.push(r),g.draggable({handle:l,axis:"x",start:function(a,b){g.width("auto")},drag:function(a,b){var c=d.position().left+b.position.left;c<7?b.position.left+=7-c:b.position.left>-r.preferredWidth-1&&(b.position.left=-Math.min(d.position().left-7,r.preferredWidth-1)),r.options.resize&&setTimeout(function(){r.options.resize({width:-b.position.left})},0),r.width=-b.position.left},stop:function(a,b){g.width(-b.position.left),g.css({left:""}),r.options.resize&&r.options.resize({width:-b.position.left}),r.width=-b.position.left}}),a.open?1===a.open.length?(a.open(g),f()):a.open(g,f):f()}function b(){if(c.length>0){var a=c[c.length-1],b=a.tray.height()-a.header.outerHeight()-a.footer.outerHeight();a.body.height(b),a.width>$("#editor-stack").position().left-8?(a.width=$("#editor-stack").position().left-8,a.tray.width(a.width)):a.width<a.preferredWidth&&(a.width=Math.min($("#editor-stack").position().left-8,a.preferredWidth),a.tray.width(a.width)),a.options.resize&&a.options.resize({width:a.width,height:b})}}var c=[],d=$("#editor-stack"),e=!1;return{init:function(){$(window).resize(b),RED.events.on("sidebar:resize",b),$("#editor-shade").click(function(){if(!e){var a=c[c.length-1];a&&a.primaryButton&&a.primaryButton.click()}})},show:function(b){if(c.length>0){var d=c[c.length-1];d.tray.css({right:-(d.tray.width()+10)+"px"}),setTimeout(function(){d.tray.detach(),a(b)},250)}else RED.events.emit("editor:open"),a(b)},close:function(a){if(c.length>0){var d=c.pop();d.tray.css({right:-(d.tray.width()+10)+"px"}),setTimeout(function(){if(d.options.close&&d.options.close(),d.tray.remove(),c.length>0){var e=c[c.length-1];e.tray.appendTo("#editor-stack"),setTimeout(function(){b(),e.tray.css({right:0}),e.options.show&&e.options.show()},0)}a&&a(),0===c.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){function a(){g=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(a){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(a){}}),h=g.children(".dialog-form"),i='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',j='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>'}function b(){var a=$("#clipboard-import"),b=a.val();b=b.substring(b.indexOf("["),b.lastIndexOf("]")+1);try{JSON.parse(b),a.removeClass("input-error"),a.val(b),$("#clipboard-dialog-ok").button("enable")}catch(c){""!==b&&a.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function c(){k||(h.empty(),h.append($(j)),h.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(b),$("#clipboard-import").on("paste",function(){setTimeout(b,10)}),$("#import-tab > a").click(function(a){a.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),g.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function d(){if(!k){h.empty(),h.append($(i)),h.i18n();var a=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(b){if(b.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))return void $("#clipboard-export").focus();$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var c=$("#clipboard-export").val();if(c.length>0){var d=JSON.parse(c);a=$(this).attr("id"),c="export-format-full"===a?JSON.stringify(d,null,4):JSON.stringify(d),$("#clipboard-export").val(c),$("#clipboard-export").focus()}}),$("#export-range-group > a").click(function(b){if(b.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))return void $("#clipboard-export").focus();$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var c=$(this).attr("id"),d="",e=null;if("export-range-selected"===c){var f=RED.view.selection();e=RED.nodes.createExportableNodeSet(f.nodes)}else if("export-range-flow"===c){var g=RED.workspaces.active();e=RED.nodes.filterNodes({z:g});var h=RED.nodes.workspace(g)||RED.nodes.subflow(g);e.unshift(h),e=RED.nodes.createExportableNodeSet(e)}else"export-range-full"===c&&(e=RED.nodes.createCompleteNodeSet(!1));null!==e&&(d="export-format-full"===a?JSON.stringify(e,null,4):JSON.stringify(e)),d.length>0?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(d),$("#clipboard-export").focus()}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide();var b=RED.view.selection();b.nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===a?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var a=$(this);a.select(),a.mouseup(function(){return a.unbind("mouseup"),!1})}),g.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function e(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}function f(a,b,c){var d=!1;"string"!=typeof a&&(a=JSON.stringify(a,function(a,b){return null!==b&&"object"==typeof b&&b.__encoded__&&b.hasOwnProperty("data")&&b.hasOwnProperty("length")?(d=b.data.length!==b.length,b.data):b})),d&&(c+="_truncated"),$("#clipboard-hidden").val(a).select();var e=document.execCommand("copy");if(e&&b){var f=RED.popover.create({target:b,direction:"left",size:"small",content:RED._(c)});setTimeout(function(){f.close()},1e3),f.open()}return e}var g,h,i,j,k=!1;return{init:function(){a(),$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.events.on("view:selection-changed",function(a){a.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.actions.add("core:show-export-dialog",d),RED.actions.add("core:show-import-dialog",c),RED.events.on("editor:open",function(){k=!0}),RED.events.on("editor:close",function(){k=!1}),RED.events.on("search:open",function(){k=!0}),RED.events.on("search:close",function(){k=!1}),RED.events.on("type-search:open",function(){k=!0}),RED.events.on("type-search:close",function(){k=!1}),$("#chart").on("dragenter",function(a){$.inArray("text/plain",a.originalEvent.dataTransfer.types)==-1&&$.inArray("Files",a.originalEvent.dataTransfer.types)==-1||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",e))}),$("#dropTarget").on("dragover",function(a){$.inArray("text/plain",a.originalEvent.dataTransfer.types)==-1&&$.inArray("Files",a.originalEvent.dataTransfer.types)==-1||a.preventDefault()}).on("dragleave",function(a){e()}).on("drop",function(a){if($.inArray("text/plain",a.originalEvent.dataTransfer.types)!=-1){var b=a.originalEvent.dataTransfer.getData("text/plain");b=b.substring(b.indexOf("["),b.lastIndexOf("]")+1),RED.view.importNodes(b)}else if($.inArray("Files",a.originalEvent.dataTransfer.types)!=-1){var c=a.originalEvent.dataTransfer.files;if(1===c.length){var d=c[0],f=new FileReader;f.onload=function(a){return function(a){RED.view.importNodes(a.target.result)}}(d),f.readAsText(d)}}e(),a.preventDefault()})},import:c,export:d,copyText:f}}(),RED.library=function(){function a(){$.getJSON("library/flows",function(a){var b,c=function(a,b){var d,e,f,g=document.createElement("ul");if(""===b&&(g.id="menu-item-import-library-submenu"),g.className="dropdown-menu",a.d)for(d in a.d)if(a.d.hasOwnProperty(d)){e=document.createElement("li"),e.className="dropdown-submenu pull-left",f=document.createElement("a"),f.href="#";var h=d.replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");f.innerHTML=h,e.appendChild(f),e.appendChild(c(a.d[d],b+(""!==b?"/":"")+d)),g.appendChild(e)}if(a.f)for(d in a.f)a.f.hasOwnProperty(d)&&(e=document.createElement("li"),f=document.createElement("a"),f.href="#",f.innerHTML=a.f[d],f.flowName=b+(""!==b?"/":"")+a.f[d],f.onclick=function(){$.get("library/flows/"+this.flowName,function(a){RED.view.importNodes(a)})},e.appendChild(f),g.appendChild(e));return g};a.d&&a.d._examples_&&(b=a.d._examples_,delete a.d._examples_);var d=c(a,"");$("#menu-item-import-examples").remove(),b&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(c(b,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(d)})}function b(a){function b(a){var b=document.createElement("li");return b.onmouseover=function(a){$(this).addClass("list-hover")},b.onmouseout=function(a){$(this).removeClass("list-hover")},b}function c(d,g){for(var h,i=document.createElement("ul"),j=0;j<g.length;j++){var k=g[j];"string"==typeof k?(h=b(k),h.onclick=function(){var b=k;return function(e){var f=$('<li class="active"><span class="divider">/</span> <a href="#">'+b+"</a></li>");$("a",f).click(function(e){$(this).parent().nextAll().remove(),$.getJSON("library/"+a.url+d+b,function(a){$("#node-select-library").children().first().replaceWith(c(d+b+"/",a))}),e.stopPropagation()});var g=$("#node-dialog-library-breadcrumbs");$(".active",g).removeClass("active"),g.append(f),$.getJSON("library/"+a.url+d+b,function(a){$("#node-select-library").children().first().replaceWith(c(d+b+"/",a))})}}(),h.innerHTML='<i class="fa fa-folder"></i> '+k+"</i>",i.appendChild(h)):(h=b(k),h.innerHTML=k.name,h.onclick=function(){var b=k;return function(c){$(".list-selected",i).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+a.url+d+b.fn,function(a){e=b,f.setValue(a,-1)})}}(),i.appendChild(h))}return i}function d(b){var c=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");""===c&&(c=RED._("library.unnamedType",{type:a.type}));var d=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),e=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""===d||!/.+\.js$/.test(d))return void RED.notify(RED._("library.invalidFilename"),"warning");for(var f=e+(""===e?"":"/")+d,g={},h=0;h<a.fields.length;h++){var i=a.fields[h];"name"==i?g.name=c:g[i]=$("#node-input-"+i).val()}g.text=a.editor.getValue(),$.ajax({url:"library/"+a.url+"/"+f,type:"POST",data:JSON.stringify(g),contentType:"application/json; charset=utf-8"}).done(function(b,c,d){RED.notify(RED._("library.savedType",{type:a.type}),"success")}).fail(function(a,b,c){401===a.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:a.responseText}),"error")})}var e=null,f=null;a.editor.setText&&(a.editor.setValue=function(b,c){a.editor.setText.call(a.editor,b)}),a.editor.getText&&(a.editor.getValue=a.editor.getText),$("#node-input-name").css("width","60%").after('<div class="btn-group" style="margin-left: 5px;"><a id="node-input-'+a.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+a.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+a.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+a.type+"-menu-open-library").click(function(b){$("#node-select-library").children().remove();var d=$("#node-dialog-library-breadcrumbs");d.children().first().nextAll().remove(),f.setValue("",-1),$.getJSON("library/"+a.url,function(a){$("#node-select-library").append(c("/",a)),$("#node-dialog-library-breadcrumbs a").click(function(b){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(c("/",a)),b.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),b.preventDefault()}),$("#node-input-"+a.type+"-menu-save-library").click(function(b){var c=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var d=c.replace(/[^\w-]/g,"-");""===d&&(d="unnamed-"+a.type),$("#node-dialog-library-save-filename").attr("value",d+".js"),$("#node-dialog-library-save").dialog("open"),b.preventDefault()}),f=ace.edit("node-select-library-text"),f.setTheme("ace/theme/tomorrow"),a.mode&&f.getSession().setMode(a.mode),f.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),f.renderer.$cursorLayer.element.style.opacity=0,f.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:a.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(e){for(var b=0;b<a.fields.length;b++){var c=a.fields[b];$("#node-input-"+c).val(e[c])}a.editor.setValue(f.getValue(),-1)}$(this).dialog("close")}}],open:function(a){var b=$("form",this);b.height(b.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",b).children().height(b.height()-60)},resize:function(a){var b=$("form",this);b.height(b.parent().height()-30),$(".form-row:last-child",b).children().height(b.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){d(!0),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){d(!1),$(this).dialog("close")}}]})}function c(){var a=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(a)),d.dialog("open")}var d;return{init:function(){RED.actions.add("core:library-export",c),RED.events.on("view:selection-changed",function(a){a.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.settings.theme("menu.menu-item-import-library")!==!1&&a(),d=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var a=$("#node-input-library-filename").val();/^\s*$/.test(a)||$.ajax({url:"library/flows/"+a,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(a,b,c){401===a.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:a.responseText}),"error")}),$(this).dialog("close")}}],open:function(a){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(a){}}),d.children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:b,loadFlowLibrary:a,export:c}}(),RED.notify=function(){var a=[],b=0;return function(c,d,e,f){if(a.length>4)for(var g=a.length,h=0;g>4&&h<a.length;h+=1){var i=a[h];i.fixed||(window.clearTimeout(i.timeoutid),i.close(),g-=1)}var j=document.createElement("div");return j.id="red-notification-"+b,j.className="notification",j.fixed=e,d&&(j.className="notification notification-"+d),j.style.display="none","string"==typeof c?j.innerHTML=c:$(j).append(c),$("#notifications").append(j),$(j).slideDown(300),j.close=function(){var b=j;return function(){a.splice(a.indexOf(b),1),$(b).slideUp(300,function(){b.parentNode.removeChild(b)})}}(),j.update=function(){var a=j;return function(b,c){"string"==typeof b?a.innerHTML=b:$(a).empty().append(b),void 0!==c&&c>0?(window.clearTimeout(a.timeoutid),a.timeoutid=window.setTimeout(a.close,c)):window.clearTimeout(a.timeoutid)}}(),e||($(j).click(function(){var a=j;return function(){a.close(),window.clearTimeout(a.timeoutid)}}()),j.timeoutid=window.setTimeout(j.close,f||3e3)),a.push(j),b+=1,j}}(),RED.search=function(){function a(a){var b=RED.utils.getNodeLabel(a);b&&(b=(""+b).toLowerCase(),p[b]=p[b]||{},p[b][a.id]={node:a,label:b}),b=b||a.label||a.name||a.id||"";var c=["id","type","name","label","info"];a._def&&a._def.defaults&&(c=c.concat(Object.keys(a._def.defaults)));for(var d=0;d<c.length;d++)if(a.hasOwnProperty(c[d])){var e=a[c[d]];"string"!=typeof e&&"number"!=typeof e||(e=(""+e).toLowerCase(),p[e]=p[e]||{},p[e][a.id]={node:a,label:b})}}function b(){p={},RED.nodes.eachWorkspace(a),RED.nodes.eachSubflow(a),RED.nodes.eachConfig(a),RED.nodes.eachNode(a),q=Object.keys(p),q.sort(),q.forEach(function(a){p[a]=Object.keys(p[a]).map(function(b){return p[a][b]})})}function c(a){if(k.editableList("empty"),n=-1,r=[],a.length>0){a=a.toLowerCase();var b,c,d=[],e={};for(b=0;b<q.length;b++){var f=q[b],g=q[b].indexOf(a);if(g>-1)for(c=0;c<p[f].length;c++){var h=p[f][c];e[h.node.id]=e[h.node.id]=h,e[h.node.id].index=Math.min(e[h.node.id].index||1/0,g)}}for(d=Object.keys(e),d.sort(function(a,b){return e[a].index-e[b].index}),b=0;b<d.length;b++)r.push(e[d[b]]);if(r.length>0)for(b=0;b<Math.min(r.length,25);b++)k.editableList("addItem",r[b]);else k.editableList("addItem",{})}}function d(){var a=k.find("li.selected");if(1===a.length){var b=k.parent(),c=b.height(),d=(b.scrollTop(),a.position().top),e=a.height();d+e>c?b.animate({scrollTop:"-="+(c-(d+e)-10)},50):d<0&&b.animate({scrollTop:"+="+(d-10)},50)}}function e(){m=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var a=$("<div>",{class:"red-ui-search-container"}).appendTo(m);j=$('<input type="text" placeholder="search your flows">').appendTo(a).searchBox({delay:200,change:function(){c($(this).val())}}),j.on("keydown",function(a){var b;r.length>0&&(40===a.keyCode?(b=k.children(),n<b.length-1&&(n>-1&&$(b[n]).removeClass("selected"),n++),$(b[n]).addClass("selected"),d(),a.preventDefault()):38===a.keyCode?(b=k.children(),n>0&&(n<b.length&&$(b[n]).removeClass("selected"),n--),$(b[n]).addClass("selected"),d(),a.preventDefault()):13===a.keyCode&&r.length>0&&f(r[Math.max(0,n)].node))});var b=$("<div>",{class:"red-ui-search-results-container"}).appendTo(m);k=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(b).editableList({addButton:!1,addItem:function(a,b,c){var d=c.node;
if(void 0===d)$("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(a);else{var e=d._def,g=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(a),h=$("<div>",{class:"red-ui-search-result-node"}).appendTo(g),i=e.color,j=RED.utils.getNodeIcon(e,d);"tab"===d.type&&(i="#C0DEED"),h.css("backgroundColor",i);var k=$("<div/>",{class:"palette_icon_container"}).appendTo(h);$("<div/>",{class:"palette_icon",style:"background-image: url("+j+")"}).appendTo(k);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(g);if(d.z){var m=RED.nodes.workspace(d.z);m?m="flow:"+m.label:(m=RED.nodes.subflow(d.z),m="subflow:"+m.name),$("<div>",{class:"red-ui-search-result-node-flow"}).html(m).appendTo(l)}$("<div>",{class:"red-ui-search-result-node-label"}).html(c.label||d.id).appendTo(l),$("<div>",{class:"red-ui-search-result-node-type"}).html(d.type).appendTo(l),$("<div>",{class:"red-ui-search-result-node-id"}).html(d.id).appendTo(l),g.click(function(a){a.preventDefault(),f(d)})}},scrollOnAdd:!1})}function f(a){h(),RED.view.reveal(a.id)}function g(){l||(o||(RED.keyboard.add("*","escape",function(){h()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),b(),null===m&&e(),m.slideDown(300),RED.events.emit("search:open"),o=!0),j.focus())}function h(){o&&(RED.keyboard.remove("escape"),o=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==m&&m.slideUp(200,function(){j.searchBox("value","")}),RED.events.emit("search:close"))}function i(){RED.actions.add("core:search",g),RED.events.on("editor:open",function(){l=!0}),RED.events.on("editor:close",function(){l=!1}),RED.events.on("type-search:open",function(){l=!0}),RED.events.on("type-search:close",function(){l=!1}),$("#header-shade").on("mousedown",h),$("#editor-shade").on("mousedown",h),$("#palette-shade").on("mousedown",h),$("#sidebar-shade").on("mousedown",h)}var j,k,l=!1,m=null,n=-1,o=!1,p={},q=[],r=[];return{init:i,show:g,hide:h}}(),RED.typeSearch=function(){function a(a){q=a.toLowerCase();k.editableList("filter");setTimeout(function(){o=0,k.children().removeClass("selected"),k.children(":visible:first").addClass("selected")},100)}function b(){var a=k.find("li.selected");if(1===a.length){var b=k.parent(),c=b.height(),d=(b.scrollTop(),a.position().top),e=a.height();d+e>c?b.animate({scrollTop:"-="+(c-(d+e)-10)},50):d<0&&b.animate({scrollTop:"+="+(d-10)},50)}}function c(){n=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var c=$("<div>",{class:"red-ui-search-container"}).appendTo(n);j=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(c).searchBox({delay:50,change:function(){a($(this).val())}}),j.on("keydown",function(a){var c=k.children(":visible");if(c.length>0)if(40===a.keyCode)o<c.length-1&&(o>-1&&$(c[o]).removeClass("selected"),o++),$(c[o]).addClass("selected"),b(),a.preventDefault();else if(38===a.keyCode)o>0&&(o<c.length&&$(c[o]).removeClass("selected"),o--),$(c[o]).addClass("selected"),b(),a.preventDefault();else if(13===a.keyCode){var e=Math.max(0,o);e<c.length&&d($(c[e]).find(".red-ui-editableList-item-content").data("data"))}}),l=$("<div>",{class:"red-ui-search-results-container"}).appendTo(n),k=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(l).editableList({addButton:!1,filter:function(a){return""===q||!a.recent&&!a.common&&(""===q||a.index.indexOf(q)>-1)},addItem:function(a,b,c){var e=c.def;c.index=c.type.toLowerCase(),c.separator&&a.addClass("red-ui-search-result-separator");var f=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(a),g=$("<div>",{class:"red-ui-search-result-node"}).appendTo(f),h=e.color,i=RED.utils.getNodeIcon(e);g.css("backgroundColor",h);var j=$("<div/>",{class:"palette_icon_container"}).appendTo(g);$("<div/>",{class:"palette_icon",style:"background-image: url("+i+")"}).appendTo(j),e.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(g),e.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(g);var k=$("<div>",{class:"red-ui-search-result-description"}).appendTo(f),l=c.label;c.index+="|"+l.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).html(l).appendTo(k),f.click(function(a){a.preventDefault(),d(c)})},scrollOnAdd:!1})}function d(a){g(),r[a.type]=Date.now(),m(a.type)}function e(a){if(p){for(var b=$(a.target);"body"!==b.prop("nodeName").toLowerCase();){if("red-ui-type-search"===b.attr("id"))return;b=b.parent()}g(!0)}}function f(a){p?(n.hide(),l.hide()):(RED.keyboard.add("*","escape",function(){g()}),null===n&&c(),p=!0,setTimeout(function(){$(document).on("mousedown.type-search",e),$(document).on("mouseup.type-search",e),$(document).on("click.type-search",e)},200)),i(),m=a.add,RED.events.emit("type-search:open"),n.css({left:a.x+"px",top:a.y+"px"}).show(),l.slideDown(300),setTimeout(function(){l.find(".red-ui-editableList-container").scrollTop(0),j.focus()},100)}function g(a){p&&(RED.keyboard.remove("escape"),p=!1,null!==n&&l.slideUp(a?50:200,function(){n.hide(),j.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function h(a,b){var c=a;if("undefined"!=typeof b.paletteLabel)try{c=("function"==typeof b.paletteLabel?b.paletteLabel.call(b):b.paletteLabel)||"",c+=" ("+a+")"}catch(b){console.log("Definition error: "+a+".paletteLabel",b)}return c}function i(){var a;k.editableList("empty"),j.searchBox("value",""),o=-1;var b=["inject","debug","function","change","switch"],c=Object.keys(r);c.sort(function(a,b){return r[b]-r[a]}),c=c.filter(function(a){return b.indexOf(a)===-1});var d=[];RED.nodes.registry.getNodeTypes().forEach(function(a){var b=RED.nodes.getType(a);"config"!==b.category&&"unknown"!==a&&d.push({type:a,def:b,label:h(a,b)})}),d.sort(function(a,b){var c=a.label.toLowerCase(),d=b.label.toLowerCase();return c<d?-1:c===d?0:1});var e;for(a=0;a<b.length;a++)e={type:b[a],common:!0,def:RED.nodes.getType(b[a])},e.label=h(e.type,e.def),a===b.length-1&&(e.separator=!0),k.editableList("addItem",e);for(a=0;a<Math.min(5,c.length);a++)e={type:c[a],def:RED.nodes.getType(c[a]),recent:!0},e.label=h(e.type,e.def),a===c.length-1&&(e.separator=!0),k.editableList("addItem",e);for(a=0;a<d.length;a++)k.editableList("addItem",d[a]);setTimeout(function(){o=0,k.children(":first").addClass("selected")},100)}var j,k,l,m,n=null,o=-1,p=!1,q="",r={};return{show:f,hide:g}}(),RED.subflow=function(){function a(a,b){var c={x:50,y:30};b||(c.x+=110);for(var d=0;d<a.out.length+a.in.length;d++){var e;e=d<a.out.length?a.out[d]:a.in[d-a.out.length],e.x==c.x&&e.y==c.y&&(c.x+=55,d=0)}return c}function b(){var b=RED.nodes.subflow(RED.workspaces.active()),c=a(b,!0),d={type:"subflow",direction:"in",z:b.id,i:b.in.length,x:c.x,y:c.y,id:RED.nodes.id()},e=b.in.length;b.in.push(d),b.dirty=!0;var g=RED.nodes.dirty(),h=b.changed;b.changed=!0;var i=f(!0),j={t:"edit",node:b,dirty:g,changed:h,subflow:{inputCount:e,instances:i.instances}};RED.history.push(j),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input .spinner-value").html(b.in.length)}function c(){var a=RED.nodes.subflow(RED.workspaces.active());if(0!==a.in.length){"undefined"==typeof removedSubflowInputs&&(removedSubflowInputs=[a.in[a.in.length-1]]);var b=[];for(removedSubflowInputs.sort(function(a,b){return b.i-a.i}),i=0;i<removedSubflowInputs.length;i++){var c=removedSubflowInputs[i];a.in.splice(c.i,1);var d=[],e=[];RED.nodes.eachLink(function(b){"subflow"==b.source.type&&b.source.z==a.id&&b.source.i==c.i&&d.push(b),b.source.type=="subflow:"+a.id&&(b.sourcePort==output.i?d.push(b):b.targetPort>c.i&&e.push(b))}),d.forEach(function(a){RED.nodes.removeLink(a)}),e.forEach(function(a){a.targetPort--}),b=b.concat(d);for(var f=c.i;f<a.in.length;f++)a.in[f].i--,a.in[f].dirty=!0}return a.changed=!0,{subflowInputs:removedSubflowInputs,links:b}}}function d(b){var c=RED.nodes.subflow(RED.workspaces.active()),d=a(c,!1),e={type:"subflow",direction:"out",z:c.id,i:c.out.length,x:d.x,y:d.y,id:RED.nodes.id()},g=c.out.length;c.out.push(e),c.dirty=!0;var h=RED.nodes.dirty(),i=c.changed;c.changed=!0;var j=f(!0),k={t:"edit",node:c,dirty:h,changed:i,subflow:{outputCount:g,instances:j.instances}};RED.history.push(k),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(c.out.length)}function e(a){var b=RED.nodes.subflow(RED.workspaces.active());if(0!==b.out.length){"undefined"==typeof a&&(a=[b.out[b.out.length-1]]);var c=[];for(a.sort(function(a,b){return b.i-a.i}),i=0;i<a.length;i++){var d=a[i];b.out.splice(d.i,1);var e=[],f=[];RED.nodes.eachLink(function(a){"subflow"==a.target.type&&a.target.z==b.id&&a.target.i==d.i&&e.push(a),a.source.type=="subflow:"+b.id&&(a.sourcePort==d.i?e.push(a):a.sourcePort>d.i&&f.push(a))}),e.forEach(function(a){RED.nodes.removeLink(a)}),f.forEach(function(a){a.sourcePort--}),c=c.concat(e);for(var g=d.i;g<b.out.length;g++)b.out[g].i--,b.out[g].dirty=!0}return b.changed=!0,{subflowOutputs:a,links:c}}}function f(a){var b=RED.nodes.subflow(RED.workspaces.active());g(b);var c=[];if(b)return RED.nodes.filterNodes({type:"subflow:"+b.id}).forEach(function(d){for(c.push({id:d.id,changed:d.changed}),a&&(d.changed=!0),d.inputs=b.in.length;d.inputs<d.inputPorts.length;)d.inputPorts.pop();for(d.outputs=b.out.length;d.outputs<d.outputPorts.length;)d.outputPorts.pop();d.resize=!0,d.dirty=!0,RED.editor.updateNodeProperties(d)}),RED.editor.validateNode(b),{instances:c}}function g(a){a&&($("#workspace-subflow-input .spinner-value").html(a.in.length),$("#workspace-subflow-output .spinner-value").html(a.out.length))}function h(a){var h=$("#workspace-toolbar");h.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(h),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div id="workspace-subflow-input" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-input-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-input-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(h),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(h),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(h),h.i18n(),$("#workspace-subflow-output-remove").click(function(b){b.preventDefault();var c=RED.nodes.dirty(),d=a.changed,g=e();if(g){var h=f(!0);RED.history.push({t:"delete",links:g.links,subflowOutputs:g.subflowOutputs,changed:d,dirty:c,subflow:{instances:h.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(a){a.preventDefault(),d()}),$("#workspace-subflow-input-add").click(function(a){a.preventDefault(),b()}),$("#workspace-subflow-input-remove").click(function(b){b.preventDefault();var d=RED.nodes.dirty(),e=a.changed;a.changed=!0;var g=c();if(g){var h=f(!0);RED.history.push({t:"delete",links:g.links,changed:e,subflowInputs:g.subflowInputs,dirty:d,subflow:{instances:h.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(a){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),a.preventDefault()}),$("#workspace-subflow-delete").click(function(a){a.preventDefault();var b=RED.nodes.dirty(),c=k(RED.workspaces.active());c.t="delete",c.dirty=b,RED.history.push(c)}),g(a),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function j(){$("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"})}function k(a){var b=[],c=[],d=RED.nodes.subflow(a);RED.nodes.eachNode(function(a){a.type=="subflow:"+d.id&&b.push(a),a.z==d.id&&b.push(a)}),RED.nodes.eachConfig(function(a){a.z==d.id&&b.push(a)});for(var e=[],f=0;f<b.length;f++){var g=RED.nodes.remove(b[f].id);c=c.concat(g.links),e=e.concat(g.nodes)}return b=b.concat(e),RED.nodes.removeSubflow(d),RED.workspaces.remove(d),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:b,links:c,subflow:{subflow:d}}}function l(){RED.events.on("workspace:change",function(a){var b=RED.nodes.subflow(a.workspace);b?h(b):j()}),RED.actions.add("core:create-subflow",m)}function m(){var a=0;RED.nodes.eachSubflow(function(b){var c=new RegExp("^Subflow (\\d+)$").exec(b.name);c&&(a=Math.max(a,c[1]))});var b="Subflow "+(a+1),c=RED.nodes.id(),d={type:"subflow",id:c,name:b,info:"",in:[],out:[]};RED.nodes.addSubflow(d),RED.history.push({t:"createSubflow",subflow:{subflow:d},dirty:RED.nodes.dirty()}),RED.workspaces.show(c),RED.nodes.dirty(!0)}return{init:l,createSubflow:m,removeSubflow:k,refresh:f,removeInput:c,removeOutput:e}}(),RED.userSettings=function(){function a(a){i.push(a)}function b(a){if(!h){h=!0;var b={title:"User Settings",buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(a){g=a.width},open:function(b){var c=b.find(".editor-tray-body"),d=$("<div></div>").appendTo(c),e=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(d);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(e);var f=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(a){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+a.id).show(),a.pane.focus&&a.pane.focus()},50)}}),g=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(d);i.forEach(function(a){f.addTab({id:"user-settings-tab-"+a.id,label:a.title,pane:a}),a.get().hide().appendTo(g)}),d.i18n(),f.activateTab("user-settings-tab-"+(a||"view")),$("#sidebar-shade").show()},close:function(){h=!1,i.forEach(function(a){a.close&&a.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==g&&(b.width=g),RED.tray.show(b)}}function c(){var a=$('<div id="user-settings-tab-view" class="node-help"></div>');return j.forEach(function(b){$("<h3></h3>").text(b.title).appendTo(a),b.options.forEach(function(b){var c,d=RED.settings.get(b.setting),e=$('<div class="user-settings-row"></div>').appendTo(a);b.toggle?(c=$('<label for="user-settings-'+b.setting+'"><input id="user-settings-'+b.setting+'" type="checkbox"> '+RED._(b.label)+"</label>").appendTo(e).find("input"),c.prop("checked",d)):($('<label for="user-settings-'+b.setting+'">'+RED._(b.label)+"</label>").appendTo(e),$('<input id="user-settings-'+b.setting+'" type="'+(b.type||"text")+'">').appendTo(e).val(d))})}),a}function d(a,b){var c=k[a];RED.settings.set(c.setting,b);var d=c.onchange;"string"==typeof d&&(d=RED.actions.get(d)),d&&d.call(c,b)}function e(a){var b=k[a],c=RED.settings.get(b.setting);d(a,!c)}function f(){RED.actions.add("core:show-user-settings",b),RED.actions.add("core:show-help",function(){b("keyboard")}),a({id:"view",title:"View",get:c,close:function(){j.forEach(function(a){a.options.forEach(function(a){var b=$("#user-settings-"+a.setting);a.toggle?d(a.setting,b.prop("checked")):d(a.setting,b.val())})})}}),j.forEach(function(a){a.options.forEach(function(a){if(k[a.setting]=a,a.onchange){var b=RED.settings.get(a.setting);null===b&&a.hasOwnProperty("default")&&(b=a.default,RED.settings.set(a.setting,b));var c=a.onchange;"string"==typeof c&&(c=RED.actions.get(c)),c&&c.call(a,b)}})})}var g=700,h=!1,i=[],j=[{title:"Grid",options:[{setting:"view-show-grid",label:"menu.label.view.showGrid",default:!0,toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",label:"menu.label.view.snapGrid",default:!0,toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:10,onchange:RED.view.gridSize}]},{title:"Nodes",options:[{setting:"view-node-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"Other",options:[{setting:"view-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],k={};return{init:f,toggle:e,show:b,add:a}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){function a(a,f,g){c=!0;try{$("body").width(),$("body").height();b=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){q(),d3.event.preventDefault()});for(var h=b.append("div").style({position:"absolute",top:f[1]-80+"px",left:f[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),i=[],j=function(a,b,c){c.el=h.append("div").style({position:"absolute",top:b+80-25+"px",left:a+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),c.el.html(c.name),c.disabled&&c.el.style({"border-color":"#ccc",color:"#ccc"}),c.x=a,c.y=b,i.push(c),c.el.on("touchstart",function(){c.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),c.el.on("touchend",function(){q(),c.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},k=g.length,l=Math.max(Math.PI/(k-1),Math.PI/4),m=Math.PI,n=0;n<k;n++){var o=Math.floor(80*Math.cos(m)),p=Math.floor(80*Math.sin(m));g[n].name&&j(o,p,g[n]),m+=l}var q=function(){c=!1,e=null,b.remove(),b=null};a.on("touchend.radial",function(){if(a.on("touchend.radial",null),a.on("touchmenu.radial",null),e){try{e.onselect()}catch(a){RED._debug(a)}q()}else d&&q()}),a.on("touchmove.radial",function(){try{for(var a=d3.event.touches.item(0),b=[a.pageX-f[0],a.pageY-f[1]],c=0;c<i.length;c++){var g=i[c];g.disabled||(b[0]>g.x-30&&b[0]<g.x+30&&b[1]>g.y-30&&b[1]<g.y+30?g!==e&&(g.el.style("background","#999"),e=g):g===e?(g.el.style("background","#fff"),e=null):g.el.style("background","#fff"))}if(!e){var h=Math.abs(b[0]*b[0]+b[1]*b[1]);d=h>6400}}catch(a){RED._debug(a)}})}catch(a){RED._debug(a)}}var b=null,c=!1,d=!1,e=null;return{show:a,active:function(){return c}}}();