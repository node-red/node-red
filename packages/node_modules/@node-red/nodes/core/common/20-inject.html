<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="inject">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>

    <div class="form-row node-input-property-container-row">
        <ol id="node-input-property-container"></ol>
    </div>

    <div class="form-row" id="node-once">
        <label for="node-input-once">&nbsp;</label>
        <input type="checkbox" id="node-input-once" style="display:inline-block; width:15px; vertical-align:baseline;">
        <span data-i18n="inject.onstart"></span>&nbsp;
        <input type="text" id="node-input-onceDelay" placeholder="0.1" style="width:45px; height:28px;">&nbsp;
        <span data-i18n="inject.onceDelay"></span>
    </div>

    <div class="form-row cronti-form">
        <label for=""><i class="fa fa-repeat"></i> <span data-i18n="inject.label.repeat"></span></label>
        <select id="inject-time-type-select">
            <option value="none" data-i18n="inject.none"></option>
            <option value="interval" data-i18n="inject.interval"></option>
            <option value="interval-time" data-i18n="inject.interval-time"></option>
            <option value="time" data-i18n="inject.time"></option>
            <option value="cronti-on-week" data-i18n="inject.cronti.on-week"></option>
            <option value="cronti-on-interval-time" data-i18n="inject.cronti.on-interval-time"></option>
            <option value="cronti-on-time" data-i18n="inject.cronti.on-time"></option>
            <option value="cronti-on-crontime" data-i18n="inject.cronti.on-crontime"></option>
            <option value="cronti-on-date" data-i18n="inject.cronti.on-date"></option>
        </select>
        <input type="hidden" id="node-input-repeat">
        <input type="hidden" id="node-input-crontab">
        <input type="hidden" id="node-input-crontiMethod">
        <input type="hidden" id="node-input-crontiArgs">
    </div>

    <!-- Cronti Begin -->
    <div class="form-row inject-time-row hidden cronti-form" id="inject-time-row-cronti-on-week">
        <span data-i18n="inject.cronti.first-day-of-week"></span>
        <select id="inject-time-cronti-on-week-first-day-of-week">
            <option value=""></option>
            <option value="1" data-i18n="inject.cronti.monday"></option>
            <option value="2" data-i18n="inject.cronti.tuesday"></option>
            <option value="3" data-i18n="inject.cronti.wednesday"></option>
            <option value="4" data-i18n="inject.cronti.thursday"></option>
            <option value="5" data-i18n="inject.cronti.friday"></option>
            <option value="6" data-i18n="inject.cronti.saturday"></option>
            <option value="0" data-i18n="inject.cronti.sunday"></option>
        </select>
        <p class="clear"></p>
        <span data-i18n="inject.cronti.date"></span>
        <input type="datetime-local" id="inject-time-cronti-on-week-date">
        <p class="clear"></p>
    </div>

    <div class="form-row inject-time-row hidden cronti-form" id="inject-time-row-cronti-on-interval-time">
        <span data-i18n="inject.cronti.start-date"></span>
        <input type="datetime-local" id="inject-time-cronti-on-interval-time-start-date">
        <p class="clear"></p>
        <span data-i18n="inject.cronti.end-date"></span>
        <input type="datetime-local" id="inject-time-cronti-on-interval-time-end-date">
        <p class="clear"></p>
        <span data-i18n="inject.every"></span>
        <select id="inject-time-cronti-on-interval-time-units">
            <option value=""></option>
            <option value="m" data-i18n="inject.minutes"></option>
            <option value="h" data-i18n="inject.hours"></option>
            <option value="d" data-i18n="inject.cronti.days"></option>
        </select>
        <input id="inject-time-cronti-on-interval-time-count" class="inject-time-count" value="1"></input>
        <p class="clear"></p>
    </div>

    <div class="form-row inject-time-row hidden cronti-form" id="inject-time-row-cronti-on-time">
        <span data-i18n="inject.cronti.first-day-of-week"></span>
        <select id="inject-time-cronti-on-time-first-day-of-week">
            <option value=""></option>
            <option value="1" data-i18n="inject.cronti.monday"></option>
            <option value="2" data-i18n="inject.cronti.tuesday"></option>
            <option value="3" data-i18n="inject.cronti.wednesday"></option>
            <option value="4" data-i18n="inject.cronti.thursday"></option>
            <option value="5" data-i18n="inject.cronti.friday"></option>
            <option value="6" data-i18n="inject.cronti.saturday"></option>
            <option value="0" data-i18n="inject.cronti.sunday"></option>
        </select>
        <p class="clear"></p>
        <span data-i18n="inject.cronti.month"></span>
        <select id="inject-time-cronti-on-time-month">
            <option value=""></option>
            <option value="0" data-i18n="inject.cronti.january"></option>
            <option value="1" data-i18n="inject.cronti.february"></option>
            <option value="2" data-i18n="inject.cronti.march"></option>
            <option value="3" data-i18n="inject.cronti.april"></option>
            <option value="4" data-i18n="inject.cronti.may"></option>
            <option value="5" data-i18n="inject.cronti.june"></option>
            <option value="6" data-i18n="inject.cronti.july"></option>
            <option value="7" data-i18n="inject.cronti.august"></option>
            <option value="8" data-i18n="inject.cronti.september"></option>
            <option value="9" data-i18n="inject.cronti.october"></option>
            <option value="10" data-i18n="inject.cronti.november"></option>
            <option value="11" data-i18n="inject.cronti.december"></option>
        </select>
        <p class="clear"></p>
        <span data-i18n="inject.cronti.week"></span>
        <select id="inject-time-cronti-on-time-week">
            <option value=""></option>
            <option value="0" data-i18n="inject.cronti.first-week"></option>
            <option value="1" data-i18n="inject.cronti.second-week"></option>
            <option value="2" data-i18n="inject.cronti.third-week"></option>
            <option value="-1" data-i18n="inject.cronti.last-week"></option>
        </select>
        <p class="clear"></p>
        <span data-i18n="inject.cronti.weekdays"></span>
        <select id="inject-time-cronti-on-time-weekdays">
            <option value=""></option>
            <option value="1" data-i18n="inject.cronti.monday"></option>
            <option value="2" data-i18n="inject.cronti.tuesday"></option>
            <option value="3" data-i18n="inject.cronti.wednesday"></option>
            <option value="4" data-i18n="inject.cronti.thursday"></option>
            <option value="5" data-i18n="inject.cronti.friday"></option>
            <option value="6" data-i18n="inject.cronti.saturday"></option>
            <option value="0" data-i18n="inject.cronti.sunday"></option>
        </select>
        <p class="clear"></p>
        <span data-i18n="inject.cronti.time"></span>
        <input type="time" id="inject-time-cronti-on-time-time">
        <p class="clear"></p>
    </div>

    <div class="form-row inject-time-row hidden cronti-form" id="inject-time-row-cronti-on-crontime">
        <span data-i18n="inject.cronti.crontime"></span>
        <input type="text" id="inject-time-cronti-on-crontime" placeholder="* * * * *">
        <p class="clear"></p>
    </div>

    <div class="form-row inject-time-row hidden cronti-form" id="inject-time-row-cronti-on-date">
        <span data-i18n="inject.cronti.date"></span>
        <input type="datetime-local" id="inject-time-cronti-on-date">
        <p></p>
        <div style="text-align: right;"><span data-i18n="node-red:inject.cronti.is-month-of-date"></span><input type="checkbox" id="inject-time-cronti-on-date-isMonthOfDate" style="width: 20px !important;margin-top: 10px;margin-left: 5px;"> </div>
        <p class="clear"></p>
    </div>
    <!-- Cronti End -->

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval">
        <span data-i18n="inject.every"></span>
        <select style="width:100px" id="inject-time-interval-units">
            <option value="s" data-i18n="inject.seconds"></option>
            <option value="m" data-i18n="inject.minutes"></option>
            <option value="h" data-i18n="inject.hours"></option>
        </select>
        <input id="inject-time-interval-count" class="inject-time-count" value="1"></input>
        <p></p>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-interval-time">
        <span data-i18n="inject.every"></span> <select style="width:90px; margin-left:20px;" id="inject-time-interval-time-units" class="inject-time-int-count" value="1">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="10">10</option>
            <option value="12">12</option>
            <option value="15">15</option>
            <option value="20">20</option>
            <option value="30">30</option>
            <option value="0">60</option>
        </select> <span data-i18n="inject.minutes"></span><br/>
        <span data-i18n="inject.between"></span> <select id="inject-time-interval-time-start" class="inject-time-times"></select>
        <span data-i18n="inject.and"></span> <select id="inject-time-interval-time-end" class="inject-time-times"></select><br/>
        <div id="inject-time-interval-time-days" class="inject-time-days" style="margin-top:5px">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on">on</div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

    <div class="form-row inject-time-row hidden" id="inject-time-row-time">
        <span data-i18n="inject.at"></span> <input type="text" id="inject-time-time" value="12:00"></input><br/>
        <div id="inject-time-time-days" class="inject-time-days">
            <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="inject.on"></div>
            <div style="display:inline-block;">
                <div>
                    <label><input type='checkbox' checked value='1'/> <span data-i18n="inject.days.0"></span></label>
                    <label><input type='checkbox' checked value='2'/> <span data-i18n="inject.days.1"></span></label>
                    <label><input type='checkbox' checked value='3'/> <span data-i18n="inject.days.2"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='4'/> <span data-i18n="inject.days.3"></span></label>
                    <label><input type='checkbox' checked value='5'/> <span data-i18n="inject.days.4"></span></label>
                    <label><input type='checkbox' checked value='6'/> <span data-i18n="inject.days.5"></span></label>
                </div>
                <div>
                    <label><input type='checkbox' checked value='0'/> <span data-i18n="inject.days.6"></span></label>
                </div>
            </div>
        </div>
    </div>

</script>
<style>
    .inject-time-row {
        padding-left: 110px;
    }
    .inject-time-row select {
        margin: 3px 0;
    }
    .inject-time-days label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 100px;
    }
    .inject-time-days input {
        width: auto !important;
        vertical-align: baseline !important;
    }
    .inject-time-times {
        width: 90px !important;
    }
    #inject-time-time {
        width: 75px;
        margin-left: 8px;
        margin-bottom: 8px;
    }
    .inject-time-count {
        padding-left: 3px !important;
        width: 80px !important;
    }

    .cronti-form select:not(#inject-time-cronti-on-interval-time-units), .cronti-form input {
        width: calc(100% - 110px) !important;
        float: right;
    }

    .cronti-form span {
        line-height: 2.5;
    }

    .clear {
        clear: both !important;
    }

    select#inject-time-cronti-on-interval-time-units, select#inject-time-interval-units {
        float: right;
        width: calc(50% - 60px);
        margin-left: 5px;
    }
    span.ui-spinner.ui-corner-all.ui-widget.ui-widget-content {
        float: right;
        width: calc(50% - 60px);
        margin-right: 5px;
        margin-top: 2.5px;
    }

    input#inject-time-cronti-on-interval-time-count, input#inject-time-interval-count {
        text-align: right;
        padding-right: 12px;
        width: calc(100% - 30px) !important;
    }
</style>

<script type="text/javascript">
(function() {

    function resizeDialog(size) {
        size = size || { height: $(".red-ui-tray-content form").height() }
        var rows = $("#dialog-form>div:not(.node-input-property-container-row):visible");
        var height = size.height;
        for (var i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        var editorRow = $("#dialog-form>div.node-input-property-container-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        height += 16;
        $("#node-input-property-container").editableList('height',height);
    }
    /** Retrieve editableList items (refactored for re-use in the form inject button)*/
    function getProps(el, legacy) {
        var result = {
            props: []
        }
        el.each(function(i) {
            var prop = $(this);
            var p = {
                p:prop.find(".node-input-prop-property-name").typedInput('value')
            };
            if (p.p) {
                p.v = prop.find(".node-input-prop-property-value").typedInput('value');
                p.vt = prop.find(".node-input-prop-property-value").typedInput('type');
                if(legacy) {
                    if (p.p === "payload") { // save payload to old "legacy" property
                        result.payloadType = p.vt;
                        result.payload = p.v;
                        delete p.v;
                        delete p.vt;
                    } else if (p.p === "topic" && p.vt === "str") {
                        result.topic = p.v;
                        delete p.v;
                    }
                }
                result.props.push(p);
            }
        });
        return result;
    }
    /** Perform inject, optionally sending a custom msg (refactored for re-use in the form inject button)*/
    function doInject(node, customMsg) {
        var label = node._def.label.call(node,customMsg?customMsg.__user_inject_props__:undefined);
        if (label.length > 30) {
            label = label.substring(0, 50) + "...";
        }
        label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        $.ajax({
            url: "inject/" + node.id,
            type: "POST",
            data: JSON.stringify(customMsg||{}),
            contentType: "application/json; charset=utf-8",
            success: function (resp) {
                RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject", timeout: 2000 });
            },
            error: function (jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 404) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                } else if (jqXHR.status == 500) {
                    RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                } else if (jqXHR.status == 0) {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                } else {
                    RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                }
            }
        });
    }
    RED.nodes.registerType('inject',{  
        category: 'common',
        color:"#a6bbcf",
        defaults: {
            name: {value:""},
            props:{value:[{p:"payload"},{p:"topic",vt:"str"}], validate:function(v, opt) {
                    if (!v || v.length === 0) { return true }
                    for (var i=0;i<v.length;i++) {
                        if (/msg|flow|global/.test(v[i].vt)) {
                            if (!RED.utils.validatePropertyExpression(v[i].v)) {
                                return RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v });
                            }
                        } else if (v[i].vt === "jsonata") {
                            try{ jsonata(v[i].v); }
                            catch(e){
                                return RED._("node-red:inject.errors.invalid-jsonata", { prop: 'msg.'+v[i].p, error: e.message });
                            }
                        } else if (v[i].vt === "json") {
                            try{ JSON.parse(v[i].v); }
                            catch(e){
                                return RED._("node-red:inject.errors.invalid-json", { prop: 'msg.'+v[i].p, error: e.message });
                            }
                        } else if (v[i].vt === "num"){
                            if (!/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(v[i].v)) {
                                return RED._("node-red:inject.errors.invalid-prop", { prop: 'msg.'+v[i].p, error: v[i].v });
                            }
                        }
                    }
                    return true;
                }
            },
            repeat: {
                value:"", validate: function(v, opt) {
                    if ((v === "") ||
                        (RED.validators.number(v) &&
                         (v >= 0) && (v <= 2147483))) {
                        return true;
                    }
                    return RED._("node-red:inject.errors.invalid-repeat");
                }
            },
            crontab: {value:""},
            once: {value:false},
            onceDelay: {value:0.1},
            topic: {value:""},
            payload: {value:"", validate: RED.validators.typedInput("payloadType", false) },
            payloadType: {value:"date"},
            crontiMethod: {value: ""},
            crontiArgs: {value: "[]"}
        },
        icon: "inject.svg",
        inputs:0,
        outputs:1,
        outputLabels: function(index) {
            var lab = '';

            // if only payload and topic - display payload type
            // if only one property - show it's type
            // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
            // this.props will not be an array for legacy inject nodes until they are re-deployed
            //
            var props = this.props;
            if (!Array.isArray(props)) {
                props = [
                    { p:"payload", v: this.payload, vt: this.payloadType },
                    { p:"topic", v: this.topic, vt: "str" }
                ]
            }
            if (props) {
                for (var i=0,l=props.length; i<l; i++) {
                    if (i > 0) lab += "\n";
                    if (i === 5) {
                        lab += "... +"+(props.length-5);
                        break;
                    }
                    lab += props[i].p+": ";

                    var propType = props[i].p === "payload"? this.payloadType : props[i].vt;
                    if (propType === "json") {
                        try {
                            var parsedProp = JSON.parse(props[i].p === "payload"? this.payload : props[i].v);
                            propType = typeof parsedProp;
                            if (propType === "object" && Array.isArray(parsedProp)) {
                                propType = "Array";
                            }
                        } catch(e) {
                            propType = "invalid";
                        }
                    }
                    lab += this._("inject.label."+propType);
                }
            }
            return lab;
        },
        label: function(customProps) {
            var suffix = "";
            // if fire once then add small indication
            if (this.once) {
                suffix = " ¹";
            }
            // but replace with repeat one if set to repeat
            if ((this.repeat && this.repeat != 0) || this.crontab || this.crontiMethod) {
                suffix = " ↻";
            }
            if (this.name) {
                return this.name+suffix;
            }
            var payload = "";
            var payloadType = "str";
            var topic = "";
            if (customProps) {
                for (var i=0;i<customProps.length;i++) {
                    if (customProps[i].p === "payload") {
                        payload = customProps[i].v;
                        payloadType = customProps[i].vt;
                    } else if (customProps[i].p === "topic") {
                        topic = customProps[i].v;
                    }
                }
            } else {
                payload = this.payload || "";
                payloadType = this.payloadType || "str";
                topic = this.topic || "";
            }
            if (payloadType === "string" ||
                    payloadType === "str" ||
                    payloadType === "num" ||
                    payloadType === "bool" ||
                    payloadType === "json") {
                if ((topic !== "") && ((topic.length + payload.length) <= 32)) {
                    return topic + ":" + payload+suffix;
                } else if (payload.length > 0 && payload.length < 24) {
                    return payload+suffix;
                } else {
                    return this._("inject.inject")+suffix;
                }
            } else if (payloadType === 'date' || payloadType === 'bin' || payloadType === 'env') {
                if ((topic !== "") && (topic.length <= 16)) {
                    return topic + ":" + this._('inject.label.'+payloadType)+suffix;
                } else {
                    return this._('inject.label.'+payloadType)+suffix;
                }
            } else if (payloadType === 'flow' || payloadType === 'global') {
                var key = RED.utils.parseContextKey(payload);
                return payloadType+"."+key.key+suffix;
            } else {
                return this._("inject.inject")+suffix;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;
            var payloadType = node.payloadType;

            if (node.payloadType == null) {
                if (node.payload == "") {
                    payloadType = "date";
                } else {
                    payloadType = "str";
                }
            } else if (node.payloadType === 'string' || node.payloadType === 'none') {
                payloadType = "str";
            }

            $("#inject-time-type-select").on("change", function() {
                $("#node-input-crontab").val('');
                $("#node-input-crontiMethod").val('');
                $("#node-input-crontiArgs").val('[]');
                var id = $("#inject-time-type-select").val();
                $(".inject-time-row").hide();
                $("#inject-time-row-"+id).show();

                // Scroll down
                var scrollDiv = $("#dialog-form").parent();
                scrollDiv.scrollTop(scrollDiv.prop('scrollHeight'));
                resizeDialog();
            });

            // Cronti Begin
            var year = new Date().getFullYear();
            var inputEl = $("#inject-time-cronti-on-week-date, #inject-time-cronti-on-interval-time-start-date, #inject-time-cronti-on-interval-time-end-date, #inject-time-cronti-on-date")
            inputEl.attr("min", year + "-01-01T00:00");
            inputEl.attr("max", year + "-12-31T23:59");
            var crontiMethod = $("#node-input-crontiMethod").val();
            var crontiArgs = JSON.parse($("#node-input-crontiArgs").val());
            if(crontiMethod && crontiArgs.length) {
                var crontiArgsInputId = {
                    "onWeek": ["inject-time-cronti-on-week-first-day-of-week", "inject-time-cronti-on-week-date"],
                    "onIntervalTime": ["inject-time-cronti-on-interval-time-start-date", "inject-time-cronti-on-interval-time-end-date", "inject-time-cronti-on-interval-time-count", "inject-time-cronti-on-interval-time-units"],
                    "onTime": ["inject-time-cronti-on-time-first-day-of-week", "inject-time-cronti-on-time-month", "inject-time-cronti-on-time-week", "inject-time-cronti-on-time-weekdays", "inject-time-cronti-on-time-time"],
                    "onCrontime": ["inject-time-cronti-on-crontime"],
                    "onDate": ["inject-time-cronti-on-date", "inject-time-cronti-on-date-isMonthOfDate"]
                };
                var checkboxInput = {
                    "inject-time-cronti-on-date-isMonthOfDate": "true"
                };
                (crontiArgsInputId[crontiMethod] || []).forEach(function(input, i) {
                    checkboxInput[input]
                        ? $("#"+input).prop("checked", crontiArgs[i])
                        : $("#" + input).val(crontiArgs[i].replace(/^-?[0-9]+((M)|(WD?)|(W?D)|(FD)|(d)|(h)|(m))$/g, function(text) { return text.replace(/(M)|(WD?)|(W?D)|(FD)|(d)|(h)|(m)/, "") }));
                });
            }
            // Cronti End

            $("#node-input-once").on("change", function() {
                $("#node-input-onceDelay").attr('disabled', !$("#node-input-once").prop('checked'));
            })

            $(".inject-time-times").each(function() {
                for (var i=0; i<24; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    $(this).append($("<option></option>").val(i).text(l));
                }
            });
            $("<option></option>").val(24).text("00:00").appendTo("#inject-time-interval-time-end");
            $("#inject-time-interval-time-start").on("change", function() {
                var start = Number($("#inject-time-interval-time-start").val());
                var end = Number($("#inject-time-interval-time-end").val());
                $("#inject-time-interval-time-end option").remove();
                for (var i=start+1; i<25; i++) {
                    var l = (i<10?"0":"")+i+":00";
                    if (i==24) {
                        l = "00:00";
                    }
                    var opt = $("<option></option>").val(i).text(l).appendTo("#inject-time-interval-time-end");
                    if (i === end) {
                        opt.attr("selected","selected");
                    }
                }
            });

            $(".inject-time-count").spinner({
                //max:60,
                min:1
            });

            var repeattype = "none";
            if (node.repeat != "" && node.repeat != 0) {
                repeattype = "interval";
                var r = "s";
                var c = node.repeat;
                if (node.repeat % 60 === 0) { r = "m"; c = c/60; }
                if (node.repeat % 1440 === 0) { r = "h"; c = c/60; }
                $("#inject-time-interval-count").val(c);
                $("#inject-time-interval-units").val(r);
                $("#inject-time-interval-days").prop("disabled","disabled");
            } else if (node.crontab && !node.crontiMethod) {
                var cronparts = node.crontab.split(" ");
                var days = cronparts[4];
                if (!isNaN(cronparts[0]) && !isNaN(cronparts[1])) {
                    repeattype = "time";
                    // Fixed time
                    var time = cronparts[1]+":"+cronparts[0];
                    $("#inject-time-time").val(time);
                    $("#inject-time-type-select").val("s");
                    if (days == "*") {
                        $("#inject-time-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                } else {
                    repeattype = "interval-time";
                    // interval - time period
                    var minutes = cronparts[0].slice(2);
                    if (minutes === "") { minutes = "0"; }
                    $("#inject-time-interval-time-units").val(minutes);
                    if (days == "*") {
                        $("#inject-time-interval-time-days input[type=checkbox]").prop("checked",true);
                    } else {
                        $("#inject-time-interval-time-days input[type=checkbox]").removeAttr("checked");
                        days.split(",").forEach(function(v) {
                            $("#inject-time-interval-time-days [value=" + v + "]").prop("checked", true);
                        });
                    }
                    var time = cronparts[1];
                    var timeparts = time.split(",");
                    var start;
                    var end;
                    if (timeparts.length == 1) {
                        // 0 or 0-10
                        var hours = timeparts[0].split("-");
                        if (hours.length == 1) {
                            if (hours[0] === "") {
                                start = "0";
                                end = "0";
                            }
                            else {
                                start = hours[0];
                                end = Number(hours[0])+1;
                            }
                        } else {
                            start = hours[0];
                            end = Number(hours[1])+1;
                        }
                    } else {
                        // 23,0 or 17-23,0-10 or 23,0-2 or 17-23,0
                        var startparts = timeparts[0].split("-");
                        start = startparts[0];

                        var endparts = timeparts[1].split("-");
                        if (endparts.length == 1) {
                            end = Number(endparts[0])+1;
                        } else {
                            end = Number(endparts[1])+1;
                        }
                    }
                    $("#inject-time-interval-time-end").val(end);
                    $("#inject-time-interval-time-start").val(start);

                }
            } else if (node.crontiMethod) {
                repeattype = "cronti-" + node.crontiMethod.replace(/[A-Z]/g, function(t) { return "-" + t.toLowerCase() })
            }

            $(".inject-time-row").hide();
            $("#inject-time-type-select").val(repeattype);
            $("#inject-time-row-"+repeattype).show();

            /* */

            var eList = $('#node-input-property-container').css('min-height','120px').css('min-width','450px');

            eList.editableList({
                buttons: [
                    {
                        id: "node-inject-test-inject-button",
                        label: node._("inject.injectNow"),
                        click: function(e) {
                            var items = eList.editableList('items');
                            var props = getProps(items);
                            var m = {__user_inject_props__: props.props};
                            doInject(node, m);
                        }
                    }
                ],
                addItem: function(container,i,opt) {
                    var prop = opt;
                    if (!prop.hasOwnProperty('p')) {
                        prop = {p:"",v:"",vt:"str"};
                    }
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);

                    var propertyName = $('<input/>',{class:"node-input-prop-property-name",type:"text"})
                        .css("width","30%")
                        .appendTo(row)
                        .typedInput({types:['msg']});

                    $('<div/>',{style: 'display:inline-block; padding:0px 6px;'})
                        .text('=')
                        .appendTo(row);

                    var propertyValue = $('<input/>',{class:"node-input-prop-property-value",type:"text"})
                        .css("width","calc(70% - 30px)")
                        .appendTo(row)
                        .typedInput({default:prop.vt || 'str',types:['flow','global','str','num','bool','json','bin','date','jsonata','env','msg']});

                    propertyName.typedInput('value',prop.p);
                    propertyValue.typedInput('value',prop.v);
                },
                removable: true,
                sortable: true
            });
            $('#node-inject-test-inject-button').css("float", "right").css("margin-right", "unset");

            if (RED.nodes.subflow(node.z)) {
                $('#node-inject-test-inject-button').attr("disabled",true);
            }

            if (!node.props) {
                var payload = {
                    p:'payload',
                    v: node.payload ? node.payload : '',
                    vt:payloadType ? payloadType : 'date'
                };
                var topic = {
                    p:'topic',
                    v: node.topic ? node.topic : '',
                    vt:'str'
                }
                node.props = [payload,topic];
            }

            for (var i=0; i<node.props.length; i++) {
                var prop = node.props[i];
                var newProp = { p: prop.p, v: prop.v, vt: prop.vt };
                if (newProp.v === undefined) {
                    if (prop.p === 'payload') {
                        newProp.v = node.payload ? node.payload : '';
                        newProp.vt = payloadType ? payloadType : 'date';
                    } else if (prop.p === 'topic' && prop.vt === "str") {
                        newProp.v =  node.topic ? node.topic : '';
                    }
                }
                if (newProp.vt === "string") {
                    // Fix bug in pre 2.1 where an old Inject node might have
                    // a migrated rule with type 'string' not 'str'
                    newProp.vt = "str";
                }
                eList.editableList('addItem',newProp);
            }

            $("#inject-time-type-select").trigger("change");
            $("#inject-time-interval-time-start").trigger("change");

        },
        oneditsave: function() {
            var repeat = "";
            var crontab = "";
            var crontiMethod = "";
            var crontiArgs = "";
            var type = $("#inject-time-type-select").val();
            var isCronti = type.includes("cronti")
            if (type == "none") {
                // nothing
            } else if (type == "interval") {
                var count = $("#inject-time-interval-count").val();
                var units = $("#inject-time-interval-units").val();
                if (units == "s") {
                    repeat = count;
                } else {
                    if (units == "m") {
                        //crontab = "*/"+count+" * * * "+days;
                        repeat = count * 60;
                    } else if (units == "h") {
                        //crontab = "0 */"+count+" * * "+days;
                        repeat = count * 60 * 60;
                    }
                }
            } else if (type == "interval-time") {
                repeat = "";
                var count = $("#inject-time-interval-time-units").val();
                var startTime = Number($("#inject-time-interval-time-start").val());
                var endTime = Number($("#inject-time-interval-time-end").val());
                var days = $('#inject-time-interval-time-days input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var timerange = "";
                    if (endTime == 0) {
                        timerange = startTime+"-23";
                    } else if (startTime+1 < endTime) {
                        timerange = startTime+"-"+(endTime-1);
                    } else if (startTime+1 == endTime) {
                        timerange = startTime;
                    } else {
                        var startpart = "";
                        var endpart = "";
                        if (startTime == 23) {
                            startpart = "23";
                        } else {
                            startpart = startTime+"-23";
                        }
                        if (endTime == 1) {
                            endpart = "0";
                        } else {
                            endpart = "0-"+(endTime-1);
                        }
                        timerange = startpart+","+endpart;
                    }
                    if (count === "0") {
                        crontab = count+" "+timerange+" * * "+days;
                    } else {
                        crontab = "*/"+count+" "+timerange+" * * "+days;
                    }
                }
            } else if (type == "time") {
                var time = $("#inject-time-time").val();
                var days = $('#inject-time-time-days  input[type=checkbox]:checked').map(function(_, el) {
                    return $(el).val()
                }).get();
                if (days.length == 0) {
                    crontab = "";
                } else {
                    if (days.length == 7) {
                        days="*";
                    } else {
                        days = days.join(",");
                    }
                    var parts = time.split(":");
                    if (parts.length === 2) {
                        repeat = "";
                        parts[1] = ("00" + (parseInt(parts[1]) % 60)).substr(-2);
                        parts[0] = ("00" + (parseInt(parts[0]) % 24)).substr(-2);
                        crontab = parts[1]+" "+parts[0]+" * * "+days;
                    }
                    else { crontab = ""; }
                }
            } else if (isCronti) {
                repeat = ""
                crontab = ""
            }

            $("#node-input-repeat").val(repeat);
            $("#node-input-crontab").val(crontab);

            /* Gather the properties */
            var items = $("#node-input-property-container").editableList('items');
            delete this.payloadType;
            delete this.payload;
            this.topic = "";
            var result = getProps(items, true);
            this.props = result.props;
            if(result.hasOwnProperty('payloadType')) { this.payloadType = result.payloadType; };
            if(result.hasOwnProperty('payload')) { this.payload = result.payload; };
            if(result.hasOwnProperty('topic')) { this.topic = result.topic; };

            // Cronti Begin
            if(isCronti) {
                var method = type.replace("cronti-", "").split("-").map((x, i) => i ? x[0].toUpperCase() + x.substr(1) : x).join("");
                var args = [];
                switch (method) {
                    case "onWeek":
                        args = [
                            $("#inject-time-cronti-on-week-first-day-of-week").val() + "FD",
                            $("#inject-time-cronti-on-week-date").val()
                        ];
                        break;
                    case "onIntervalTime":
                        args = [
                            $("#inject-time-cronti-on-interval-time-start-date").val(),
                            $("#inject-time-cronti-on-interval-time-end-date").val(),
                            $("#inject-time-cronti-on-interval-time-count").val() + $("#inject-time-cronti-on-interval-time-units").val(),
                            $("#inject-time-cronti-on-interval-time-units").val() // used in input set value
                        ];
                        break;
                    case "onTime":
                        args = [
                            $("#inject-time-cronti-on-time-first-day-of-week").val() + "FD",
                            $("#inject-time-cronti-on-time-month").val() + "M",
                            $("#inject-time-cronti-on-time-week").val() + "W",
                            $("#inject-time-cronti-on-time-weekdays").val() + "WD",
                            $("#inject-time-cronti-on-time-time").val()
                        ];
                        break;
                    case "onCrontime":
                        args = [
                            $("#inject-time-cronti-on-crontime").val()
                        ];
                        break;
                    case "onDate":
                        args = [
                            $("#inject-time-cronti-on-date").val(),
                            $("#inject-time-cronti-on-date-isMonthOfDate").prop("checked")
                        ];
                        break;
                }
                $("#node-input-crontiMethod").val(method);
                $("#node-input-crontiArgs").val(JSON.stringify(args));
            }
            // Cronti End

        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function () {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                doInject(this);
            }
        },
        oneditresize: resizeDialog
    });
})();
</script>
