/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
RED.sidebar = (function() {
    const sidebars = {
        primary: {
            id: 'primary',
            direction: 'right',
            menuToggle: 'menu-item-sidebar',
            minimumWidth: 180,
            maximumWidth: 800,
            defaultWidth: 300,
            defaultTopHeight: 0.7
        },
        secondary: {
            id: 'secondary',
            direction: 'left',
            menuToggle: 'menu-item-palette',
            minimumWidth: 180,
            maximumWidth: 800,
            // Make LH side slightly narrower by default as its the palette that doesn't require a lot of width
            defaultWidth: 210,
            defaultTopHeight: 1
        }
    }
    const defaultSidebarConfiguration = {
        primary: [ ['info','help','config','context'], ['debug'] ],
        secondary: [ ['explorer','palette'], [] ]
    }

    const knownTabs = {};

    function exportSidebarState () {
        const state = {
            primary: [[], []],
            secondary: [[], []]
        }
        function getTabButtons(tabBar) {
            const result = []
            tabBar.children('button').each(function() {
                const tabId = $(this).attr('data-tab-id');
                if (tabId) {
                    result.push(tabId);
                }
            })
            return result
        }
        state.primary[0] = getTabButtons(sidebars.primary.tabBars.top.container);
        state.primary[1] = getTabButtons(sidebars.primary.tabBars.bottom.container);
        state.secondary[0] = getTabButtons(sidebars.secondary.tabBars.top.container);
        state.secondary[1] = getTabButtons(sidebars.secondary.tabBars.bottom.container);

        RED.settings.set('editor.sidebar.state', state)
    }


    // We store the current sidebar tab id in localStorage as 'last-sidebar-tab'
    // This is restored when the editor is reloaded.
    // We use sidebars.primary.tabs.onchange to update localStorage. However that will
    // also get triggered when the first tab gets added to the tabs - typically
    // the 'info' tab. So we use the following variable to store the retrieved
    // value from localStorage before we start adding the actual tabs
    let lastSessionSelectedTabs = {}

    function addTab(title,content,closeable,visible) {
        var options;
        if (typeof title === "string") {
            // TODO: legacy support in case anyone uses this...
            options = {
                id: content.id,
                label: title,
                name: title,
                content: content,
                closeable: closeable,
                visible: visible
            }
        } else if (typeof title === "object") {
            options = title;
        }
        options.target = options.target || 'primary';
        let targetTabButtonIndex = -1 // Append to end by default

        // Check the saved sidebar state to see if this tab should be added to the primary or secondary sidebar
        let savedState = RED.settings.get('editor.sidebar.state', defaultSidebarConfiguration)
        if (true || typeof savedState.primary[0] === 'string' || typeof savedState.secondary[0] === 'string') {
            // This is a beta.0 format. Reset it for beta.1
            savedState = defaultSidebarConfiguration
            RED.settings.set('editor.sidebar.state', savedState)
        }
        let targetSidebar = null
        let targetSection = null
        if (savedState) {
            let sidebarState
            if (savedState.secondary[0].includes(options.id)) {
                options.target = 'secondary'
                sidebarState = savedState.secondary[0]
                targetSidebar = sidebars.secondary
                targetSection = 'top'
            } else if (savedState.secondary[1].includes(options.id)) {
                options.target = 'secondary'
                sidebarState = savedState.secondary[1]
                targetSidebar = sidebars.secondary
                targetSection = 'bottom'
            } else if (savedState.primary[0].includes(options.id)) {
                options.target = 'primary'
                sidebarState = savedState.primary[0]
                targetSidebar = sidebars.primary
                targetSection = 'top'
            } else if (savedState.primary[1].includes(options.id)) {
                options.target = 'primary'
                sidebarState = savedState.primary[1]
                targetSidebar = sidebars.primary
                targetSection = 'bottom'              
            }
            if (targetSidebar) {
                // This tab was found in the saved sidebar state. Now find the target position for the tab button
                targetTabButtonIndex = sidebarState.indexOf(options.id)
            }
        }


        targetSidebar = targetSidebar || (options.target === 'secondary' ? sidebars.secondary : sidebars.primary);
        targetSection = targetSection || 'top'
        options.targetSection = targetSection;

        delete options.closeable;

        options.wrapper = $('<div>',{style:"height:100%"}).appendTo(targetSidebar.sections[targetSection].content)
        options.wrapper.append(options.content);
        options.wrapper.hide();

        if (!options.enableOnEdit) {
            options.shade = $('<div>',{class:"red-ui-sidebar-shade hide"}).appendTo(options.wrapper);
        }

        if (options.toolbar) {
            targetSidebar.sections[targetSection].footer.append(options.toolbar);
            $(options.toolbar).hide();
        }
        var id = options.id;

        // console.log('menu', options.id, options.name)
        RED.menu.addItem("menu-item-view-menu",{
            id:"menu-item-view-menu-"+options.id,
            label:options.name,
            onselect:function() {
                showSidebar(options.id);
            },
            group: "sidebar-tabs"
        });

        options.iconClass = options.iconClass || "fa fa-square-o"

        knownTabs[options.id] = options;
        options.tabButton = $('<button></button>')
        // Insert the tab button at the correct index
        if (targetTabButtonIndex === -1) {
            // Append to end
            targetSidebar.tabBars[targetSection].addButton(options.tabButton)
        } else {
            // Insert before the item at targetTabButtonIndex
            targetSidebar.tabBars[targetSection].addButton(options.tabButton, targetTabButtonIndex)
        }
        options.tabButton.attr('data-tab-id', options.id)

        options.tabButtonTooltip = RED.popover.tooltip(options.tabButton, options.name, options.action);
        if (options.icon) {
            $('<i>',{class: 'red-ui-sidebar-tab-icon', style:"mask-image: url("+options.icon+"); -webkit-mask-image: url("+options.icon+");"}).appendTo(options.tabButton);
        } else if (options.iconClass) {
            $('<i>',{class:options.iconClass}).appendTo(options.tabButton);
        }
        options.tabButton.on('mouseup', function(evt) {
            if (draggingTabButton) {
                draggingTabButton = false
                return
            }
            const targetSidebar = options.target === 'secondary' ? sidebars.secondary : sidebars.primary;
            // 
            if (targetSidebar.tabBars[options.targetSection].active === options.id && RED.menu.isSelected(targetSidebar.menuToggle)) {
                RED.menu.setSelected(targetSidebar.menuToggle, false);
            } else {
                RED.sidebar.show(options.id)
            }
        })
        if (targetSidebar.sections[targetSection].content.children().length === 1) {
            RED.sidebar.show(options.id)
        }
        targetSidebar.resizeSidebarTabBar()
    }

    function removeTab(id) {
        if (knownTabs[id]) {
            const targetSidebar = knownTabs[id].target === 'secondary' ? sidebars.secondary : sidebars.primary;
            $(knownTabs[id].wrapper).remove();
            if (knownTabs[id].footer) {
                knownTabs[id].footer.remove();
            }
            targetSidebar.tabBar.find('button[data-tab-id="'+id+'"]').remove()
            RED.menu.removeItem("menu-item-view-menu-"+id);
            if (knownTabs[id].onremove) {
                knownTabs[id].onremove.call(knownTabs[id]);
            }
            delete knownTabs[id];
            const firstTab = targetSidebar.tabBar.find('button').first().attr('data-tab-id');
            if (firstTab) {
                RED.sidebar.show(firstTab);
            }
        }
    }

    function moveTab(id, srcSidebar, srcPosition, targetSidebar, targetPosition) {
        const options = knownTabs[id];
        options.target = targetSidebar.id;
        options.targetSection = targetPosition;

        $(options.wrapper).appendTo(targetSidebar.sections[targetPosition].content);
        if (options.toolbar) {
            targetSidebar.sections[targetPosition].footer.append(options.toolbar);
        }
        // Reset the tooltip so its left/right direction is recalculated
        options.tabButtonTooltip.delete()
        options.tabButtonTooltip = RED.popover.tooltip(options.tabButton, options.name, options.action);

        if (targetSidebar.sections[targetPosition].content.children().length === 1) {
            RED.sidebar.show(options.id)
        }
        if (srcSidebar.sections[srcPosition].content.children().length === 0 && srcPosition === 'bottom') {
            srcSidebar.hideSection(srcPosition)
        } else if (targetSidebar.sections[targetPosition].hidden) {
            targetSidebar.showSection(targetPosition)
        }
    }

    let draggingTabButton = false

    function setupSidebarTabs(sidebar) {
        const tabBar = $('<div class="red-ui-sidebar-tab-bar"></div>').addClass('red-ui-sidebar-' + sidebar.direction);
        if (sidebar.direction === 'right') {
            tabBar.insertAfter(sidebar.container);
        } else if (sidebar.direction === 'left') {
            tabBar.insertBefore(sidebar.container);
        }

        // TODO: make this an API object, not just a jQuery object
        sidebar.tabBars = {
            top: setupTabSection(sidebar, tabBar, 'top'),
            bottom: setupTabSection(sidebar, tabBar, 'bottom')
        }
        sidebar.tabBar = sidebar.tabBars.top.container;
        sidebar.resizeSidebarTabBar = function () {
            sidebar.tabBars.top.resizeSidebarTabBar();
            sidebar.tabBars.bottom.resizeSidebarTabBar();
        }
        sidebar.hideSection = function (position) {
            sidebar.sections.bottom.container.hide()
            sidebar.sections.bottom.hidden = true
            sidebar.sections.top.container.css('flex-grow', '1')
            sidebar.tabBars.top.container.css('flex-grow', '1')
            sidebar.tabBars.bottom.container.css('flex-grow', '0')
            sidebar.tabBars.bottom.container.css('height', '60px')
            
            sidebar.resizeSidebar()
        }
        sidebar.showSection = function (position) {
            sidebar.sections.bottom.container.show()
            sidebar.sections.bottom.hidden = false
            sidebar.sections.top.container.css('flex-grow', '0')
            sidebar.sections.top.container.css('height', '70%')
            sidebar.tabBars.top.container.css('flex-grow', '')
            sidebar.tabBars.bottom.container.css('flex-grow', '')
            sidebar.tabBars.bottom.container.css('height', '')

            sidebar.resizeSidebar()
        }
    }

    function setupTabSection(sidebar, tabBar, position) {
        const tabBarButtonsContainer = $('<div class="red-ui-sidebar-tab-bar-buttons"></div>').appendTo(tabBar);
        const tabOverflowButton = $('<button class="red-ui-sidebar-tab-bar-overflow-button"><i class="fa fa-ellipsis-h"></i></button>').appendTo(tabBarButtonsContainer);
        tabOverflowButton.hide()
        tabOverflowButton.on('click', function(evt) {
            try {
                const menuOptions = []
                tabBarButtonsContainer.find('button:not(.red-ui-sidebar-tab-bar-overflow-button)').each(function () {
                    if ($(this).is(':visible')) {
                        return
                    }
                    const tabId = $(this).attr('data-tab-id')
                    const tabOptions = knownTabs[tabId]
                    menuOptions.push({
                        label: tabOptions.name,
                        onselect: function() {
                            RED.sidebar.show(tabId)
                        }
                    })
                })
                if (menuOptions.length === 0) {
                    return
                }
                const menu = RED.menu.init({ options: menuOptions });
                menu.attr("id",sidebar.container.attr('id')+"-menu");
                menu.css({
                    position: "absolute"
                })
                menu.appendTo("body");
                var elementPos = tabOverflowButton.offset();
                menu.css({
                    top: (elementPos.top+tabOverflowButton.height()- menu.height() - 10)+"px",
                    left: (elementPos.left - menu.width() - 3)+"px"
                })
                $(".red-ui-menu.red-ui-menu-dropdown").hide();
                setTimeout(() => {
                    $(document).on("click.red-ui-sidebar-tabmenu", function(evt) {
                        $(document).off("click.red-ui-sidebar-tabmenu");
                        menu.remove();
                    });
                }, 0)
                menu.show();
            } catch (err) {
                console.log(err)
            }
        })
        tabBarButtonsContainer.data('sidebar', sidebar.id)
        tabBarButtonsContainer.data('sidebar-position', position)
        tabBarButtonsContainer.sortable({
            distance: 10,
            cancel: false,
            items: "button:not(.red-ui-sidebar-tab-bar-overflow-button)",
            placeholder: "red-ui-sidebar-tab-bar-button-placeholder",
            connectWith: ".red-ui-sidebar-tab-bar-buttons",
            start: function(event, ui) {
                const tabId = ui.item.attr('data-tab-id');
                const options = knownTabs[tabId];
                options.tabButtonTooltip.delete()
                draggingTabButton = true
                tabBar.css('z-index','inherit')
                $(".red-ui-sidebar-tab-bar").addClass("red-ui-sidebar-dragging-tab");
            },
            stop: function(event, ui) {
                // Restore the tooltip
                const tabId = ui.item.attr('data-tab-id');
                const options = knownTabs[tabId];
                options.tabButtonTooltip.delete()
                options.tabButtonTooltip = RED.popover.tooltip(options.tabButton, options.name, options.action);
                // Save the sidebar state
                exportSidebarState()
                tabBar.css('z-index','')
                $(".red-ui-sidebar-tab-bar").removeClass("red-ui-sidebar-dragging-tab");
            },
            receive: function(event, ui) {
                // Tab has been moved from one sidebar to another
                const src = sidebars[ui.sender.data('sidebar')]
                const dest = sidebars[$(this).data('sidebar')]
                const srcPosition = ui.sender.data('sidebar-position')
                const destPosition = $(this).data('sidebar-position')
                const tabId = ui.item.attr('data-tab-id');
                moveTab(tabId, src, srcPosition, dest, destPosition);
                if (ui.item.hasClass('selected')) {
                    const firstTab = src.tabBars[srcPosition].container.find('button').first().attr('data-tab-id');
                    if (firstTab) {
                        RED.sidebar.show(firstTab);
                    }
                }
                src.resizeSidebarTabBar();
                dest.resizeSidebarTabBar();

                RED.sidebar.show(tabId)
            }
        })

        let hasHidden = false
        const resizeSidebarTabBar  = function () {
            let tabBarButtonsBottom = tabBarButtonsContainer.position().top + tabBarButtonsContainer.outerHeight();
            const buttonHeight = tabOverflowButton.outerHeight()
            // Find the last visible button
            let bottomButton = tabBarButtonsContainer.children(":visible").last()
            if (bottomButton.length === 0) {
                // Nothing visible - bail out
                return
            }
            if (tabBarButtonsBottom < bottomButton.position().top + buttonHeight * 1.5) {
                tabOverflowButton.show()
                let tabOverflowButtonBottom = tabOverflowButton.position().top + buttonHeight * 1.5;
                while (tabBarButtonsBottom < tabOverflowButtonBottom) {
                    const lastVisible = tabBarButtonsContainer.children(':not(".red-ui-sidebar-tab-bar-overflow-button"):visible').last()
                    if (lastVisible.length === 0) {
                        // Nothing left to hide
                        break
                    }
                    lastVisible.hide()
                    tabOverflowButtonBottom = tabOverflowButton.position().top + buttonHeight * 1.5;
                }
            } else {
                const hiddenChildren = tabBarButtonsContainer.children(':not(".red-ui-sidebar-tab-bar-overflow-button"):hidden')
                if (hiddenChildren.length > 0) {
                    // We may be able to show some more buttons
                    let tabOverflowButtonBottom = tabOverflowButton.position().top + buttonHeight * 2;
                    let shownCount = 0
                    while (tabBarButtonsBottom > tabOverflowButtonBottom + buttonHeight) {
                        const firstHidden = tabBarButtonsContainer.children(':not(".red-ui-sidebar-tab-bar-overflow-button"):hidden').first()
                        if (firstHidden.length === 0) {
                            // Nothing left to show
                            break
                        }
                        firstHidden.show()
                        shownCount++
                        tabOverflowButtonBottom = tabOverflowButton.position().top + buttonHeight * 2;
                    }
                    if (hiddenChildren.length - shownCount <= 0) {
                        // We were able to show all of the hidden buttons
                        // so hide the overflow button again
                        tabOverflowButton.hide()
                    }
                }
            }
        }
        return {
            container: tabBarButtonsContainer,
            addButton: function(button, position) {
                if (position === undefined || position >= tabBarButtonsContainer.children().length) {
                    button.insertBefore(tabOverflowButton);
                } else {
                    button.insertBefore(tabBarButtonsContainer.children().eq(position));
                }
            },
            clearSelected: function() {
                tabBarButtonsContainer.children('button').removeClass('selected')
            },
            resizeSidebarTabBar
        }
    }
    function setupSidebarSeparator(sidebar) {
        const separator = $('<div class="red-ui-sidebar-separator"></div>');
        separator.attr('id', sidebar.container.attr('id') + '-separator')
        $('<div class="red-ui-sidebar-shade hide"></div>').appendTo(separator);
        $('<div class="red-ui-sidebar-separator-handle"></div>').appendTo(separator);
        let scaleFactor = 1;
        if (sidebar.direction === 'right') {
            separator.insertBefore(sidebar.container);
        } else if (sidebar.direction === 'left') {
            scaleFactor = -1;
            separator.insertAfter(sidebar.container);
        }
        // Track sidebar state whilst dragging
        const sidebarSeparator = {}
        separator.draggable({
            axis: "x",
            start:function(event,ui) {
                sidebarSeparator.closing = false;
                sidebarSeparator.opening = false;
                // var winWidth = $("#red-ui-editor").width();
                sidebarSeparator.start = ui.position.left;
                sidebarSeparator.width = sidebar.container.width();
                sidebarSeparator.chartWidth = $("#red-ui-workspace").width();
                sidebarSeparator.dragging = true;

                if (!RED.menu.isSelected(sidebar.menuToggle)) {
                    sidebarSeparator.opening = true;
                    sidebar.container.width(0);
                    RED.menu.setSelected(sidebar.menuToggle,true);
                    RED.events.emit("sidebar:resize");
                }
                sidebarSeparator.width = sidebar.container.width();
            },
            drag: function(event,ui) {
                var d = scaleFactor * (ui.position.left-sidebarSeparator.start);

                var newSidebarWidth = sidebarSeparator.width - d;
                if (newSidebarWidth > sidebar.maximumWidth) {
                    newSidebarWidth = sidebar.maximumWidth;
                    d = sidebarSeparator.width - sidebar.maximumWidth;
                    ui.position.left = sidebarSeparator.start + scaleFactor * d;
                }
                
                if (newSidebarWidth > sidebar.minimumWidth) {
                    if (sidebarSeparator.chartWidth + d < 200) {
                        // Chart is now too small, but we have room to resize the sidebar
                        d += (200 - (sidebarSeparator.chartWidth + d));
                        newSidebarWidth = sidebarSeparator.width - d;
                        ui.position.left = sidebarSeparator.start + scaleFactor * d;
                    }
                } else if (newSidebarWidth < sidebar.minimumWidth) {
                    if (newSidebarWidth > 100) {
                        newSidebarWidth = sidebar.minimumWidth
                        sidebarSeparator.closing = false
                    } else {
                        newSidebarWidth = 0
                        sidebarSeparator.closing = true
                    }
                } else {
                    sidebarSeparator.closing = false
                }
                sidebar.container.width(newSidebarWidth);
                ui.position.left -= scaleFactor * d

                // sidebar.tabs.resize();
                RED.events.emit("sidebar:resize");
            },
            stop:function(event,ui) {
                sidebarSeparator.dragging = false;
                if (sidebarSeparator.closing) {
                    sidebar.container.removeClass("closing");
                    if (sidebar.menuToggle) {
                        RED.menu.setSelected(sidebar.menuToggle,false);
                    }
                    sidebar.container.hide()
                    sidebar.separator.hide()
                    if (sidebar.container.width() < sidebar.minimumWidth) {
                        sidebar.container.width(sidebar.defaultWidth);
                    }
                }
                RED.events.emit("sidebar:resize");
            }
        });
        return separator
    }

    function toggleSidebar(sidebar, state) {
        if (!state) {
            sidebar.container.hide()
            sidebar.separator.hide()
            sidebar.tabBars.top.clearSelected()
            sidebar.tabBars.bottom.clearSelected()
        } else {
            sidebar.container.show()
            sidebar.separator.show()
            if (sidebar.tabBars.top.active) {
                sidebar.tabBars.top.container.find('button[data-tab-id="'+sidebar.tabBars.top.active+'"]').addClass('selected')
            }
            if (sidebar.tabBars.bottom.active) {
                sidebar.tabBars.bottom.container.find('button[data-tab-id="'+sidebar.tabBars.bottom.active+'"]').addClass('selected')
            }
        }
        RED.events.emit("sidebar:resize");
    }

    function showSidebar(id, skipShowSidebar) {
        if (id === ":first") {
            // Show the last selected tab for each sidebar
            Object.keys(sidebars).forEach(function(sidebarKey) {
                const sidebar = sidebars[sidebarKey];
                let lastTabId = lastSessionSelectedTabs[sidebarKey];
                if (!lastTabId) {
                    lastTabId = sidebar.tabBars.top.container.children('button').first().attr('data-tab-id');
                }
                showSidebar(lastTabId, true)
            })
            return
        }
        if (id) {
            const tabOptions = knownTabs[id];
            if (tabOptions) {
                const targetSidebar = tabOptions.target === 'secondary' ? sidebars.secondary : sidebars.primary;
                const targetSection = tabOptions.targetSection || 'top'
                targetSidebar.sections[targetSection].content.children().hide();
                targetSidebar.sections[targetSection].footer.children().hide();
                if (tabOptions.onchange) {
                    tabOptions.onchange.call(tabOptions);
                }
                $(tabOptions.wrapper).show();
                if (tabOptions.toolbar) {
                    $(tabOptions.toolbar).show();
                }
                RED.settings.setLocal("last-sidebar-tab-" + targetSidebar.id, tabOptions.id)
                // TODO: find which tabBar the button is in
                targetSidebar.tabBars[targetSection].clearSelected()
                targetSidebar.tabBars[targetSection].container.find('button[data-tab-id="'+id+'"]').addClass('selected')
                targetSidebar.tabBars[targetSection].active = id

                if (!skipShowSidebar && !RED.menu.isSelected(targetSidebar.menuToggle)) {
                    RED.menu.setSelected(targetSidebar.menuToggle,true);
                }
            }
        }
    }

    function containsTab(id) {
        return sidebars.primary.tabs.contains(id);
    }

    function setupSidebar(sidebar) {
        // Get the appropriate height for the sidebar - as the sidebar will be hidden at this point in time, we need to use
        // the main-container height as a decent proxy
        const sidebarHeight = $("#red-ui-main-container").height();
        sidebar.container.addClass("red-ui-sidebar").addClass('red-ui-sidebar-' + sidebar.direction);
        sidebar.container.width(sidebar.defaultWidth);
        if (sidebar.direction === 'right') {
            $('<div>',{class:"red-ui-sidebar-shade hide"}).css("z-index", 0).appendTo(sidebar.container);
        }
        sidebar.sections = {};
        sidebar.sections.top = {}
        sidebar.sections.top.container = $('<div class="red-ui-sidebar-section red-ui-sidebar-section-top"></div>').appendTo(sidebar.container);
        sidebar.sections.top.content = $('<div class="red-ui-sidebar-content"></div>').appendTo(sidebar.sections.top.container);
        sidebar.sections.top.footer =  $('<div class="red-ui-sidebar-footer"></div>').appendTo(sidebar.sections.top.container);
        sidebar.sectionsSeparator = $('<div class="red-ui-sidebar-tab-bar-separator"><div class="red-ui-sidebar-separator-handle"></div></div>').appendTo(sidebar.container);
        sidebar.sections.bottom = {}
        sidebar.sections.bottom.container = $('<div class="red-ui-sidebar-section red-ui-sidebar-section-bottom"></div>').appendTo(sidebar.container);
        sidebar.sections.bottom.content = $('<div class="red-ui-sidebar-content"></div>').appendTo(sidebar.sections.bottom.container);
        sidebar.sections.bottom.footer =  $('<div class="red-ui-sidebar-footer"></div>').appendTo(sidebar.sections.bottom.container);

        let startPosition
        let startTopSectionHeight
        let startTopTabSectionHeight
        let startSidebarHeight
        sidebar.sectionsSeparator.draggable({
            axis: "y",
            containment: sidebar.container,
            scroll: false,
            start:function(event,ui) {
                startPosition = ui.position.top
                startTopSectionHeight = sidebar.sections.top.container.outerHeight()
                startTopTabSectionHeight = sidebar.tabBars.top.container.outerHeight()
                startSidebarHeight = sidebar.container.height()
            },
            drag: function(event,ui) {
                const delta = ui.position.top - startPosition
                const newTopHeight = startTopSectionHeight + delta
                const newBottomHeight = startSidebarHeight - newTopHeight
                if (newTopHeight < 100 || newBottomHeight < 100) {
                    ui.position.top += delta
                    return
                }
                sidebar.sections.top.container.outerHeight(startTopSectionHeight + delta)
                sidebar.tabBars.top.container.outerHeight(startTopTabSectionHeight + delta)
                ui.position.top -= delta
                sidebar.resizeSidebar()
            },
            stop:function(event,ui) {
            }
        });

        // sidebar.shade = $('<div class="red-ui-sidebar-shade hide"></div>').appendTo(sidebar.container);
        
        sidebar.separator = setupSidebarSeparator(sidebar);
        setupSidebarTabs(sidebar)
        sidebar.resizeSidebar = function () {
            // Resize sidebar sections as needed
            const topSectionHeight = sidebar.sections.top.container.outerHeight()
            if (!sidebar.sections.bottom.hidden) {
                const bottomSectionHeight = sidebar.sections.bottom.container.outerHeight()

                // Shrink the top section if the bottom section is too small
                if (bottomSectionHeight < 90 && topSectionHeight > 90) {
                    sidebar.sections.top.container.outerHeight(topSectionHeight - (90 - bottomSectionHeight));
                }
                sidebar.tabBars.top.container.height(sidebar.sections.top.container.outerHeight())
            // } else {
            //     sidebar.tabBars.top.container.height(sidebar.sections.top.container.outerHeight() - 60)
            }
            // Trigger a resize of the tab bars to handle overflow
            sidebar.resizeSidebarTabBar()
            RED.events.emit("sidebar:resize");

        }
        $(window).on("resize", sidebar.resizeSidebar)
        if (sidebar.defaultTopHeight > 0) {
            if (sidebar.defaultTopHeight === 1) {
                sidebar.hideSection('bottom')
            } else {
                sidebar.sections.top.container.outerHeight(sidebarHeight * sidebar.defaultTopHeight);
            }
        }
        sidebar.resizeSidebar()

    }
    function init () {
        sidebars.primary.container = $("#red-ui-sidebar");
        setupSidebar(sidebars.primary)
        sidebars.secondary.container = $("#red-ui-sidebar-left");
        setupSidebar(sidebars.secondary)

        RED.actions.add("core:toggle-sidebar",function(state){
            if (state === undefined) {
                RED.menu.toggleSelected(sidebars.primary.menuToggle);
            } else {
                toggleSidebar(sidebars.primary, state);
            }
        });
        RED.actions.add("core:toggle-palette", function(state) {
            if (state === undefined) {
                RED.menu.toggleSelected(sidebars.secondary.menuToggle);
            } else {
                toggleSidebar(sidebars.secondary, state);
            }
        });

        // Remember the last selected tab for each sidebar before
        // the tabs are readded causing the state to get updated
        Object.keys(sidebars).forEach(function(sidebarKey) {
            lastSessionSelectedTabs[sidebarKey] = RED.settings.getLocal("last-sidebar-tab-" + sidebarKey)
        })
    }

    return {
        init: init,
        addTab: addTab,
        removeTab: removeTab,
        show: showSidebar,
        containsTab: containsTab,
        toggleSidebar: toggleSidebar,
    }

})();
