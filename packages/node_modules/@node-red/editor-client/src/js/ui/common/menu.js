/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
RED.menu = (function() {

    var currentPortaledSubmenu = null;
    var menuItems = {};
    let menuItemCount = 0

    /**
     * Position a submenu relative to its parent item, handling viewport collisions.
     * @param {HTMLElement} parentMenuEl - The parent menu item
     * @param {HTMLElement} submenuEl - The submenu to position
     * @param {string} preferredSide - 'left' or 'right'
     * @returns {{x: number, y: number, placement: string}}
     */
    function getSubmenuPosition(parentMenuEl, submenuEl, preferredSide) {
        var parentMenuRect = parentMenuEl.getBoundingClientRect();
        var submenuWidth = submenuEl.offsetWidth || 230;
        var submenuHeight = submenuEl.offsetHeight || 200;
        var viewportWidth = window.innerWidth;
        var viewportHeight = window.innerHeight;
        var padding = 10; 

        // Initial position variables
        var x;
        var y = parentMenuRect.top;

        // Shift y if it would overflow bottom of viewport
        if (y + submenuHeight > viewportHeight - padding) {
            y = viewportHeight - submenuHeight - padding;
        }

        // Shift y if it would overflow top of viewport
        if (y < padding) {
            y = padding;
        }

        // Calculate x position based on preferred side
        if (preferredSide === 'left') {
            x = parentMenuRect.left - submenuWidth;
            // Flip to right if not enough space on left
            if (x < padding) {
                x = parentMenuRect.right;
                // If still not enough space, shift to fit
                if (x + submenuWidth > viewportWidth - padding) {
                    x = viewportWidth - submenuWidth - padding;
                }
            }
        } else {
            x = parentMenuRect.right;
            // Flip to left if not enough space on right
            if (x + submenuWidth > viewportWidth - padding) {
                x = parentMenuRect.left - submenuWidth;
                // If still not enough space, shift to fit
                if (x < padding) {
                    x = padding;
                }
            }
        }

        return { x: x, y: y };
    }

    /**
     * Clean up the currently portaled submenu (return it to original position)
     */
    function cleanupPortaledSubmenus() {
        if (currentPortaledSubmenu && currentPortaledSubmenu.isPortaled) {
            currentPortaledSubmenu.cleanUpSubmenu();
        }
        currentPortaledSubmenu = null;
    }

    function createMenuItem(opt) {
        var item;

        if (opt !== null && opt.id) {
            var themeSetting = RED.settings.theme("menu."+opt.id);
            if (themeSetting === false) {
                return null;
            }
        }

        function setInitialState() {
            var savedStateActive = RED.settings.get("menu-" + opt.id);
            if (opt.setting) {
                // May need to migrate pre-0.17 setting

                if (savedStateActive !== null) {
                    RED.settings.set(opt.setting,savedStateActive);
                    RED.settings.remove("menu-" + opt.id);
                } else {
                    savedStateActive = RED.settings.get(opt.setting);
                }
            }
            if (savedStateActive) {
                link.addClass("active");
                triggerAction(opt.id,true);
            } else if (savedStateActive === false) {
                link.removeClass("active");
                triggerAction(opt.id,false);
            } else if (opt.hasOwnProperty("selected")) {
                if (opt.selected) {
                    link.addClass("active");
                } else {
                    link.removeClass("active");
                }
                triggerAction(opt.id,opt.selected);
            }
        }

        if (opt === null) {
            item = $('<li class="red-ui-menu-divider"></li>');
        } else {
            item = $('<li></li>');
            if (!opt.id) {
                opt.id = 'red-ui-menu-item-'+(menuItemCount++)
            }
            if (opt.group) {
                item.addClass("red-ui-menu-group-"+opt.group);
            }
            var linkContent = '<a '+(opt.id?'id="'+opt.id+'" ':'')+'tabindex="-1" href="#">';
            if (opt.toggle) {
                linkContent += '<i class="fa fa-square'+(opt.direction!=='right'?" pull-left":"")+'"></i>';
                linkContent += '<i class="fa fa-check-square'+(opt.direction!=='right'?" pull-left":"")+'"></i>';

            }
            if (opt.icon !== undefined) {
                if (/\.(png|svg)/.test(opt.icon)) {
                    linkContent += '<img src="'+opt.icon+'"/> ';
                } else {
                    linkContent += '<i class="'+(opt.icon?opt.icon:'" style="display: inline-block;"')+'"></i> ';
                }
            }
            let label = opt.label
            if (!opt.label && typeof opt.onselect === 'string') {
                label = RED.actions.getLabel(opt.onselect)
            }
            if (opt.sublabel) {
                linkContent += '<span class="red-ui-menu-label-container"><span class="red-ui-menu-label">'+label+'</span>'+
                               '<span class="red-ui-menu-sublabel">'+opt.sublabel+'</span></span>'
            } else {
                linkContent += '<span class="red-ui-menu-label"><span>'+label+'</span></span>'
            }

            linkContent += '</a>';

            var link = $(linkContent).appendTo(item);
            opt.link = link;
            if (typeof opt.onselect === 'string' || opt.shortcut) {
                var shortcut = opt.shortcut || RED.keyboard.getShortcut(opt.onselect);
                if (shortcut && shortcut.key) {
                    opt.shortcutSpan = $('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(shortcut.key, true)+'</span>').appendTo(link.find(".red-ui-menu-label"));
                }
            }

            menuItems[opt.id] = opt;

            if (opt.onselect) {
                link.on("click", function(e) {
                    e.preventDefault();
                    if ($(this).parent().hasClass("disabled")) {
                        return;
                    }
                    if (opt.toggle) {
                        if (opt.toggle === true) {
                            setSelected(opt.id, !isSelected(opt.id));
                        } else {
                            setSelected(opt.id, true);
                        }
                    } else {
                        triggerAction(opt.id);
                    }
                });
                if (opt.toggle) {
                    setInitialState();
                }
            } else if (opt.href) {
                link.attr("target","_blank").attr("href",opt.href);
            } else if (!opt.options) {
                item.addClass("disabled");
                link.on("click", function(event) {
                    event.preventDefault();
                });
            }
            if (opt.options) {
                item.addClass("red-ui-menu-dropdown-submenu"+(opt.direction!=='right'?" pull-left":""));
                var submenuClasses = "red-ui-menu-dropdown" + (opt.isHeaderMenu ? " red-ui-header-menu" : "");
                var submenu = $('<ul id="'+opt.id+'-submenu" class="'+submenuClasses+'"></ul>').appendTo(item);
                var hasIcons = false
                var hasSubmenus = false

                for (var i=0;i<opt.options.length;i++) {

                    if (opt.options[i]) {
                        if (opt.onpreselect && opt.options[i].onpreselect === undefined) {
                            opt.options[i].onpreselect = opt.onpreselect
                        }
                        if (opt.onpostselect && opt.options[i].onpostselect === undefined) {
                            opt.options[i].onpostselect = opt.onpostselect
                        }
                        opt.options[i].direction = opt.direction
                        opt.options[i].isHeaderMenu = opt.isHeaderMenu
                        hasIcons = hasIcons || (opt.options[i].icon);
                        hasSubmenus = hasSubmenus || (opt.options[i].options);
                    }

                    var li = createMenuItem(opt.options[i]);
                    if (li) {
                        li.appendTo(submenu);
                    }
                }
                if (!hasIcons) {
                    submenu.addClass("red-ui-menu-dropdown-noicons")
                }
                if (hasSubmenus) {
                    submenu.addClass("red-ui-menu-dropdown-submenus")
                }

                // Setup submenu portaling for scrollable parent menus
                (function(item, submenu, direction) {
                    var isPortaled = false;
                    var originalParentItem = item;

                    function doesSubmenuNeedPortaling() {
                        var parentMenu = item.closest(".red-ui-menu-dropdown");
                        var overflowY = parentMenu.css("overflow-y");
                        // If scroll, portal it
                        if (overflowY === "auto" || overflowY === "scroll") {
                            return true;
                        }
                        
                        var itemRect = item[0].getBoundingClientRect();
                        var submenuWidth = submenu.outerWidth() || 230;
                        var viewportWidth = window.innerWidth;
                        var padding = 10;

                        // If right overflow, portal it 
                        if (itemRect.right + submenuWidth > viewportWidth - padding) {
                            return true;
                        }
                        return false;
                    }

                    function portalSubmenu() {
                        if (!doesSubmenuNeedPortaling()) {
                            return;
                        }
                        if (isPortaled) {
                            updatePositionOfSubmenu();
                            return;
                        }

                        isPortaled = true; 
                        submenu.appendTo('body');
                        submenu.addClass('red-ui-menu-dropdown-portaled');
                        updatePositionOfSubmenu();
                    }

                    function updatePositionOfSubmenu() {
                        if (!isPortaled) {
                            return;
                        }
                        var {x, y} = getSubmenuPosition(item[0], submenu[0], direction);
                        submenu.css({
                            'top': y + 'px',
                            'left': x + 'px'
                        });
                    }

                    function cleanUpSubmenu() {
                        if (!isPortaled) {
                            return;
                        }
                        isPortaled = false;
                        submenu.removeClass('red-ui-menu-dropdown-portaled');
                        submenu.appendTo(originalParentItem);

                        if (currentPortaledSubmenu && currentPortaledSubmenu.submenu === submenu) {
                            currentPortaledSubmenu = null;
                        }
                    }

                    var submenuInfo = {
                        submenu,
                        cleanUpSubmenu
                    };

                    Object.defineProperty(submenuInfo, 'isPortaled', {
                        get: function() { return isPortaled; }
                    });

                    item.on("mouseenter", function() {
                        if (currentPortaledSubmenu && currentPortaledSubmenu.isPortaled && currentPortaledSubmenu.submenu !== submenu) {
                            currentPortaledSubmenu.cleanUpSubmenu();
                        }

                        portalSubmenu();
                  
                        if (isPortaled) {
                            currentPortaledSubmenu = submenuInfo;
                        }
                    });

                    item.on("mouseleave", function(e) {
                        if (!isPortaled) {
                            return;
                        }
                        // Check if mouse moved to the submenu
                        var related = e.relatedTarget;
                        if (related && (submenu[0].contains(related) || submenu[0] === related)) {
                            return;
                        }
                        cleanUpSubmenu();
                    });

                    submenu.on("mouseleave", function(e) {
                        if (!isPortaled) {
                            return;
                        }
                        // Check if mouse moved back to parent item
                        var related = e.relatedTarget;
                        if (related && (item[0].contains(related) || item[0] === related)) {
                            return;
                        }
                        cleanUpSubmenu();
                    });

                })(item, submenu, opt.direction);

            }
            if (opt.disabled) {
                item.addClass("disabled");
            }
            if (opt.visible === false) {
                item.addClass("hide");
            }
        }


        return item;

    }
    function createMenu(options) {
        // Check if menu is in header - we need to add a styling class since portaling to the body loses css context
        var isHeaderMenu = false;
        if (options.id) {
            var menuParent = $("#"+options.id);
            if (menuParent.length === 1 && menuParent.closest('#red-ui-header').length > 0) {
                isHeaderMenu = true;
            }
        }

        var menuClasses = "red-ui-menu red-ui-menu-dropdown pull-right" + (isHeaderMenu ? " red-ui-header-menu" : "");
        var topMenu = $("<ul/>",{class: menuClasses});
        if (options.direction) {
            topMenu.addClass("red-ui-menu-dropdown-direction-"+options.direction)
        }
        options.isHeaderMenu = isHeaderMenu;

        if (options.id) {
            topMenu.attr({id:options.id+"-submenu"});
            var menuParent = $("#"+options.id);
            if (menuParent.length === 1) {
                topMenu.insertAfter(menuParent);
                menuParent.on("click", function(evt) {
                    evt.stopPropagation();
                    evt.preventDefault();
                    if (topMenu.is(":visible")) {
                        $(document).off("click.red-ui-menu");
                        cleanupPortaledSubmenus();
                        topMenu.hide();
                        topMenu.css({ maxHeight: "", overflowY: "" });
                    } else {
                        $(document).on("click.red-ui-menu", function(evt) {
                            $(document).off("click.red-ui-menu");
                            activeMenu = null;
                            cleanupPortaledSubmenus();
                            topMenu.hide();
                            topMenu.css({ maxHeight: "", overflowY: "" });
                        });
                        $(".red-ui-menu.red-ui-menu-dropdown").hide();
                        topMenu.show();

                        // Enable scrolling if menu exceeds viewport
                        var menuOffset = topMenu.offset();
                        var menuHeight = topMenu.outerHeight();
                        var windowHeight = $(window).height();
                        var spaceBelow = windowHeight - menuOffset.top;
                        if (menuHeight > spaceBelow - 10) {
                            topMenu.css({
                                maxHeight: (spaceBelow - 10) + "px",
                                overflowY: "auto"
                            });
                        }
                    }
                })
            }
        }

        var lastAddedSeparator = false;
        var hasSubmenus = false;
        var hasIcons = false;
        for (var i=0;i<options.options.length;i++) {
            var opt = options.options[i];
            if (opt) {
                if (options.onpreselect && opt.onpreselect === undefined) {
                    opt.onpreselect = options.onpreselect
                }
                if (options.onpostselect && opt.onpostselect === undefined) {
                    opt.onpostselect = options.onpostselect
                }
                opt.direction = options.direction || 'left'
                opt.isHeaderMenu = options.isHeaderMenu
            }
            if (opt !== null || !lastAddedSeparator) {
                hasIcons = hasIcons || (opt && opt.icon);
                hasSubmenus = hasSubmenus || (opt && opt.options);
                var li = createMenuItem(opt);
                if (li) {
                    li.appendTo(topMenu);
                    lastAddedSeparator = (opt === null);
                }
            }
        }
        if (!hasIcons) {
            topMenu.addClass("red-ui-menu-dropdown-noicons")
        }
        if (hasSubmenus) {
            topMenu.addClass("red-ui-menu-dropdown-submenus")
        }
        return topMenu;
    }

    function triggerAction(id, args) {
        var opt = menuItems[id];
        var callback = opt.onselect;
        if (opt.onpreselect) {
            opt.onpreselect.call(opt,args)
        }
        if (typeof opt.onselect === 'string') {
            callback = RED.actions.get(opt.onselect);
        }
        if (callback) {
            callback.call(opt,args);
        } else {
            console.log("No callback for",id,opt.onselect);
        }
        if (opt.onpostselect) {
            opt.onpostselect.call(opt,args)
        }
    }

    function isSelected(id) {
        return $("#" + id).hasClass("active");
    }

    function setSelected(id,state) {
        var alreadySet = false;
        if (isSelected(id) == state) {
            alreadySet = true;
        }
        var opt = menuItems[id];
        if (state) {
            $("#"+id).addClass("active");
        } else {
            $("#"+id).removeClass("active");
        }
        if (opt) {
            if (opt.toggle && typeof opt.toggle === "string") {
                if (state) {
                    for (var m in menuItems) {
                        if (menuItems.hasOwnProperty(m)) {
                            var mi = menuItems[m];
                            if (mi.id != opt.id && opt.toggle == mi.toggle) {
                                setSelected(mi.id,false);
                            }
                        }
                    }
                }
            }
            if (!alreadySet && opt.onselect) {
                triggerAction(opt.id,state);
            }
            if (!opt.local && !alreadySet) {
                RED.settings.set(opt.setting||("menu-"+opt.id), state);
            }
        }
    }

    function toggleSelected(id) {
        setSelected(id,!isSelected(id));
    }

    function setDisabled(id,state) {
        if (state) {
            $("#"+id).parent().addClass("disabled");
        } else {
            $("#"+id).parent().removeClass("disabled");
        }
    }

    function setVisible(id,state) {
        if (!state) {
            $("#"+id).parent().addClass("hide");
        } else {
            $("#"+id).parent().removeClass("hide");
        }
    }

    function addItem(id,opt) {
        var item = createMenuItem(opt);
        if (opt !== null && opt.group) {
            var groupItems = $("#"+id+"-submenu").children(".red-ui-menu-group-"+opt.group);
            if (groupItems.length === 0) {
                item.appendTo("#"+id+"-submenu");
            } else {
                for (var i=0;i<groupItems.length;i++) {
                    var groupItem = groupItems[i];
                    var label = $(groupItem).find(".red-ui-menu-label").html();
                    if (opt.label < label) {
                        $(groupItem).before(item);
                        break;
                    }
                }
                if (i === groupItems.length) {
                    item.appendTo("#"+id+"-submenu");
                }
            }
        } else {
            item.appendTo("#"+id+"-submenu");
        }
    }
    function removeItem(id) {
        $("#"+id).parent().remove();
    }

    function setAction(id,action) {
        var opt = menuItems[id];
        if (opt) {
            opt.onselect = action;
        }
    }

    function refreshShortcuts() {
        for (var id in menuItems) {
            if (menuItems.hasOwnProperty(id)) {
                var opt = menuItems[id];
                if (typeof opt.onselect === "string" && opt.shortcutSpan) {
                    opt.shortcutSpan.remove();
                    delete opt.shortcutSpan;
                    var shortcut = RED.keyboard.getShortcut(opt.onselect);
                    if (shortcut && shortcut.key) {
                        opt.shortcutSpan = $('<span class="red-ui-popover-key">'+RED.keyboard.formatKey(shortcut.key, true)+'</span>').appendTo(opt.link.find(".red-ui-menu-label"));
                    }
                }
            }
        }
    }

    return {
        init: createMenu,
        setSelected: setSelected,
        isSelected: isSelected,
        toggleSelected: toggleSelected,
        setDisabled: setDisabled,
        setVisible: setVisible,
        addItem: addItem,
        removeItem: removeItem,
        setAction: setAction,
        refreshShortcuts: refreshShortcuts
    }
})();
